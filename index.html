<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VINE CONCURSOS IA - Seu Aliado nos Estudos</title>
    <meta name="description" content="Assistente inteligente para prepara√ß√£o em concursos p√∫blicos com an√°lise de editais, cronogramas, flashcards e muito mais">
    <meta name="theme-color" content="#00d9ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VINE IA">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>

    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151b3d;
            --bg-tertiary: #1e2749;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-warm: #f59e0b;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
            --border: #2d3657;
        }

        body.dark {
            --bg-primary: #0a0e27;
            --bg-secondary: #151b3d;
            --bg-tertiary: #1e2749;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-warm: #f59e0b;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
            --border: #2d3657;
        }

        body.light {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --accent-primary: #0891b2;
            --accent-secondary: #7c3aed;
            --accent-warm: #ea580c;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --success: #059669;
            --danger: #dc2626;
            --border: #e2e8f0;
        }

        body.kindle {
            --bg-primary: #f4ecd8;
            --bg-secondary: #e7dfc6;
            --bg-tertiary: #ddd5bd;
            --accent-primary: #8b6914;
            --accent-secondary: #a0522d;
            --accent-warm: #d2691e;
            --text-primary: #3e2723;
            --text-secondary: #6d4c41;
            --success: #7a8450;
            --danger: #c9302c;
            --border: #c9bc9f;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-primary);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-family: 'Outfit', sans-serif;
        }

        .tab-btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--accent-primary);
        }

        .timer-display {
            font-size: 72px;
            text-align: center;
            margin: 30px 0;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-family: 'Outfit', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-primary);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            transition: border-color 0.2s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .flashcard {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 40px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 30px 0;
            position: relative;
            perspective: 1000px;
        }

        .flashcard:hover {
            border-color: var(--accent-primary);
            transform: scale(1.02);
        }

        .flashcard-content {
            font-size: 24px;
            line-height: 1.6;
        }

        .flashcard-hint {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .flashcard-list {
            display: grid;
            gap: 15px;
        }

        .flashcard-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .flashcard-item-content {
            flex: 1;
        }

        .flashcard-item strong {
            color: var(--accent-primary);
            display: block;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--border);
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .question-card {
            background: var(--bg-tertiary);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--border);
            margin: 20px 0;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options {
            display: grid;
            gap: 12px;
        }

        .option {
            padding: 15px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .option.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .option.correct {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .option.incorrect {
            border-color: var(--danger);
            background: var(--danger);
            color: white;
        }

        .result-message {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .result-success {
            background: var(--success);
            color: white;
        }

        .result-info {
            background: var(--accent-primary);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--accent-primary);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--accent-primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .ai-response {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-primary);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.8;
        }

        .ai-response h3 {
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            color: var(--text-secondary);
        }

        .saved-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .saved-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .saved-item-title {
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 16px;
        }

        .saved-item-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .saved-item-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
            }

            .timer-display {
                font-size: 56px;
            }

            .flashcard-content {
                font-size: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h1 style="margin: 0;">üìö VINE CONCURSOS IA</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="color: var(--text-secondary); font-size: 14px;">Tema:</label>
                    <select id="themeSelector" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">
                        <option value="dark">üåô Escuro</option>
                        <option value="kindle">üìñ Kindle (S√©pia)</option>
                        <option value="light">‚òÄÔ∏è Claro</option>
                    </select>
                </div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="edital">üìã An√°lise de Edital</button>
                <button class="tab-btn" data-tab="cronograma">üìÖ Cronograma</button>
                <button class="tab-btn" data-tab="pomodoro">‚è±Ô∏è Pomodoro</button>
                <button class="tab-btn" data-tab="leitor">üéß Leitor de Texto</button>
                <button class="tab-btn" data-tab="flashcards">üé¥ Flashcards</button>
                <button class="tab-btn" data-tab="simulado">üìù Simulado</button>
                <button class="tab-btn" data-tab="estatisticas">üìä Estat√≠sticas</button>
                <button class="tab-btn" data-tab="ajuda">‚ùì Como Instalar</button>
            </div>
        </header>

        <!-- TAB: DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 25px;">üìä Vis√£o Geral do Seu Progresso</h2>

                <!-- Informa√ß√µes do Edital -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: white; font-size: 20px;">üìã Informa√ß√µes do Edital</h3>
                        <button id="editEditalInfo" onclick="toggleEditarInfoEdital()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                            ‚úèÔ∏è Editar
                        </button>
                    </div>

                    <!-- Display Mode -->
                    <div id="editalInfoDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">Cargo/Concurso</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayCargo">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üìÖ Data da Prova</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayDataProva">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üë• Vagas</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayVagas">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üí∞ Sal√°rio Inicial</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displaySalario">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üè¢ √ìrg√£o</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayOrgao">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üéì Escolaridade</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayEscolaridade">N√£o informado</div>
                        </div>
                    </div>

                    <!-- Edit Mode (Hidden by default) -->
                    <div id="editalInfoEdit" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">Cargo/Concurso</label>
                                <input type="text" id="inputCargo" placeholder="Ex: Analista Judici√°rio - TRT" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üìÖ Data da Prova</label>
                                <input type="date" id="inputDataProva" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üë• Vagas</label>
                                <input type="text" id="inputVagas" placeholder="Ex: 50" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üí∞ Sal√°rio Inicial</label>
                                <input type="text" id="inputSalario" placeholder="Ex: R$ 8.500,00" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üè¢ √ìrg√£o</label>
                                <input type="text" id="inputOrgao" placeholder="Ex: Tribunal Regional do Trabalho" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üéì Escolaridade</label>
                                <input type="text" id="inputEscolaridade" placeholder="Ex: Superior Completo" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                        </div>
                        <button onclick="salvarInfoEdital()" style="margin-top: 20px; padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.2s;">
                            ‚úÖ Salvar Informa√ß√µes
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Total Mat√©rias -->
                    <div style="background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                        <div style="font-size: 36px; margin-bottom: 10px;">üìö</div>
                        <div style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 5px;" id="totalMaterias">0</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">Mat√©rias no Edital</div>
                    </div>

                    <!-- Total T√≥picos -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                        <div style="font-size: 36px; margin-bottom: 10px;">üìã</div>
                        <div style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 5px;" id="totalTopicos">0</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">T√≥picos Totais</div>
                    </div>

                    <!-- T√≥picos Estudados -->
                    <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                        <div style="font-size: 36px; margin-bottom: 10px;">‚úÖ</div>
                        <div style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 5px;" id="topicosEstudados">0</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">T√≥picos Estudados</div>
                    </div>

                    <!-- Progresso % -->
                    <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                        <div style="font-size: 36px; margin-bottom: 10px;">üéØ</div>
                        <div style="font-size: 32px; font-weight: 700; color: white; margin-bottom: 5px;" id="percentualProgresso">0%</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">Progresso Geral</div>
                    </div>

                    <!-- Trof√©u Geral -->
                    <div id="trofeuGeral" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); display: none;">
                        <div style="font-size: 48px; margin-bottom: 10px;" id="trofeuGeralEmoji">üèÜ</div>
                        <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 5px;" id="trofeuGeralNome">Trof√©u</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">Conquista Desbloqueada!</div>
                    </div>
                </div>

                <!-- Countdown Timer -->
                <div id="examCountdown" style="background: var(--bg-tertiary); padding: 25px; border-radius: 16px; text-align: center; margin-bottom: 30px; border: 2px solid var(--border);">
                    <div style="font-size: 18px; color: var(--text-secondary); margin-bottom: 10px;">‚è≥ Tempo at√© a prova:</div>
                    <div style="font-size: 42px; font-weight: 700; color: var(--accent-primary);" id="diasRestantes">--</div>
                    <div style="font-size: 16px; color: var(--text-secondary); margin-top: 10px;">
                        <span id="ritmoEstudo">Defina a data da prova em "An√°lise de Edital"</span>
                    </div>
                </div>

                <!-- Progresso por Mat√©ria -->
                <div id="progressoPorMateria">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">üìà Progresso por Mat√©ria</h3>
                    <div id="materiasProgressList">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            Nenhum conte√∫do program√°tico processado ainda.<br>
                            <a href="#" onclick="switchTab('edital'); return false;" style="color: var(--accent-primary); text-decoration: underline;">V√° para "An√°lise de Edital"</a> e processe o conte√∫do program√°tico.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: AN√ÅLISE DE EDITAL -->
        <div id="edital" class="tab-content">
            <div class="card">
                <h2>Analisar Edital com IA</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Arraste um PDF do edital ou cole o texto diretamente. A IA ir√° analisar e extrair informa√ß√µes importantes.
                </p>

                <!-- PDF Upload Area -->
                <div id="pdfDropArea" style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; margin-bottom: 20px; background: var(--bg-tertiary); cursor: pointer; transition: all 0.3s ease;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                    <p style="color: var(--text-primary); font-weight: 600; margin-bottom: 5px;">Arraste o PDF do edital aqui</p>
                    <p style="color: var(--text-secondary); font-size: 14px;">ou clique para selecionar o arquivo</p>
                    <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
                </div>

                <div style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">
                    <strong>‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ OU ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</strong>
                </div>

                <div class="input-group">
                    <label>Texto do Edital (para an√°lise geral)</label>
                    <textarea id="editalInput" placeholder="Cole o edital completo. A an√°lise extrair√° informa√ß√µes gerais como data da prova, mat√©rias, quantidade de quest√µes, etc." oninput="if(this.value.trim().length > 100) { setTimeout(() => document.getElementById('analyzeEdital').click(), 1000); }"></textarea>
                </div>

                <div class="input-group" style="margin-top: 20px;">
                    <label>üìã Conte√∫do Program√°tico (cole aqui APENAS o conte√∫do das mat√©rias)</label>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        <strong>Formato:</strong> Uma mat√©ria por linha, seguida de seus t√≥picos separados por v√≠rgula ou ponto-e-v√≠rgula.<br>
                        <strong>Exemplo:</strong><br>
                        <code style="background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 5px;">
                        Portugu√™s: Concord√¢ncia verbal, Coes√£o e coer√™ncia, Ortografia oficial<br>
                        Matem√°tica: Juros simples, Juros compostos, Estat√≠stica b√°sica<br>
                        Direito Administrativo: Atos administrativos, Licita√ß√µes, Contratos
                        </code>
                    </p>
                    <textarea id="conteudoProgramatico" placeholder="Portugu√™s: Concord√¢ncia verbal, Coes√£o e coer√™ncia, Ortografia oficial&#10;Matem√°tica: Juros simples, Juros compostos, Estat√≠stica b√°sica&#10;Direito Administrativo: Atos administrativos, Licita√ß√µes, Contratos" style="min-height: 200px;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-secondary" id="processarConteudo" style="flex: 1;">‚úÖ Processar Conte√∫do Program√°tico</button>
                        <button class="btn" onclick="carregarConteudoParaEdicao()" style="flex: 1; background: var(--accent-secondary);">‚úèÔ∏è Carregar para Editar</button>
                        <button class="btn" onclick="limparConteudoProgramatico()" style="background: #dc3545; flex: 1;">üóëÔ∏è Limpar Tudo</button>
                    </div>
                </div>

                <button class="btn" id="analyzeEdital" style="display: none;">ü§ñ Analisar</button>
                <div id="editalOutput" style="margin-top: 20px;"></div>
            </div>

            <div class="card">
                <h2>An√°lises Salvas</h2>
                <div id="savedEditalList"></div>
            </div>
        </div>

        <!-- TAB: CRONOGRAMA -->
        <div id="cronograma" class="tab-content">
            <div class="card">
                <h2>Gerar Cronograma de Estudos com IA</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Preencha as informa√ß√µes abaixo e deixe a IA criar um cronograma personalizado de estudos.
                </p>
                <div class="input-group">
                    <label>Nome do Concurso</label>
                    <input type="text" id="concursoNome" placeholder="Ex: TRT-SP - Analista Judici√°rio">
                </div>
                <div class="input-group">
                    <label>Data da Prova</label>
                    <input type="date" id="dataProva">
                </div>
                <div class="input-group">
                    <label>Horas dispon√≠veis por dia para estudo</label>
                    <input type="number" id="horasDia" value="4" min="1" max="24">
                </div>
                <div class="input-group">
                    <label>Mat√©rias do Edital (uma por linha)</label>
                    <textarea id="materiasEdital" placeholder="Direito Constitucional&#10;Direito Administrativo&#10;Portugu√™s&#10;Racioc√≠nio L√≥gico"></textarea>
                </div>
                <div class="input-group">
                    <label>Seu n√≠vel de conhecimento atual</label>
                    <select id="nivelConhecimento">
                        <option value="iniciante">Iniciante</option>
                        <option value="intermediario">Intermedi√°rio</option>
                        <option value="avancado">Avan√ßado</option>
                    </select>
                </div>
                <button class="btn" id="generateCronograma">ü§ñ Gerar Cronograma com IA</button>
                <div id="cronogramaOutput" style="margin-top: 20px;"></div>
            </div>

            <div class="card">
                <h2>Meus Cronogramas</h2>
                <div id="savedCronogramaList"></div>
            </div>
        </div>

        <!-- TAB: POMODORO -->
        <div id="pomodoro" class="tab-content">
            <div class="card">
                <h2>Timer Pomodoro</h2>
                <div class="timer-display mono" id="timerDisplay">25:00</div>

                <div class="btn-group">
                    <button class="btn" id="startTimer">‚ñ∂Ô∏è Iniciar</button>
                    <button class="btn btn-secondary" id="pauseTimer">‚è∏Ô∏è Pausar</button>
                    <button class="btn btn-secondary" id="resetTimer">üîÑ Resetar</button>
                </div>

                <div class="input-group">
                    <label>Tempo de Foco (minutos)</label>
                    <input type="number" id="focusTime" value="25" min="1" max="60">
                </div>

                <div class="input-group">
                    <label>Tempo de Pausa (minutos)</label>
                    <input type="number" id="breakTime" value="5" min="1" max="30">
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="card">
                <h2>Meta Di√°ria</h2>
                <div class="input-group">
                    <label>Pomodoros hoje: <span class="mono" id="todayPomodoros">0</span> / <span id="goalDisplay">8</span></label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="goalProgress" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Meta di√°ria de Pomodoros</label>
                    <input type="number" id="dailyGoal" value="8" min="1" max="20">
                </div>
            </div>
        </div>

        <!-- TAB: LEITOR DE TEXTO -->
        <div id="leitor" class="tab-content">
            <div class="card">
                <h2>üéß Leitor de Texto (Text-to-Speech)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Converta textos de PDFs ou anota√ß√µes em √°udio para estudar em qualquer lugar. Ajuste a velocidade para otimizar seu tempo de estudo!
                </p>

                <div class="input-group">
                    <label>Texto para Leitura</label>
                    <textarea id="textToRead" placeholder="Cole aqui o texto do PDF, edital ou suas anota√ß√µes..." style="min-height: 200px;"></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn" id="startReading">‚ñ∂Ô∏è Ler Texto</button>
                    <button class="btn btn-secondary" id="pauseReading">‚è∏Ô∏è Pausar</button>
                    <button class="btn btn-secondary" id="stopReading">‚èπÔ∏è Parar</button>
                </div>

                <div class="input-group" style="margin-top: 30px;">
                    <label>Voz:</label>
                    <select id="voiceSelect" style="width: 100%; margin-bottom: 15px;">
                        <option value="">Voz padr√£o do sistema</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>üìñ Dicion√°rio de Pron√∫ncia Personalizado</label>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Ensine a pron√∫ncia correta de palavras. Formato: <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">palavra errada -> palavra correta</code> (uma por linha)
                    </p>
                    <textarea id="pronunciationDict" placeholder="Exemplos:&#10;pomodoro -> pom√¥doro&#10;flashcard -> fl√©chicarde&#10;burnout -> b√©rn√°ute" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-family: 'IBM Plex Mono', monospace; font-size: 13px; resize: vertical;"></textarea>
                </div>

                <div class="input-group">
                    <label>Velocidade de Leitura: <span id="speedLabel" class="mono" style="color: var(--accent-primary);">1.0x</span></label>
                    <input type="range" id="readingSpeed" min="0.5" max="6" step="0.1" value="1" style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; color: var(--text-secondary); font-size: 12px;">
                        <span>0.5x</span>
                        <span>1.5x</span>
                        <span>3.0x</span>
                        <span>4.5x</span>
                        <span>6.0x</span>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 8px; margin-top: 20px; color: white;">
                    <h3 style="margin-bottom: 10px;">üí° Dicas para Otimizar o Estudo</h3>
                    <ul style="line-height: 1.8; margin-left: 20px;">
                        <li><strong>Velocidade 0.5x-0.8x:</strong> Ideal para conte√∫dos dif√≠ceis ou primeira leitura</li>
                        <li><strong>Velocidade 1.0x:</strong> Velocidade normal de conversa√ß√£o</li>
                        <li><strong>Velocidade 1.5x-2.0x:</strong> √ìtimo para revis√µes e economizar tempo</li>
                        <li><strong>Use fones Bluetooth:</strong> Estude enquanto caminha, dirige ou faz exerc√≠cios</li>
                        <li><strong>Divida textos longos:</strong> Processe em partes para melhor absor√ß√£o</li>
                    </ul>
                </div>

                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid var(--accent-warm);">
                    <p style="color: var(--text-secondary); margin: 0;">
                        <strong style="color: var(--accent-warm);">‚ö†Ô∏è Nota:</strong> A s√≠ntese de voz √© processada pelo navegador (offline). A qualidade e as vozes dispon√≠veis dependem do seu sistema operacional e navegador.
                    </p>
                </div>
            </div>
        </div>

        <!-- TAB: FLASHCARDS -->
        <div id="flashcards" class="tab-content">
            <div class="card">
                <h2>Adicionar Flashcard</h2>
                <div class="input-group">
                    <label>Mat√©ria</label>
                    <input type="text" id="flashcardSubject" placeholder="Ex: Direito Constitucional">
                </div>
                <div class="input-group">
                    <label>Pergunta</label>
                    <textarea id="flashcardQuestion" placeholder="Digite a pergunta..."></textarea>
                </div>
                <div class="input-group">
                    <label>Resposta</label>
                    <textarea id="flashcardAnswer" placeholder="Digite a resposta..."></textarea>
                </div>
                <button class="btn" id="addFlashcard">‚ûï Adicionar Flashcard</button>
            </div>

            <div class="card">
                <h2>Revisar Flashcards</h2>
                <div id="flashcardReview"></div>
            </div>

            <div class="card">
                <h2>Meus Flashcards</h2>
                <div id="flashcardList"></div>
            </div>
        </div>

        <!-- TAB: SIMULADO -->
        <div id="simulado" class="tab-content">
            <div class="card">
                <h2>Adicionar Quest√£o</h2>
                <div class="input-group">
                    <label>Mat√©ria</label>
                    <input type="text" id="questionSubject" placeholder="Ex: Portugu√™s">
                </div>
                <div class="input-group">
                    <label>Enunciado</label>
                    <textarea id="questionText" placeholder="Digite o enunciado da quest√£o..."></textarea>
                </div>
                <div class="input-group">
                    <label>Op√ß√£o A</label>
                    <input type="text" id="optionA" placeholder="Op√ß√£o A">
                </div>
                <div class="input-group">
                    <label>Op√ß√£o B</label>
                    <input type="text" id="optionB" placeholder="Op√ß√£o B">
                </div>
                <div class="input-group">
                    <label>Op√ß√£o C</label>
                    <input type="text" id="optionC" placeholder="Op√ß√£o C">
                </div>
                <div class="input-group">
                    <label>Op√ß√£o D</label>
                    <input type="text" id="optionD" placeholder="Op√ß√£o D">
                </div>
                <div class="input-group">
                    <label>Resposta Correta</label>
                    <select id="correctAnswer">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <button class="btn" id="addQuestion">‚ûï Adicionar Quest√£o</button>
            </div>

            <div class="card">
                <h2>Realizar Simulado</h2>
                <div id="simuladoArea"></div>
            </div>
        </div>

        <!-- TAB: ESTAT√çSTICAS -->
        <div id="estatisticas" class="tab-content">
            <div class="card">
                <h2>Suas Estat√≠sticas</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total de Pomodoros</div>
                        <div class="stat-value" id="totalPomodoros">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tempo Total de Estudo</div>
                        <div class="stat-value" id="totalStudyTime">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Flashcards Criados</div>
                        <div class="stat-value" id="totalFlashcards">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Quest√µes Criadas</div>
                        <div class="stat-value" id="totalQuestions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Simulados Realizados</div>
                        <div class="stat-value" id="totalSimulados">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Taxa de Acerto</div>
                        <div class="stat-value" id="accuracyRate">0%</div>
                    </div>
                </div>

                <button class="btn btn-danger" id="clearData" style="margin-top: 20px;">üóëÔ∏è Limpar Todos os Dados</button>
            </div>
        </div>

        <!-- TAB: AJUDA/INSTALA√á√ÉO -->
        <div id="ajuda" class="tab-content">
            <div class="card">
                <h2>üì≤ Como Instalar o App no Celular</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Transforme o VINE CONCURSOS IA em um app nativo! Siga os passos abaixo de acordo com seu dispositivo:
                </p>

                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">ü§ñ Android (Chrome)</h3>
                    <ol style="line-height: 2; color: var(--text-primary);">
                        <li>Abra este site no <strong>Google Chrome</strong></li>
                        <li>Toque no menu <strong>‚ãÆ</strong> (tr√™s pontos) no canto superior direito</li>
                        <li>Selecione <strong>"Adicionar √† tela inicial"</strong> ou <strong>"Instalar app"</strong></li>
                        <li>Confirme tocando em <strong>"Adicionar"</strong></li>
                        <li>‚úÖ Pronto! O √≠cone aparecer√° na sua tela inicial</li>
                    </ol>
                </div>

                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üçé iOS (iPhone/iPad)</h3>
                    <ol style="line-height: 2; color: var(--text-primary);">
                        <li>Abra este site no <strong>Safari</strong></li>
                        <li>Toque no bot√£o <strong>Compartilhar</strong> ‚¨ÜÔ∏è (na barra inferior)</li>
                        <li>Role para baixo e toque em <strong>"Adicionar √† Tela de In√≠cio"</strong></li>
                        <li>Edite o nome se quiser e toque em <strong>"Adicionar"</strong></li>
                        <li>‚úÖ Pronto! O app estar√° dispon√≠vel como qualquer outro</li>
                    </ol>
                </div>

                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 8px; margin: 20px 0; color: white;">
                    <h3 style="margin-bottom: 15px;">‚ú® Vantagens do App Instalado</h3>
                    <ul style="line-height: 2;">
                        <li>üöÄ <strong>Acesso r√°pido</strong> - √çcone na tela inicial</li>
                        <li>üì¥ <strong>Funciona offline</strong> - Use sem internet</li>
                        <li>üíæ <strong>Dados salvos</strong> - Tudo persiste localmente</li>
                        <li>üì± <strong>Tela cheia</strong> - Sem barra do navegador</li>
                        <li>‚ö° <strong>Mais r√°pido</strong> - Carregamento instant√¢neo</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>ü§ñ Recursos com IA</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    As funcionalidades de <strong>An√°lise de Edital</strong> e <strong>Gera√ß√£o de Cronograma</strong> usam Intelig√™ncia Artificial.
                </p>
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                    <h4 style="color: var(--accent-primary); margin-bottom: 10px;">üìã Para usar a IA:</h4>
                    <ol style="line-height: 2; color: var(--text-primary);">
                        <li>Publique este app no <a href="https://poe.com" target="_blank" style="color: var(--accent-primary);">Poe.com</a> (gratuito)</li>
                        <li>A IA funcionar√° automaticamente quando acessado via Poe</li>
                        <li>Ou use as outras funcionalidades offline (Pomodoro, Flashcards, Simulados)</li>
                    </ol>
                </div>
            </div>

            <div class="card">
                <h2>üí° Compartilhar com Amigos</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    Quer compartilhar o VINE CONCURSOS IA com seus colegas de estudos?
                </p>
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                    <p style="line-height: 1.8; color: var(--text-primary); margin-bottom: 15px;">
                        <strong>Op√ß√£o 1:</strong> Hospede gratuitamente em <a href="https://netlify.com/drop" target="_blank" style="color: var(--accent-primary);">Netlify</a> ou <a href="https://vercel.com" target="_blank" style="color: var(--accent-primary);">Vercel</a>
                        <br>Voc√™ ter√° um link permanente para compartilhar: <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px;">https://vine-concursos.netlify.app</code>
                    </p>
                    <p style="line-height: 1.8; color: var(--text-primary);">
                        <strong>Op√ß√£o 2:</strong> Publique no Poe.com como Canvas App
                        <br>Todos que tiverem conta Poe poder√£o usar com IA integrada!
                    </p>
                </div>
            </div>

            <div class="card">
                <h2>‚ÑπÔ∏è Informa√ß√µes do Sistema</h2>
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">Status do PWA</div>
                        <div class="stat-value" id="pwaStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Armazenamento</div>
                        <div class="stat-value" id="storageStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Service Worker</div>
                        <div class="stat-value" id="swStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">API Poe</div>
                        <div class="stat-value" id="poeStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar a√ß√£o</h3>
            <p id="modalMessage">Tem certeza que deseja continuar?</p>
            <div class="btn-group">
                <button class="btn btn-secondary" id="modalCancel">Cancelar</button>
                <button class="btn btn-danger" id="modalConfirm">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Detect color scheme
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.remove('light');
        } else {
            document.documentElement.classList.add('light');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.remove('light');
            } else {
                document.documentElement.classList.add('light');
            }
        });

        // Data Management - Hybrid storage (memory + localStorage when available)
        const memoryStore = {};
        let useLocalStorage = false;

        // Check if localStorage is available
        try {
            const testKey = '__storage_test__';
            window.localStorage.setItem(testKey, 'test');
            window.localStorage.removeItem(testKey);
            useLocalStorage = true;
            console.log('‚úÖ localStorage dispon√≠vel - dados ser√£o persistidos');
        } catch (e) {
            console.log('‚ö†Ô∏è localStorage n√£o dispon√≠vel - usando mem√≥ria tempor√°ria');
        }

        const Storage = {
            get(key, defaultValue = null) {
                if (useLocalStorage) {
                    try {
                        const data = window.localStorage.getItem('vine_' + key);
                        return data ? JSON.parse(data) : defaultValue;
                    } catch (e) {
                        return memoryStore[key] !== undefined ? memoryStore[key] : defaultValue;
                    }
                }
                return memoryStore[key] !== undefined ? memoryStore[key] : defaultValue;
            },
            set(key, value) {
                memoryStore[key] = value;
                if (useLocalStorage) {
                    try {
                        window.localStorage.setItem('vine_' + key, JSON.stringify(value));
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            },
            remove(key) {
                delete memoryStore[key];
                if (useLocalStorage) {
                    try {
                        window.localStorage.removeItem('vine_' + key);
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            },
            clear() {
                Object.keys(memoryStore).forEach(key => delete memoryStore[key]);
                if (useLocalStorage) {
                    try {
                        Object.keys(window.localStorage).forEach(key => {
                            if (key.startsWith('vine_')) {
                                window.localStorage.removeItem(key);
                            }
                        });
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            }
        };

        // Theme Switching
        const themeSelector = document.getElementById('themeSelector');
        const body = document.body;

        // Load saved theme or default to 'dark'
        const savedTheme = Storage.get('theme', 'dark');
        body.className = savedTheme;
        themeSelector.value = savedTheme;

        // Theme change listener
        themeSelector.addEventListener('change', (e) => {
            const theme = e.target.value;
            body.className = theme;
            Storage.set('theme', theme);
            console.log('Tema alterado para:', theme);
        });

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // POMODORO TIMER
        let timerInterval = null;
        let timeLeft = 25 * 60;
        let totalTime = 25 * 60;
        let isBreak = false;
        let pomodorosToday = Storage.get('pomodorosToday', { date: new Date().toDateString(), count: 0 });

        // Reset counter if new day
        if (pomodorosToday.date !== new Date().toDateString()) {
            pomodorosToday = { date: new Date().toDateString(), count: 0 };
            Storage.set('pomodorosToday', pomodorosToday);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const progress = ((totalTime - timeLeft) / totalTime) * 100;
            const progressBar = document.getElementById('sessionProgress');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
        }

        function startTimer() {
            if (timerInterval) return;

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;

                    if (!isBreak) {
                        // Pomodoro completed
                        pomodorosToday.count++;
                        Storage.set('pomodorosToday', pomodorosToday);
                        updatePomodoroStats();

                        // Increment total pomodoros
                        const stats = Storage.get('stats', {});
                        stats.totalPomodoros = (stats.totalPomodoros || 0) + 1;
                        stats.totalStudyTime = (stats.totalStudyTime || 0) + parseInt(document.getElementById('focusTime').value);
                        Storage.set('stats', stats);

                        showNotification('‚úÖ Pomodoro conclu√≠do! Hora de uma pausa.');

                        // Switch to break
                        isBreak = true;
                        const breakMinutes = parseInt(document.getElementById('breakTime').value);
                        timeLeft = breakMinutes * 60;
                        totalTime = breakMinutes * 60;
                    } else {
                        showNotification('üéØ Pausa conclu√≠da! Pronto para mais um Pomodoro?');
                        isBreak = false;
                        resetTimer();
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resetTimer() {
            pauseTimer();
            isBreak = false;
            const focusMinutes = parseInt(document.getElementById('focusTime').value);
            timeLeft = focusMinutes * 60;
            totalTime = focusMinutes * 60;
            updateTimerDisplay();
        }

        function updatePomodoroStats() {
            const goal = parseInt(document.getElementById('dailyGoal').value);
            document.getElementById('todayPomodoros').textContent = pomodorosToday.count;
            document.getElementById('goalDisplay').textContent = goal;

            const progress = Math.min((pomodorosToday.count / goal) * 100, 100);
            const progressBar = document.getElementById('goalProgress');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'result-message result-success';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '2000';
            notification.style.maxWidth = '500px';
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        document.getElementById('startTimer').addEventListener('click', startTimer);
        document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
        document.getElementById('resetTimer').addEventListener('click', resetTimer);
        document.getElementById('focusTime').addEventListener('change', resetTimer);
        document.getElementById('breakTime').addEventListener('change', () => {
            if (isBreak) {
                const breakMinutes = parseInt(document.getElementById('breakTime').value);
                timeLeft = breakMinutes * 60;
                totalTime = breakMinutes * 60;
                updateTimerDisplay();
            }
        });
        document.getElementById('dailyGoal').addEventListener('change', updatePomodoroStats);

        updateTimerDisplay();
        updatePomodoroStats();

        // TEXT READER (TTS)
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isPaused = false;
        let availableVoices = [];

        // GLOBAL: Store extracted topics from edital analysis
        let extractedEditalTopics = {}; // Format: { "Portugu√™s": ["topic1", "topic2"], "Matem√°tica": ["topic3", "topic4"] }

        // Load available voices
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">Voz padr√£o do sistema</option>';

            // Filter Portuguese voices first, then all voices
            const ptVoices = availableVoices.filter(voice => voice.lang.startsWith('pt'));
            const otherVoices = availableVoices.filter(voice => !voice.lang.startsWith('pt'));

            if (ptVoices.length > 0) {
                const ptGroup = document.createElement('optgroup');
                ptGroup.label = 'üáßüá∑ Vozes em Portugu√™s';
                ptVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    ptGroup.appendChild(option);
                });
                voiceSelect.appendChild(ptGroup);
            }

            if (otherVoices.length > 0) {
                const otherGroup = document.createElement('optgroup');
                otherGroup.label = 'üåç Outras vozes';
                otherVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    otherGroup.appendChild(option);
                });
                voiceSelect.appendChild(otherGroup);
            }
        }

        // Load voices on page load and when voices change
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        // Function to apply pronunciation dictionary
        function applyPronunciationDict(text) {
            const dictText = document.getElementById('pronunciationDict').value.trim();
            if (!dictText) return text;

            let processedText = text;
            const lines = dictText.split('\n');

            lines.forEach(line => {
                const match = line.match(/(.+?)\s*->\s*(.+)/);
                if (match) {
                    const wrong = match[1].trim();
                    const correct = match[2].trim();
                    // Replace all occurrences (case insensitive)
                    const regex = new RegExp(wrong, 'gi');
                    processedText = processedText.replace(regex, correct);
                }
            });

            return processedText;
        }

        document.getElementById('startReading').addEventListener('click', () => {
            let text = document.getElementById('textToRead').value.trim();

            if (!text) {
                showNotification('‚ö†Ô∏è Digite ou cole um texto primeiro!');
                return;
            }

            // If paused, resume
            if (isPaused && speechSynthesis.paused) {
                speechSynthesis.resume();
                isPaused = false;
                showNotification('‚ñ∂Ô∏è Leitura retomada');
                return;
            }

            // If already speaking, resume
            if (speechSynthesis.speaking) {
                speechSynthesis.resume();
                return;
            }

            // Apply pronunciation dictionary
            text = applyPronunciationDict(text);

            // Create new utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = parseFloat(document.getElementById('readingSpeed').value);

            // Set selected voice
            const selectedVoiceName = document.getElementById('voiceSelect').value;
            if (selectedVoiceName) {
                const selectedVoice = availableVoices.find(voice => voice.name === selectedVoiceName);
                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                }
            }

            currentUtterance.onstart = () => {
                showNotification('üéß Iniciando leitura...');
            };

            currentUtterance.onend = () => {
                showNotification('‚úÖ Leitura conclu√≠da!');
                isPaused = false;
            };

            currentUtterance.onerror = (event) => {
                showNotification('‚ùå Erro na leitura: ' + event.error);
                isPaused = false;
            };

            speechSynthesis.speak(currentUtterance);
        });

        document.getElementById('pauseReading').addEventListener('click', () => {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                speechSynthesis.pause();
                isPaused = true;
                showNotification('‚è∏Ô∏è Leitura pausada');
            }
        });

        document.getElementById('stopReading').addEventListener('click', () => {
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel();
                isPaused = false;
                showNotification('‚èπÔ∏è Leitura interrompida');
            }
        });

        document.getElementById('readingSpeed').addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            document.getElementById('speedLabel').textContent = speed.toFixed(1) + 'x';

            // Update speed in real-time if speaking
            if (currentUtterance && speechSynthesis.speaking) {
                // Need to restart with new speed
                const text = document.getElementById('textToRead').value.trim();
                const wasPaused = speechSynthesis.paused;

                speechSynthesis.cancel();
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = 'pt-BR';
                currentUtterance.rate = speed;

                if (!wasPaused) {
                    speechSynthesis.speak(currentUtterance);
                }
            }
        });

        // FLASHCARDS
        let flashcards = Storage.get('flashcards', []);
        let currentFlashcardIndex = 0;
        let showingAnswer = false;

        function addFlashcard() {
            const subject = document.getElementById('flashcardSubject').value.trim();
            const question = document.getElementById('flashcardQuestion').value.trim();
            const answer = document.getElementById('flashcardAnswer').value.trim();

            if (!subject || !question || !answer) {
                showNotification('‚ö†Ô∏è Preencha todos os campos do flashcard');
                return;
            }

            flashcards.push({ subject, question, answer, id: Date.now() });
            Storage.set('flashcards', flashcards);

            document.getElementById('flashcardSubject').value = '';
            document.getElementById('flashcardQuestion').value = '';
            document.getElementById('flashcardAnswer').value = '';

            renderFlashcards();
            showNotification('‚úÖ Flashcard adicionado com sucesso!');
        }

        function renderFlashcards() {
            const listEl = document.getElementById('flashcardList');

            if (flashcards.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìö</div><p>Nenhum flashcard criado ainda.<br>Adicione seu primeiro flashcard acima!</p></div>';
                document.getElementById('flashcardReview').innerHTML = '<div class="empty-state"><p>Adicione flashcards para come√ßar a revisar</p></div>';
                return;
            }

            listEl.innerHTML = '<div class="flashcard-list">' + flashcards.map((fc, idx) => `
                <div class="flashcard-item">
                    <div class="flashcard-item-content">
                        <strong>${fc.subject}</strong>
                        <div>${fc.question}</div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteFlashcard(${idx})">üóëÔ∏è</button>
                </div>
            `).join('') + '</div>';

            renderFlashcardReview();
        }

        function renderFlashcardReview() {
            const reviewEl = document.getElementById('flashcardReview');

            if (flashcards.length === 0) {
                reviewEl.innerHTML = '<div class="empty-state"><p>Adicione flashcards para come√ßar a revisar</p></div>';
                return;
            }

            const fc = flashcards[currentFlashcardIndex];

            reviewEl.innerHTML = `
                <div class="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-content">
                        ${showingAnswer ? fc.answer : fc.question}
                    </div>
                    <div class="flashcard-hint">
                        ${showingAnswer ? '(Resposta)' : 'Clique para revelar a resposta'}
                    </div>
                </div>
                <div style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;">
                    <strong>${fc.subject}</strong> - Flashcard ${currentFlashcardIndex + 1} de ${flashcards.length}
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="previousFlashcard()">‚¨ÖÔ∏è Anterior</button>
                    <button class="btn" onclick="nextFlashcard()">Pr√≥ximo ‚û°Ô∏è</button>
                </div>
            `;
        }

        function flipFlashcard() {
            showingAnswer = !showingAnswer;
            renderFlashcardReview();
        }

        function nextFlashcard() {
            showingAnswer = false;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcards.length;
            renderFlashcardReview();
        }

        function previousFlashcard() {
            showingAnswer = false;
            currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcards.length) % flashcards.length;
            renderFlashcardReview();
        }

        function deleteFlashcard(index) {
            showConfirmDialog('Tem certeza que deseja excluir este flashcard?', () => {
                flashcards.splice(index, 1);
                Storage.set('flashcards', flashcards);
                if (currentFlashcardIndex >= flashcards.length) {
                    currentFlashcardIndex = Math.max(0, flashcards.length - 1);
                }
                renderFlashcards();
                showNotification('üóëÔ∏è Flashcard exclu√≠do');
            });
        }

        document.getElementById('addFlashcard').addEventListener('click', addFlashcard);
        renderFlashcards();

        // SIMULADO
        let questions = Storage.get('questions', []);
        let currentSimulado = null;
        let simuladoAnswers = [];

        function addQuestion() {
            const subject = document.getElementById('questionSubject').value.trim();
            const text = document.getElementById('questionText').value.trim();
            const optionA = document.getElementById('optionA').value.trim();
            const optionB = document.getElementById('optionB').value.trim();
            const optionC = document.getElementById('optionC').value.trim();
            const optionD = document.getElementById('optionD').value.trim();
            const correct = document.getElementById('correctAnswer').value;

            if (!subject || !text || !optionA || !optionB || !optionC || !optionD) {
                showNotification('‚ö†Ô∏è Preencha todos os campos da quest√£o');
                return;
            }

            questions.push({
                id: Date.now(),
                subject,
                text,
                options: { A: optionA, B: optionB, C: optionC, D: optionD },
                correct
            });

            Storage.set('questions', questions);

            document.getElementById('questionSubject').value = '';
            document.getElementById('questionText').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';

            showNotification('‚úÖ Quest√£o adicionada com sucesso!');
            renderSimulado();
        }

        function startSimulado() {
            if (questions.length === 0) {
                showNotification('‚ö†Ô∏è Adicione quest√µes antes de iniciar um simulado');
                return;
            }

            currentSimulado = [...questions].sort(() => Math.random() - 0.5);
            simuladoAnswers = new Array(currentSimulado.length).fill(null);
            renderSimulado();
        }

        function renderSimulado() {
            const simuladoEl = document.getElementById('simuladoArea');

            if (!currentSimulado) {
                if (questions.length === 0) {
                    simuladoEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Nenhuma quest√£o cadastrada.<br>Adicione quest√µes acima para criar um simulado!</p></div>';
                } else {
                    simuladoEl.innerHTML = `
                        <div style="text-align: center;">
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                                ${questions.length} quest√£o(√µes) dispon√≠vel(is)
                            </p>
                            <button class="btn" onclick="startSimulado()">üöÄ Iniciar Simulado</button>
                        </div>
                    `;
                }
                return;
            }

            let html = '';
            currentSimulado.forEach((q, idx) => {
                html += `
                    <div class="question-card" id="question-${idx}">
                        <div style="color: var(--accent-secondary); font-weight: 600; margin-bottom: 10px;">
                            ${q.subject} - Quest√£o ${idx + 1}
                        </div>
                        <div class="question-text">${q.text}</div>
                        <div class="options">
                            ${['A', 'B', 'C', 'D'].map(opt => `
                                <div class="option" onclick="selectOption(${idx}, '${opt}')" id="q${idx}-${opt}">
                                    <strong>${opt})</strong> ${q.options[opt]}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += '<div class="btn-group"><button class="btn" onclick="finishSimulado()">‚úÖ Finalizar Simulado</button></div>';
            simuladoEl.innerHTML = html;
        }

        function selectOption(questionIdx, option) {
            simuladoAnswers[questionIdx] = option;

            ['A', 'B', 'C', 'D'].forEach(opt => {
                const el = document.getElementById(`q${questionIdx}-${opt}`);
                el.classList.remove('selected');
            });

            document.getElementById(`q${questionIdx}-${option}`).classList.add('selected');
        }

        function finishSimulado() {
            const unanswered = simuladoAnswers.filter(a => a === null).length;

            if (unanswered > 0) {
                showConfirmDialog(
                    `Voc√™ deixou ${unanswered} quest√£o(√µes) sem resposta. Deseja finalizar mesmo assim?`,
                    () => gradeSimulado()
                );
            } else {
                gradeSimulado();
            }
        }

        function gradeSimulado() {
            let correct = 0;

            currentSimulado.forEach((q, idx) => {
                const userAnswer = simuladoAnswers[idx];
                const isCorrect = userAnswer === q.correct;

                if (isCorrect) correct++;

                ['A', 'B', 'C', 'D'].forEach(opt => {
                    const el = document.getElementById(`q${idx}-${opt}`);
                    el.classList.remove('selected');
                    el.style.pointerEvents = 'none';

                    if (opt === q.correct) {
                        el.classList.add('correct');
                    } else if (opt === userAnswer && !isCorrect) {
                        el.classList.add('incorrect');
                    }
                });
            });

            const percentage = Math.round((correct / currentSimulado.length) * 100);

            // Update stats
            const stats = Storage.get('stats', {});
            stats.totalSimulados = (stats.totalSimulados || 0) + 1;
            stats.totalCorrect = (stats.totalCorrect || 0) + correct;
            stats.totalAnswered = (stats.totalAnswered || 0) + currentSimulado.length;
            Storage.set('stats', stats);
            updateStats();

            const resultMessage = document.createElement('div');
            resultMessage.className = 'result-message result-success';
            resultMessage.innerHTML = `
                <strong>Simulado Finalizado!</strong><br>
                Voc√™ acertou ${correct} de ${currentSimulado.length} quest√µes (${percentage}%)
            `;

            document.getElementById('simuladoArea').insertBefore(
                resultMessage,
                document.getElementById('simuladoArea').firstChild
            );

            setTimeout(() => {
                resultMessage.innerHTML += '<br><button class="btn btn-secondary" onclick="resetSimulado()" style="margin-top: 15px;">üîÑ Novo Simulado</button>';
            }, 1000);
        }

        function resetSimulado() {
            currentSimulado = null;
            simuladoAnswers = [];
            renderSimulado();
        }

        document.getElementById('addQuestion').addEventListener('click', addQuestion);
        renderSimulado();

        // STATISTICS
        function updateStats() {
            const stats = Storage.get('stats', {});

            document.getElementById('totalPomodoros').textContent = stats.totalPomodoros || 0;
            document.getElementById('totalStudyTime').textContent =
                Math.round((stats.totalStudyTime || 0) / 60) + 'h';
            document.getElementById('totalFlashcards').textContent = flashcards.length;
            document.getElementById('totalQuestions').textContent = questions.length;
            document.getElementById('totalSimulados').textContent = stats.totalSimulados || 0;

            const accuracy = stats.totalAnswered > 0
                ? Math.round((stats.totalCorrect / stats.totalAnswered) * 100)
                : 0;
            document.getElementById('accuracyRate').textContent = accuracy + '%';
        }

        updateStats();

        // CLEAR DATA
        document.getElementById('clearData').addEventListener('click', () => {
            showConfirmDialog(
                'Tem certeza que deseja apagar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!',
                () => {
                    Storage.clear();
                    location.reload();
                }
            );
        });

        // MODAL SYSTEM
        let confirmCallback = null;

        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalMessage').textContent = message;
            modal.classList.add('active');
            confirmCallback = onConfirm;
        }

        document.getElementById('modalCancel').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        });

        document.getElementById('modalConfirm').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        });

        // Close modal on background click
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                document.getElementById('confirmModal').classList.remove('active');
                confirmCallback = null;
            }
        });

        // AN√ÅLISE DE EDITAL COM IA
        let savedEditais = Storage.get('savedEditais', []);

        // Register handlers for Poe Embed API
        if (window.Poe) {
            window.Poe.registerHandler("edital-handler", (result) => {
                const msg = result.responses[0];
                const outputEl = document.getElementById('editalOutput');

                if (msg.status === "error") {
                    outputEl.innerHTML = `<div class="result-message" style="background: var(--danger); color: white;">Erro: ${msg.statusText}</div>`;
                } else if (msg.status === "incomplete") {
                    outputEl.innerHTML = `<div class="loading-message"><div class="loading-spinner"></div> Analisando edital...</div><div class="ai-response">${msg.content}</div>`;
                } else if (msg.status === "complete") {
                    outputEl.innerHTML = `<div class="ai-response">${msg.content}</div>`;

                    // Save the analysis
                    savedEditais.push({
                        id: Date.now(),
                        date: new Date().toLocaleString('pt-BR'),
                        input: document.getElementById('editalInput').value.substring(0, 200) + '...',
                        response: msg.content
                    });
                    Storage.set('savedEditais', savedEditais);
                    renderSavedEditais();
                }
            });

            window.Poe.registerHandler("cronograma-handler", (result) => {
                const msg = result.responses[0];
                const outputEl = document.getElementById('cronogramaOutput');

                if (msg.status === "error") {
                    outputEl.innerHTML = `<div class="result-message" style="background: var(--danger); color: white;">Erro: ${msg.statusText}</div>`;
                } else if (msg.status === "incomplete") {
                    outputEl.innerHTML = `<div class="loading-message"><div class="loading-spinner"></div> Gerando cronograma personalizado...</div><div class="ai-response">${msg.content}</div>`;
                } else if (msg.status === "complete") {
                    outputEl.innerHTML = `<div class="ai-response">${msg.content}</div>`;

                    // Save the cronograma
                    const savedCronogramas = Storage.get('savedCronogramas', []);
                    savedCronogramas.push({
                        id: Date.now(),
                        date: new Date().toLocaleString('pt-BR'),
                        concurso: document.getElementById('concursoNome').value,
                        response: msg.content
                    });
                    Storage.set('savedCronogramas', savedCronogramas);
                    renderSavedCronogramas();
                }
            });
        }

        async function analyzeEdital() {
            const input = document.getElementById('editalInput').value.trim();

            if (!input) {
                showNotification('‚ö†Ô∏è Digite o texto do edital ou fa√ßa uma pergunta');
                return;
            }

            const outputEl = document.getElementById('editalOutput');
            outputEl.innerHTML = `<div class="loading-message"><div class="loading-spinner"></div> Analisando edital...</div>`;

            // Try Poe API first
            if (window.Poe) {
                const prompt = `Voc√™ √© um especialista em an√°lise de editais de concursos p√∫blicos. Analise o seguinte texto/pergunta e forne√ßa informa√ß√µes claras e organizadas:

${input}

Por favor, organize sua resposta de forma clara, destacando:
- Disciplinas e conte√∫dos program√°ticos
- Pesos e n√∫mero de quest√µes (se mencionado)
- Datas importantes
- Requisitos e informa√ß√µes relevantes
- Dicas de estudo baseadas no edital`;

                try {
                    await window.Poe.sendUserMessage(`@Claude-Sonnet-4.5 ${prompt}`, {
                        handler: "edital-handler",
                        stream: true,
                        openChat: false
                    });
                    return;
                } catch (err) {
                    console.log('Poe API n√£o dispon√≠vel, usando an√°lise offline');
                }
            }

            // Fallback: Offline intelligent analysis
            setTimeout(() => {
                try {
                    console.log('Iniciando an√°lise offline...');
                    const analysis = analyzeEditalOffline(input);
                    console.log('An√°lise b√°sica conclu√≠da');

                    // Extract data for additional features
                    const foundSubjects = [];
                    const commonSubjects = [
                        'Portugu√™s', 'L√≠ngua Portuguesa', 'Reda√ß√£o',
                        'Matem√°tica', 'Matem√°tica Financeira',
                        'Racioc√≠nio L√≥gico', 'L√≥gica',
                        'Inform√°tica', 'No√ß√µes de Inform√°tica',
                        'Direito Constitucional', 'Constitucional',
                        'Direito Administrativo', 'Administrativo',
                        'Direito Penal', 'Penal',
                        'Direito Processual Penal', 'Processual Penal',
                        'Direito Civil', 'Civil',
                        'Direito do Trabalho', 'Trabalho',
                        'Direito Tribut√°rio', 'Tribut√°rio',
                        'Direito Previdenci√°rio', 'Previdenci√°rio',
                        'Contabilidade', 'Contabilidade Geral',
                        'Administra√ß√£o', 'Administra√ß√£o P√∫blica',
                        'Economia', 'Atualidades', 'Conhecimentos Gerais',
                        'Legisla√ß√£o', 'Estat√≠stica', '√âtica'
                    ];

                    commonSubjects.forEach(subject => {
                        const regex = new RegExp(subject, 'gi');
                        const matches = input.match(regex);
                        if (matches && matches.length > 0 && !foundSubjects.includes(subject)) {
                            foundSubjects.push(subject);
                        }
                    });

                    console.log('Disciplinas encontradas:', foundSubjects);

                    // Calculate days until exam
                    let daysUntilExam = null;
                    const provaRegex = /prova[^\n]{0,50}(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi;
                    const provaMatch = input.match(provaRegex);
                    if (provaMatch) {
                        const dateStr = provaMatch[0].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                        if (dateStr) {
                            const parts = dateStr[0].split(/[\/\-]/);
                            const examDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            daysUntilExam = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
                        }
                    }

                    console.log('Dias at√© a prova:', daysUntilExam);

                    // Generate all sections with error handling
                    let verticalizedSyllabus = '';
                    let cyclicSchedule = '';
                    let subjectSummary = '';

                    try {
                        console.log('Gerando edital verticalizado...');
                        verticalizedSyllabus = foundSubjects.length > 0 ? generateVerticalizedSyllabus(input, foundSubjects) : '';
                        console.log('‚úÖ Edital verticalizado OK');
                    } catch (e) {
                        console.error('Erro no edital verticalizado:', e);
                        verticalizedSyllabus = '<p style="color: var(--danger);">Erro ao gerar edital verticalizado</p>';
                    }

                    try {
                        console.log('Gerando cronograma c√≠clico...');
                        cyclicSchedule = foundSubjects.length > 0 ? generateCyclicSchedule(input, foundSubjects, daysUntilExam) : '';
                        console.log('‚úÖ Cronograma c√≠clico OK');
                    } catch (e) {
                        console.error('Erro no cronograma c√≠clico:', e);
                        cyclicSchedule = '<p style="color: var(--danger);">Erro ao gerar cronograma</p>';
                    }

                    try {
                        console.log('Gerando resumo dos assuntos...');
                        subjectSummary = foundSubjects.length > 0 ? generateSubjectSummary(input, foundSubjects) : '';
                        console.log('‚úÖ Resumo dos assuntos OK');
                    } catch (e) {
                        console.error('Erro no resumo:', e);
                        subjectSummary = '<p style="color: var(--danger);">Erro ao gerar resumo</p>';
                    }

                    console.log('Montando HTML final...');

                    outputEl.innerHTML = `
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary);">
                                        Velocidade da Leitura: <span id="analysisSpeedLabel" class="mono" style="color: var(--accent-primary);">1.0x</span>
                                    </label>
                                    <input type="range" id="analysisSpeed" min="0.5" max="4" step="0.1" value="1"
                                        style="width: 100%;"
                                        oninput="document.getElementById('analysisSpeedLabel').textContent = parseFloat(this.value).toFixed(1) + 'x'">
                                    <div style="display: flex; justify-content: space-between; margin-top: 5px; color: var(--text-secondary); font-size: 12px;">
                                        <span>0.5x</span>
                                        <span>1.5x</span>
                                        <span>2.5x</span>
                                        <span>4.0x</span>
                                    </div>
                                </div>
                                <button class="btn" onclick="ouvirAnalise()" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span id="ouvirIcon">üéß</span> <span id="ouvirText">Ouvir An√°lise</span>
                                </button>
                            </div>
                        </div>
                        <div class="ai-response" id="analysisContent">
                            ${analysis}
                            ${verticalizedSyllabus}
                            ${cyclicSchedule}
                            ${subjectSummary}
                        </div>
                    `;

                    console.log('HTML inserido com sucesso!');

                    // Save the analysis
                    const fullAnalysis = analysis + verticalizedSyllabus + cyclicSchedule + subjectSummary;
                    savedEditais.push({
                        id: Date.now(),
                        date: new Date().toLocaleString('pt-BR'),
                        input: input.substring(0, 200) + '...',
                        response: fullAnalysis
                    });
                    Storage.set('savedEditais', savedEditais);
                    renderSavedEditais();

                    showNotification('‚úÖ An√°lise conclu√≠da com sucesso!');
                    console.log('An√°lise completa finalizada!');

                } catch (error) {
                    console.error('ERRO na an√°lise:', error);
                    outputEl.innerHTML = `
                        <div class="result-message" style="background: var(--danger); color: white;">
                            ‚ùå Erro ao processar an√°lise: ${error.message}
                            <br><br>
                            <small>Verifique o console (F12) para mais detalhes.</small>
                        </div>
                    `;
                }
            }, 800);
        }

        function analyzeEditalOffline(text) {
            let html = '<h3>üìã An√°lise do Edital</h3>';

            // Extract disciplines
            const commonSubjects = [
                'Portugu√™s', 'L√≠ngua Portuguesa', 'Reda√ß√£o',
                'Matem√°tica', 'Matem√°tica Financeira',
                'Racioc√≠nio L√≥gico', 'L√≥gica',
                'Inform√°tica', 'No√ß√µes de Inform√°tica',
                'Direito Constitucional', 'Constitucional',
                'Direito Administrativo', 'Administrativo',
                'Direito Penal', 'Penal',
                'Direito Processual Penal', 'Processual Penal',
                'Direito Civil', 'Civil',
                'Direito do Trabalho', 'Trabalho',
                'Direito Tribut√°rio', 'Tribut√°rio',
                'Direito Previdenci√°rio', 'Previdenci√°rio',
                'Contabilidade', 'Contabilidade Geral',
                'Administra√ß√£o', 'Administra√ß√£o P√∫blica',
                'Economia', 'Atualidades', 'Conhecimentos Gerais',
                'Legisla√ß√£o', 'Estat√≠stica', '√âtica'
            ];

            const foundSubjects = [];
            const subjectDetails = {};

            commonSubjects.forEach(subject => {
                const regex = new RegExp(subject, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const normalized = subject;
                    if (!foundSubjects.includes(normalized)) {
                        foundSubjects.push(normalized);

                        // Try to find question count or weight
                        const contextRegex = new RegExp(`${subject}[^\\n]{0,100}(\\d+)\\s*(quest√µes|quest√£o|pontos|pts)`, 'gi');
                        const context = text.match(contextRegex);
                        if (context) {
                            subjectDetails[normalized] = context[0];
                        }
                    }
                }
            });

            if (foundSubjects.length > 0) {
                html += '<h4>üìö Disciplinas Identificadas:</h4><ul>';
                foundSubjects.forEach(subject => {
                    html += `<li><strong>${subject}</strong>`;
                    if (subjectDetails[subject]) {
                        html += ` - ${subjectDetails[subject]}`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
            }

            // Extract dates with context
            const dateRegex = /([^\n.!?]*?)(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})([^\n.!?]*?)[\n.!?]/gi;
            const dateMatches = text.matchAll(dateRegex);
            const datesWithContext = [];

            for (const match of dateMatches) {
                const before = match[1].trim();
                const date = match[2];
                const after = match[3].trim();

                // Build context - get text before or after the date
                let context = '';

                // Common keywords for events
                const eventKeywords = [
                    'inscri√ß√£o', 'inscri√ß√µes', 'prova', 'exame', 'resultado',
                    'publica√ß√£o', 'divulga√ß√£o', 'prazo', 'entrega', 'recurso',
                    'edital', 'convoca√ß√£o', 'posse', 'nomea√ß√£o', 'homologa√ß√£o'
                ];

                // Check before and after for event keywords
                const fullContext = (before + ' ' + after).toLowerCase();
                let foundEvent = false;

                for (const keyword of eventKeywords) {
                    if (fullContext.includes(keyword)) {
                        // Extract a meaningful phrase
                        const words = (before + ' ' + after).split(/\s+/);
                        const relevantWords = words.slice(Math.max(0, words.length - 8), words.length);
                        context = relevantWords.join(' ').replace(/[:\-,;]/g, '').trim();
                        foundEvent = true;
                        break;
                    }
                }

                if (!foundEvent) {
                    // If no keyword found, use the text before the date
                    const words = before.split(/\s+/);
                    context = words.slice(Math.max(0, words.length - 6)).join(' ').replace(/[:\-,;]/g, '').trim();
                }

                // Clean up context
                if (context.length > 60) {
                    context = context.substring(Math.max(0, context.length - 60));
                }

                datesWithContext.push({ date, context });
            }

            if (datesWithContext.length > 0) {
                html += '<h4>üìÖ Datas Importantes:</h4><ul>';

                // Remove duplicates
                const uniqueDates = [];
                const seenDates = new Set();

                datesWithContext.forEach(item => {
                    if (!seenDates.has(item.date)) {
                        seenDates.add(item.date);
                        uniqueDates.push(item);
                    }
                });

                uniqueDates.forEach(item => {
                    if (item.context && item.context.length > 2) {
                        html += `<li><strong>${item.date}</strong> - ${item.context}</li>`;
                    } else {
                        html += `<li><strong>${item.date}</strong></li>`;
                    }
                });
                html += '</ul>';
            }

            // Extract numbers (quest√µes, vagas, etc)
            const vagasRegex = /(\d+)\s*vagas?/gi;
            const vagas = text.match(vagasRegex);
            if (vagas) {
                html += '<h4>üë• Vagas:</h4><ul>';
                vagas.forEach(v => html += `<li>${v}</li>`);
                html += '</ul>';
            }

            const questoesRegex = /(\d+)\s*quest√µes?/gi;
            const questoes = text.match(questoesRegex);
            if (questoes) {
                html += '<h4>üìù Quest√µes:</h4><ul>';
                questoes.forEach(q => html += `<li>${q}</li>`);
                html += '</ul>';
            }

            // Intelligent Recommendations based on extracted data
            html += '<h4>üí° Recomenda√ß√µes Personalizadas de Estudo:</h4>';

            // Extract question counts per subject
            const subjectWeights = [];
            foundSubjects.forEach(subject => {
                const regex = new RegExp(`${subject}[^\\n]{0,100}(\\d+)\\s*quest√µes?`, 'gi');
                const match = text.match(regex);
                if (match) {
                    const numberMatch = match[0].match(/(\d+)/);
                    if (numberMatch) {
                        subjectWeights.push({
                            subject: subject,
                            questions: parseInt(numberMatch[1])
                        });
                    }
                }
            });

            // Sort by weight (most questions first)
            subjectWeights.sort((a, b) => b.questions - a.questions);

            // Calculate total questions
            const totalQuestions = subjectWeights.reduce((sum, item) => sum + item.questions, 0);

            // Calculate days until exam
            let daysUntilExam = null;
            const provaRegex = /prova[^\\n]{0,50}(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi;
            const provaMatch = text.match(provaRegex);
            if (provaMatch) {
                const dateStr = provaMatch[0].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                if (dateStr) {
                    const parts = dateStr[0].split(/[\/\-]/);
                    const examDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    daysUntilExam = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
                }
            }

            html += '<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';

            // Priority subjects based on weight
            if (subjectWeights.length > 0) {
                html += '<p style="margin-bottom: 10px;"><strong>üìä Prioriza√ß√£o por Peso:</strong></p><ul>';

                subjectWeights.slice(0, 5).forEach((item, idx) => {
                    const percentage = ((item.questions / totalQuestions) * 100).toFixed(1);
                    let priority = '';
                    let emoji = '';

                    if (percentage >= 20) {
                        priority = 'PRIORIDADE M√ÅXIMA';
                        emoji = 'üî•';
                    } else if (percentage >= 15) {
                        priority = 'Alta prioridade';
                        emoji = '‚ö°';
                    } else if (percentage >= 10) {
                        priority = 'Prioridade m√©dia';
                        emoji = 'üìå';
                    } else {
                        priority = 'Prioridade normal';
                        emoji = 'üìù';
                    }

                    html += `<li>${emoji} <strong>${item.subject}:</strong> ${item.questions} quest√µes (${percentage}%) - <span style="color: var(--accent-primary);">${priority}</span></li>`;
                });
                html += '</ul>';

                // Study time recommendation
                html += '<p style="margin-top: 15px;"><strong>‚è∞ Distribui√ß√£o de Tempo Sugerida:</strong></p><ul>';
                subjectWeights.slice(0, 3).forEach(item => {
                    const percentage = ((item.questions / totalQuestions) * 100).toFixed(0);
                    html += `<li><strong>${item.subject}:</strong> ~${percentage}% do seu tempo de estudo</li>`;
                });
                html += '</ul>';
            }

            html += '</div>';

            // Time-based strategy
            if (daysUntilExam !== null) {
                html += '<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
                html += '<p><strong>üìÖ Estrat√©gia baseada no tempo:</strong></p><ul>';

                if (daysUntilExam < 0) {
                    html += '<li>‚ö†Ô∏è A data da prova j√° passou ou est√° incorreta no edital</li>';
                } else if (daysUntilExam <= 30) {
                    html += '<li>üö® <strong>ATEN√á√ÉO: Menos de 30 dias!</strong> Modo INTENSIVO ativado</li>';
                    html += '<li>üéØ Foque nas mat√©rias de maior peso (top 3)</li>';
                    html += '<li>üìù Fa√ßa SIMULADOS semanais obrigat√≥rios</li>';
                    html += '<li>‚è±Ô∏è Estude no m√≠nimo 4-6h por dia</li>';
                    html += '<li>üîÑ √öltimos 7 dias: apenas revis√£o e simulados</li>';
                } else if (daysUntilExam <= 60) {
                    html += `<li>‚ö° Voc√™ tem ${daysUntilExam} dias - Tempo moderado</li>`;
                    html += '<li>üìö Cubra todas as mat√©rias em ciclos completos</li>';
                    html += '<li>üìä 1 simulado a cada 2 semanas</li>';
                    html += '<li>üé¥ Use flashcards para memoriza√ß√£o</li>';
                    html += '<li>‚è∞ Estude 3-5h por dia consistentemente</li>';
                } else if (daysUntilExam <= 120) {
                    html += `<li>üìÖ Voc√™ tem ${daysUntilExam} dias - Tempo bom para prepara√ß√£o</li>`;
                    html += '<li>üìñ Estudo aprofundado de teoria + quest√µes</li>';
                    html += '<li>üîÑ Fa√ßa 2-3 ciclos completos de todas as mat√©rias</li>';
                    html += '<li>üìù Simulado mensal para acompanhar evolu√ß√£o</li>';
                    html += '<li>‚è±Ô∏è 2-4h por dia √© suficiente se for consistente</li>';
                } else {
                    html += `<li>‚úÖ Voc√™ tem ${daysUntilExam} dias - Tempo excelente!</li>`;
                    html += '<li>üìö Aproveite para estudar com profundidade</li>';
                    html += '<li>üéØ Desenvolva base s√≥lida em cada mat√©ria</li>';
                    html += '<li>üìä Acompanhe estat√≠sticas e ajuste estrat√©gia</li>';
                    html += '<li>‚è∞ 2-3h por dia com qualidade √© ideal</li>';
                }

                html += '</ul></div>';
            }

            // Subject-specific tips
            html += '<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px;">';
            html += '<p><strong>üìö Dicas por Disciplina:</strong></p><ul>';

            const subjectTips = {
                'Direito Constitucional': 'üéØ Foque em: Direitos Fundamentais, Organiza√ß√£o do Estado, Controle de Constitucionalidade',
                'Constitucional': 'üéØ Foque em: Direitos Fundamentais, Organiza√ß√£o do Estado, Controle de Constitucionalidade',
                'Direito Administrativo': 'üèõÔ∏è Priorize: Atos Administrativos, Licita√ß√µes (Lei 14.133/21), Servidores P√∫blicos',
                'Administrativo': 'üèõÔ∏è Priorize: Atos Administrativos, Licita√ß√µes (Lei 14.133/21), Servidores P√∫blicos',
                'Portugu√™s': 'üìñ Essencial: Interpreta√ß√£o de Texto (40%), Gram√°tica (40%), Reda√ß√£o Oficial (20%)',
                'L√≠ngua Portuguesa': 'üìñ Essencial: Interpreta√ß√£o de Texto (40%), Gram√°tica (40%), Reda√ß√£o Oficial (20%)',
                'Racioc√≠nio L√≥gico': 'üßÆ Mat√©ria de TREINO! Fa√ßa 20+ quest√µes por dia, todo dia',
                'L√≥gica': 'üßÆ Mat√©ria de TREINO! Fa√ßa 20+ quest√µes por dia, todo dia',
                'Matem√°tica': 'üî¢ Pratique diariamente! Foque em: Porcentagem, Regra de 3, Equa√ß√µes',
                'Inform√°tica': 'üíª Estude: Windows/Linux, Office (Excel √© campe√£o), Redes e Seguran√ßa',
                'Direito Penal': '‚öñÔ∏è Parte Geral √© 60% das quest√µes! Domine antes da Parte Especial',
                'Direito Civil': 'üìú Base: Parte Geral, Obriga√ß√µes, Contratos (s√£o as mais cobradas)',
                'Contabilidade': 'üìä Fa√ßa exerc√≠cios pr√°ticos! Teoria sozinha n√£o basta',
            };

            foundSubjects.forEach(subject => {
                if (subjectTips[subject]) {
                    html += `<li>${subjectTips[subject]}</li>`;
                }
            });

            html += '<li>‚è∞ <strong>T√©cnica Pomodoro:</strong> Use a aba Pomodoro para manter foco e produtividade</li>';
            html += '<li>üìä <strong>Simulados regulares:</strong> Me√ßa seu progresso e identifique pontos fracos</li>';
            html += '<li>üé¥ <strong>Flashcards:</strong> Perfeito para leis, conceitos e jurisprud√™ncia</li>';
            html += '<li>üéß <strong>Use √°udio:</strong> Transforme PDFs em √°udio e estude em movimento</li>';

            html += '</ul></div>';

            return html;
        }

        // Extract detailed topics from syllabus - SMART EXTRACTION (only from content section)
        function extractTopics(text, subject) {
            const topics = [];

            // STEP 1: Find the CONTENT SECTION (programa, conte√∫do program√°tico, etc.)
            const contentSectionPatterns = [
                /CONTE[U√ö]DO\s+PROGRAM[A√Å]TICO/i,
                /PROGRAMA\s+(?:DO\s+)?EDITAL/i,
                /PROGRAMA\s+(?:DE\s+)?(?:PROVAS?|CONHECIMENTOS?)/i,
                /CONHECIMENTOS?\s+(?:ESPEC[I√ç]FICOS?|GERAIS?)/i,
                /DISCIPLINAS?/i
            ];

            let contentStart = -1;
            let contentEnd = text.length;

            // Find where content section starts
            for (const pattern of contentSectionPatterns) {
                const match = text.search(pattern);
                if (match !== -1 && (contentStart === -1 || match < contentStart)) {
                    contentStart = match;
                }
            }

            // If no content section found, use full text
            if (contentStart === -1) {
                contentStart = 0;
                console.log('‚ö†Ô∏è Se√ß√£o de conte√∫do program√°tico n√£o encontrada. Usando texto completo.');
            } else {
                console.log(`‚úÖ Se√ß√£o de conte√∫do program√°tico encontrada em posi√ß√£o ${contentStart}`);
            }

            // STEP 2: Find where content section ENDS (before irrelevant sections)
            const stopSectionPatterns = [
                /ATRIBUI[√áC][O√ï]ES\s+DO\s+CARGO/i,
                /REQUISITOS?\s+(?:PARA|DO)/i,
                /INSCRI[√áC][O√ï]ES/i,
                /DAS\s+INSCRI[√áC][O√ï]ES/i,
                /SOBRE\s+O\s+CONCURSO/i,
                /INFORMA[√áC][O√ï]ES\s+GERAIS/i,
                /RESERVA\s+DE\s+VAGAS/i,
                /CRONOGRAMA/i
            ];

            for (const pattern of stopSectionPatterns) {
                const match = text.substring(contentStart).search(pattern);
                if (match !== -1) {
                    const absolutePos = contentStart + match;
                    if (absolutePos < contentEnd) {
                        contentEnd = absolutePos;
                        console.log(`‚ö†Ô∏è Encontrou se√ß√£o irrelevante em ${absolutePos}. Parando extra√ß√£o.`);
                    }
                }
            }

            // Extract only from content section
            const contentSection = text.substring(contentStart, contentEnd);

            // STEP 3: Find the specific subject within the content section
            const subjectIndex = contentSection.toLowerCase().indexOf(subject.toLowerCase());
            let content = '';

            if (subjectIndex !== -1) {
                // Get everything after the subject name, but only up to 2000 chars OR next subject
                const afterSubject = contentSection.substring(subjectIndex + subject.length);

                // Try to find where next subject starts (all caps or numbered section)
                const nextSubjectPattern = /\n\s*(?:[A-Z√Ä-√ö][A-Z√Ä-√ö\s]{5,}|(?:\d+\s+QUEST[O√ï]ES|QUEST[O√ï]ES))/;
                const nextSubjectMatch = afterSubject.search(nextSubjectPattern);

                if (nextSubjectMatch !== -1 && nextSubjectMatch < 2000) {
                    content = afterSubject.substring(0, nextSubjectMatch);
                    console.log(`‚úÖ Encontrou pr√≥xima se√ß√£o em ${nextSubjectMatch} chars. Limitando extra√ß√£o.`);
                } else {
                    content = afterSubject.substring(0, 2000);
                }

                console.log(`‚úÖ Encontrou "${subject}" no conte√∫do program√°tico.`);
            } else {
                console.log(`‚ùå N√£o encontrou "${subject}" na se√ß√£o de conte√∫do program√°tico.`);
                return topics;
            }

            if (content) {
                console.log(`üìù Processando ${content.length} caracteres para "${subject}"...`);

                // ESTRAT√âGIA 1: N√∫meros (1., 1.1., 1.1.1., etc.)
                const numberedRegex = /(\d+(?:\.\d+)*)\.\s*([^\n]+)/gi;
                let matches = [...content.matchAll(numberedRegex)];
                matches.forEach(m => {
                    const topic = m[2].trim();
                    if (topic.length > 3 && topic.length < 400) {
                        const clean = topic.replace(/[:\-;,]+$/, '').trim();
                        if (!topics.includes(clean)) topics.push(clean);
                    }
                });

                // ESTRAT√âGIA 2: Letras (a), b), c), etc.)
                const letterRegex = /([a-z])\)\s*([^\n]+)/gi;
                matches = [...content.matchAll(letterRegex)];
                matches.forEach(m => {
                    const topic = m[2].trim();
                    if (topic.length > 3 && topic.length < 400) {
                        const clean = topic.replace(/[:\-;,]+$/, '').trim();
                        if (!topics.includes(clean)) topics.push(clean);
                    }
                });

                // ESTRAT√âGIA 3: Bullets (-, ‚Ä¢, *, etc.)
                const bulletRegex = /[-‚Ä¢\*]\s*([^\n]+)/gi;
                matches = [...content.matchAll(bulletRegex)];
                matches.forEach(m => {
                    const topic = m[1].trim();
                    if (topic.length > 3 && topic.length < 400) {
                        const clean = topic.replace(/[:\-;,]+$/, '').trim();
                        if (!topics.includes(clean)) topics.push(clean);
                    }
                });

                // ESTRAT√âGIA 4: TODAS AS LINHAS (muito agressivo!)
                if (topics.length < 3) {
                    console.log('‚ö†Ô∏è Poucos t√≥picos encontrados. Usando extra√ß√£o linha por linha...');
                    const lines = content.split(/[\n\r]+/);
                    lines.forEach(line => {
                        const trimmed = line.trim();
                        // Aceita quase tudo que n√£o seja obviamente ruim
                        if (trimmed.length > 8 && trimmed.length < 500 &&
                            !trimmed.match(/^\d+\s*quest√µes?/i) &&
                            !trimmed.match(/^p√°g/i) &&
                            !trimmed.match(/^\s*$/)) {
                            // Limpa n√∫meros iniciais
                            let clean = trimmed.replace(/^[\d.\-\s)a-z]+/, '').trim();
                            clean = clean.replace(/[:\-;,]+$/, '').trim();
                            if (clean.length > 5 && !topics.includes(clean)) {
                                topics.push(clean);
                            }
                        }
                    });
                }

                // ESTRAT√âGIA 5: Split por pontos, v√≠rgulas, ponto-e-v√≠rgula
                if (topics.length < 3) {
                    console.log('‚ö†Ô∏è √öLTIMA tentativa: split por pontua√ß√£o...');
                    const parts = content.split(/[.;,]+/);
                    parts.forEach(part => {
                        const trimmed = part.trim();
                        if (trimmed.length > 10 && trimmed.length < 300) {
                            if (!topics.includes(trimmed)) topics.push(trimmed);
                        }
                    });
                }

                console.log(`‚úÖ ${topics.length} t√≥picos extra√≠dos para "${subject}"`);
            } else {
                console.log(`‚ùå Nenhum conte√∫do encontrado para ${subject}`);
            }

            if (topics.length > 0) {
                console.log(`‚úÖ SUCESSO! ${topics.length} t√≥picos para "${subject}":`, topics.slice(0, 5));
            } else {
                console.log(`‚ùå FALHA! Nenhum t√≥pico extra√≠do para "${subject}"`);
            }
            return topics.slice(0, 50); // Limit to 50 topics per subject
        }

        // Generate verticalized syllabus
        function generateVerticalizedSyllabus(text, foundSubjects) {
            // RESET GLOBAL TOPICS
            extractedEditalTopics = {};

            let html = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
            html += '<h3 style="color: var(--accent-primary); margin-bottom: 20px;">üìã Edital Verticalizado</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">Conte√∫do reorganizado por disciplina para facilitar seus estudos</p>';

            foundSubjects.forEach((subject, idx) => {
                const topics = extractTopics(text, subject);

                // SAVE TO GLOBAL for use in cronograma
                extractedEditalTopics[subject] = topics.length > 0 ? topics : [];

                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-primary);">`;

                if (topics.length > 0) {
                    // FORMATO INLINE: Mat√©ria: t√≥pico1, t√≥pico2, t√≥pico3, etc.
                    html += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${subject}:</strong> `;
                    html += topics.join(', ');
                    html += '.</p>';
                } else {
                    html += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${subject}:</strong> `;
                    html += '<span style="color: var(--text-secondary); font-style: italic;">T√≥picos n√£o especificados no edital. Consulte bibliografia recomendada.</span></p>';
                }

                html += '</div>';
            });

            html += '<div style="margin-top: 20px; padding: 15px; background: var(--bg-elevated); border-radius: 8px;">';
            html += '<p style="margin: 0;"><strong>üí° Dica:</strong> Salve este edital verticalizado e use como checklist durante seus estudos. Marque cada t√≥pico conforme for dominando!</p>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        // Generate cyclic weekly study schedule with specific topics
        function generateCyclicSchedule(text, foundSubjects, daysUntilExam) {
            let html = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
            html += '<h3 style="color: var(--accent-primary); margin-bottom: 20px;">üîÑ Cronograma C√≠clico Semanal</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">Estude todas as mat√©rias e t√≥picos em ciclos semanais completos</p>';

            // Extract topics for each subject
            const subjectsWithTopics = [];
            foundSubjects.forEach(subject => {
                const topics = extractTopics(text, subject);
                if (topics.length > 0) {
                    subjectsWithTopics.push({
                        subject: subject,
                        topics: topics
                    });
                } else {
                    subjectsWithTopics.push({
                        subject: subject,
                        topics: ['Todos os t√≥picos do edital']
                    });
                }
            });

            const numSubjects = subjectsWithTopics.length;
            const numCycles = daysUntilExam ? Math.floor(daysUntilExam / 7) : 4;
            const cyclesToShow = Math.min(numCycles, 4);

            const days = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];

            // Calculate how many subjects per day (aim for 2-3 subjects per day)
            const studyDaysPerWeek = 6;
            const subjectsPerDay = Math.max(2, Math.ceil(numSubjects / studyDaysPerWeek));

            for (let cycle = 1; cycle <= cyclesToShow; cycle++) {
                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
                html += `<h4 style="color: var(--accent-secondary); margin-bottom: 15px;">üìÖ Ciclo ${cycle} - Semana ${cycle}</h4>`;

                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: var(--bg-elevated);">';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Dia</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Disciplinas e T√≥picos</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid var(--border);">M√©todo</th>';
                html += '</tr></thead><tbody>';

                days.forEach((day, dayIdx) => {
                    html += '<tr style="border: 1px solid var(--border); vertical-align: top;">';
                    html += `<td style="padding: 10px; font-weight: 600;">${day}</td>`;

                    if (dayIdx === 6) { // Sunday
                        html += '<td style="padding: 10px;"><strong style="color: var(--accent-warm);">REVIS√ÉO GERAL</strong><ul style="margin: 5px 0 0 20px; line-height: 1.6;">';
                        subjectsWithTopics.forEach(item => {
                            html += `<li><strong>${item.subject}:</strong> Revisar anota√ß√µes e resolver quest√µes</li>`;
                        });
                        html += '</ul></td>';
                        html += '<td style="padding: 10px;">üìä <strong>Simulado completo</strong><br>Me√ßa seu desempenho</td>';
                    } else {
                        // Distribute subjects across the week
                        const startIdx = (dayIdx * subjectsPerDay) % numSubjects;
                        const todaySubjectsData = [];

                        for (let i = 0; i < subjectsPerDay && todaySubjectsData.length < 3; i++) {
                            const idx = (startIdx + i + (cycle - 1) * subjectsPerDay) % numSubjects;
                            todaySubjectsData.push(subjectsWithTopics[idx]);
                        }

                        if (todaySubjectsData.length > 0) {
                            html += '<td style="padding: 10px;"><ul style="margin: 0; padding: 0; list-style: none; line-height: 1.8;">';

                            todaySubjectsData.forEach(item => {
                                const topicsToShow = item.topics.slice(0, 3); // Max 3 topics per subject per day
                                const startTopicIdx = ((cycle - 1) * 3) % item.topics.length;
                                const rotatedTopics = [
                                    item.topics[startTopicIdx % item.topics.length],
                                    item.topics[(startTopicIdx + 1) % item.topics.length],
                                    item.topics[(startTopicIdx + 2) % item.topics.length]
                                ].filter(t => t !== undefined);

                                html += `<li style="margin-bottom: 10px;"><strong style="color: var(--accent-primary);">${item.subject}:</strong><ul style="margin: 5px 0 0 20px; font-size: 14px; color: var(--text-secondary);">`;

                                rotatedTopics.forEach(topic => {
                                    html += `<li>${topic}</li>`;
                                });

                                html += '</ul></li>';
                            });

                            html += '</ul></td>';

                            // Activity based on cycle
                            if (cycle === 1) {
                                html += '<td style="padding: 10px;">üìñ <strong>Teoria</strong><br>Leitura de lei seca e doutrina</td>';
                            } else if (cycle === 2) {
                                html += '<td style="padding: 10px;">üìù <strong>Teoria + Quest√µes</strong><br>Quest√µes comentadas</td>';
                            } else if (cycle === 3) {
                                html += '<td style="padding: 10px;">üéØ <strong>Quest√µes</strong><br>Foco em treino e erros</td>';
                            } else {
                                html += '<td style="padding: 10px;">üîÑ <strong>Revis√£o</strong><br>Mapas mentais + quest√µes</td>';
                            }
                        } else {
                            html += '<td style="padding: 10px; color: var(--text-secondary);">Descanso</td>';
                            html += '<td style="padding: 10px;">üí§ Dia livre</td>';
                        }
                    }

                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            }

            html += '<div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 15px; border-radius: 8px; color: white;">';
            html += '<h4 style="margin-bottom: 10px;">‚ú® Como usar o Cronograma C√≠clico:</h4>';
            html += '<ul style="margin-left: 20px; line-height: 1.8;">';
            html += '<li><strong>Ciclo 1:</strong> Foco em TEORIA e leitura de lei seca</li>';
            html += '<li><strong>Ciclo 2:</strong> TEORIA + quest√µes comentadas (entender o racioc√≠nio)</li>';
            html += '<li><strong>Ciclo 3:</strong> QUEST√ïES em volume + revisar erros</li>';
            html += '<li><strong>Ciclo 4+:</strong> REVIS√ÉO intensiva + quest√µes de fixa√ß√£o</li>';
            html += '<li><strong>Domingos:</strong> SEMPRE fazer simulado completo para medir evolu√ß√£o</li>';
            html += '</ul>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        // Generate subject summary
        function generateSubjectSummary(text, foundSubjects) {
            let html = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
            html += '<h3 style="color: var(--accent-primary); margin-bottom: 20px;">üìù Resumo dos Assuntos</h3>';

            const summaryTips = {
                'Direito Constitucional': {
                    emoji: 'üéØ',
                    principais: ['Direitos Fundamentais (arts. 5¬∫ ao 17)', 'Organiza√ß√£o do Estado (arts. 18 a 43)', 'Administra√ß√£o P√∫blica (arts. 37 a 43)', 'Controle de Constitucionalidade', 'Poder Legislativo, Executivo e Judici√°rio'],
                    estrategia: 'Leia a CF/88 diariamente! Foque nos artigos mais cobrados (5¬∫, 37, 84, 102, 103)'
                },
                'Constitucional': {
                    emoji: 'üéØ',
                    principais: ['Direitos Fundamentais', 'Organiza√ß√£o do Estado', 'Administra√ß√£o P√∫blica', 'Controle de Constitucionalidade', 'Poderes da Rep√∫blica'],
                    estrategia: 'Leia a CF/88 diariamente! Foque nos artigos mais cobrados'
                },
                'Direito Administrativo': {
                    emoji: 'üèõÔ∏è',
                    principais: ['Princ√≠pios da Administra√ß√£o P√∫blica', 'Atos Administrativos', 'Licita√ß√µes (Lei 14.133/21)', 'Contratos Administrativos', 'Servidores P√∫blicos (Lei 8.112/90)', 'Responsabilidade Civil do Estado', 'Improbidade Administrativa (Lei 8.429/92)'],
                    estrategia: 'Domine a Lei 14.133/21 (nova lei de licita√ß√µes) e Lei 8.112/90. S√£o as mais cobradas!'
                },
                'Administrativo': {
                    emoji: 'üèõÔ∏è',
                    principais: ['Princ√≠pios', 'Atos Administrativos', 'Licita√ß√µes', 'Contratos', 'Servidores P√∫blicos', 'Responsabilidade Civil'],
                    estrategia: 'Domine Lei 14.133/21 e Lei 8.112/90'
                },
                'Portugu√™s': {
                    emoji: 'üìñ',
                    principais: ['Interpreta√ß√£o e Compreens√£o de Textos', 'Ortografia e Acentua√ß√£o', 'Classes Gramaticais', 'Sintaxe (Concord√¢ncia, Reg√™ncia, Crase)', 'Pontua√ß√£o', 'Reda√ß√£o Oficial'],
                    estrategia: 'Leia MUITO! Jornais, editoriais, textos oficiais. Fa√ßa quest√µes diariamente.'
                },
                'L√≠ngua Portuguesa': {
                    emoji: 'üìñ',
                    principais: ['Interpreta√ß√£o de Textos', 'Ortografia', 'Classes Gramaticais', 'Sintaxe', 'Pontua√ß√£o', 'Reda√ß√£o Oficial'],
                    estrategia: 'Leia muito e fa√ßa quest√µes diariamente'
                },
                'Racioc√≠nio L√≥gico': {
                    emoji: 'üßÆ',
                    principais: ['L√≥gica Proposicional (V ou F)', 'Equival√™ncias L√≥gicas', 'Diagramas L√≥gicos (Venn)', 'L√≥gica de Argumenta√ß√£o', 'Sequ√™ncias e Padr√µes', 'An√°lise Combinat√≥ria', 'Probabilidade'],
                    estrategia: 'PRATIQUE! Fa√ßa no m√≠nimo 20 quest√µes por dia. √â mat√©ria de treino, n√£o de teoria.'
                },
                'L√≥gica': {
                    emoji: 'üßÆ',
                    principais: ['L√≥gica Proposicional', 'Equival√™ncias', 'Diagramas', 'Argumenta√ß√£o', 'Sequ√™ncias'],
                    estrategia: 'Fa√ßa 20+ quest√µes por dia. Mat√©ria de treino!'
                },
                'Inform√°tica': {
                    emoji: 'üíª',
                    principais: ['Windows 10/11', 'Linux (Ubuntu)', 'Microsoft Office (Word, Excel, PowerPoint)', 'LibreOffice', 'Navegadores e Internet', 'Seguran√ßa da Informa√ß√£o', 'Redes de Computadores', 'Conceitos de Cloud'],
                    estrategia: 'Excel √© CAMPE√ÉO de quest√µes! Domine f√≥rmulas, fun√ß√µes e formata√ß√£o.'
                },
                'Matem√°tica': {
                    emoji: 'üî¢',
                    principais: ['Porcentagem', 'Regra de 3 Simples e Composta', 'Equa√ß√µes do 1¬∫ e 2¬∫ grau', 'Juros Simples e Compostos', 'Raz√£o e Propor√ß√£o', 'Geometria B√°sica'],
                    estrategia: 'Fa√ßa exerc√≠cios todos os dias! Matem√°tica √© pr√°tica constante.'
                }
            };

            foundSubjects.forEach((subject, idx) => {
                const summary = summaryTips[subject];

                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;

                if (summary) {
                    html += `<h4 style="color: var(--accent-primary); margin-bottom: 10px;">${summary.emoji} ${subject}</h4>`;
                    html += '<p style="margin-bottom: 10px;"><strong>Principais T√≥picos:</strong></p>';
                    html += '<ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">';
                    summary.principais.forEach(topic => {
                        html += `<li>${topic}</li>`;
                    });
                    html += '</ul>';
                    html += `<div style="background: var(--bg-elevated); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent-warm);">`;
                    html += `<p style="margin: 0;"><strong>üí° Estrat√©gia:</strong> ${summary.estrategia}</p>`;
                    html += '</div>';
                } else {
                    html += `<h4 style="color: var(--accent-primary); margin-bottom: 10px;">üìö ${subject}</h4>`;
                    const topics = extractTopics(text, subject);
                    if (topics.length > 0) {
                        html += '<ul style="margin-left: 20px; line-height: 1.8;">';
                        topics.slice(0, 10).forEach(topic => {
                            html += `<li>${topic}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p style="color: var(--text-secondary);">Consulte o edital para t√≥picos espec√≠ficos</p>';
                    }
                }

                html += '</div>';
            });

            html += '</div>';
            return html;
        }

        // PDF Upload and Processing
        let currentAnalysisUtterance = null;
        let isReadingAnalysis = false;

        const pdfDropArea = document.getElementById('pdfDropArea');
        const pdfFileInput = document.getElementById('pdfFileInput');

        // Click to select file
        pdfDropArea.addEventListener('click', () => {
            pdfFileInput.click();
        });

        // Drag and drop handlers
        pdfDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfDropArea.style.borderColor = 'var(--accent-primary)';
            pdfDropArea.style.background = 'var(--bg-secondary)';
        });

        pdfDropArea.addEventListener('dragleave', () => {
            pdfDropArea.style.borderColor = 'var(--border)';
            pdfDropArea.style.background = 'var(--bg-tertiary)';
        });

        pdfDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfDropArea.style.borderColor = 'var(--border)';
            pdfDropArea.style.background = 'var(--bg-tertiary)';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handlePDFFile(files[0]);
            }
        });

        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePDFFile(e.target.files[0]);
            }
        });

        async function handlePDFFile(file) {
            if (!file.type.includes('pdf')) {
                showNotification('‚ö†Ô∏è Por favor, selecione um arquivo PDF');
                return;
            }

            showNotification('üìÑ Processando PDF...');

            try {
                const arrayBuffer = await file.arrayBuffer();

                if (typeof pdfjsLib === 'undefined') {
                    // Fallback if PDF.js not loaded
                    showNotification('‚ö†Ô∏è Biblioteca PDF n√£o dispon√≠vel. Por favor, cole o texto manualmente.');
                    return;
                }

                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                // Extract text from all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                // Put extracted text in textarea
                document.getElementById('editalInput').value = fullText;
                showNotification(`‚úÖ PDF processado! ${pdf.numPages} p√°gina(s) extra√≠da(s).`);

                // Auto-analyze
                setTimeout(() => {
                    document.getElementById('analyzeEdital').click();
                }, 500);

            } catch (error) {
                console.error('Erro ao processar PDF:', error);
                showNotification('‚ùå Erro ao processar PDF. Tente colar o texto manualmente.');
            }
        }

        // Function to read analysis aloud
        window.ouvirAnalise = function() {
            const content = document.getElementById('analysisContent');
            if (!content) return;

            const iconEl = document.getElementById('ouvirIcon');
            const textEl = document.getElementById('ouvirText');

            // If already reading, stop
            if (isReadingAnalysis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                isReadingAnalysis = false;
                iconEl.textContent = 'üéß';
                textEl.textContent = 'Ouvir An√°lise';
                return;
            }

            // Get clean text from HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textToRead = tempDiv.innerText || tempDiv.textContent;

            if (!textToRead.trim()) {
                showNotification('‚ö†Ô∏è Nenhum conte√∫do para ler');
                return;
            }

            // Get selected speed
            const speedInput = document.getElementById('analysisSpeed');
            const speed = speedInput ? parseFloat(speedInput.value) : 1.0;

            currentAnalysisUtterance = new SpeechSynthesisUtterance(textToRead);
            currentAnalysisUtterance.lang = 'pt-BR';
            currentAnalysisUtterance.rate = speed;

            currentAnalysisUtterance.onstart = () => {
                isReadingAnalysis = true;
                iconEl.textContent = '‚è∏Ô∏è';
                textEl.textContent = 'Parar Leitura';
            };

            currentAnalysisUtterance.onend = () => {
                isReadingAnalysis = false;
                iconEl.textContent = 'üéß';
                textEl.textContent = 'Ouvir An√°lise';
                showNotification('‚úÖ Leitura conclu√≠da!');
            };

            currentAnalysisUtterance.onerror = () => {
                isReadingAnalysis = false;
                iconEl.textContent = 'üéß';
                textEl.textContent = 'Ouvir An√°lise';
            };

            speechSynthesis.speak(currentAnalysisUtterance);
        };

        async function generateCronograma() {
            const concurso = document.getElementById('concursoNome').value.trim();
            const dataProva = document.getElementById('dataProva').value;
            const horasDia = document.getElementById('horasDia').value;
            const materias = document.getElementById('materiasEdital').value.trim();
            const nivel = document.getElementById('nivelConhecimento').value;

            if (!concurso || !dataProva || !materias) {
                showNotification('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios');
                return;
            }

            const outputEl = document.getElementById('cronogramaOutput');
            outputEl.innerHTML = `<div class="loading-message"><div class="loading-spinner"></div> Gerando cronograma personalizado...</div>`;

            const hoje = new Date().toLocaleDateString('pt-BR');
            const diasRestantes = Math.ceil((new Date(dataProva) - new Date()) / (1000 * 60 * 60 * 24));

            // Try Poe API first
            if (window.Poe) {
                const prompt = `Voc√™ √© um especialista em prepara√ß√£o para concursos p√∫blicos. Crie um cronograma de estudos DETALHADO e PERSONALIZADO com as seguintes informa√ß√µes:

üìã CONCURSO: ${concurso}
üìÖ DATA DA PROVA: ${dataProva} (${diasRestantes} dias restantes a partir de ${hoje})
‚è∞ HORAS DISPON√çVEIS POR DIA: ${horasDia} horas
üìö N√çVEL: ${nivel}

MAT√âRIAS DO EDITAL:
${materias}

Por favor, crie um cronograma que inclua:
1. Divis√£o semanal de estudos
2. Distribui√ß√£o equilibrada das mat√©rias
3. Per√≠odos de revis√£o
4. Simulados programados
5. Dicas espec√≠ficas para cada fase de prepara√ß√£o
6. Estrat√©gias de acordo com o n√≠vel de conhecimento (${nivel})

Organize o cronograma de forma clara, usando formata√ß√£o markdown para melhor visualiza√ß√£o.`;

                try {
                    await window.Poe.sendUserMessage(`@Claude-Sonnet-4.5 ${prompt}`, {
                        handler: "cronograma-handler",
                        stream: true,
                        openChat: false
                    });
                    return;
                } catch (err) {
                    console.log('Poe API n√£o dispon√≠vel, usando gerador offline');
                }
            }

            // Fallback: Offline intelligent chronogram generator
            setTimeout(() => {
                const cronograma = generateCronogramaOffline(concurso, dataProva, horasDia, materias, nivel, diasRestantes);
                outputEl.innerHTML = `<div class="ai-response">${cronograma}</div>`;

                // Save the cronograma
                const savedCronogramas = Storage.get('savedCronogramas', []);
                savedCronogramas.push({
                    id: Date.now(),
                    date: new Date().toLocaleString('pt-BR'),
                    concurso: concurso,
                    response: cronograma
                });
                Storage.set('savedCronogramas', savedCronogramas);
                renderSavedCronogramas();
            }, 1000);
        }

        function generateCronogramaOffline(concurso, dataProva, horasDia, materias, nivel, diasRestantes) {
            const materiasArray = materias.split('\n').filter(m => m.trim());
            const numMaterias = materiasArray.length;

            // IMPORTANTE: Terminar 1 semana ANTES da prova (√∫ltima semana = s√≥ revis√£o)
            const diasParaEstudar = Math.max(7, diasRestantes - 7);
            const ultimaSemanaRevisao = diasRestantes > 7;

            let html = `<h3>üìÖ Cronograma Personalizado - ${concurso}</h3>`;

            // Summary
            html += `<div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 8px; margin: 20px 0; color: white;">`;
            html += `<h4 style="margin-bottom: 10px;">üìä Resumo do Plano</h4>`;
            html += `<p><strong>üéØ Concurso:</strong> ${concurso}</p>`;
            html += `<p><strong>üìÖ Data da Prova:</strong> ${new Date(dataProva).toLocaleDateString('pt-BR')}</p>`;
            html += `<p><strong>‚è∞ Dias restantes:</strong> ${diasRestantes} dias</p>`;
            html += `<p><strong>üìö Dias de estudo:</strong> ${diasParaEstudar} dias (√∫ltima semana = revis√£o intensiva)</p>`;
            html += `<p><strong>‚è±Ô∏è Horas por dia:</strong> ${horasDia}h</p>`;
            html += `<p><strong>üìö Total de mat√©rias:</strong> ${numMaterias}</p>`;
            html += `<p><strong>üí™ N√≠vel:</strong> ${nivel.charAt(0).toUpperCase() + nivel.slice(1)}</p>`;
            html += `</div>`;

            // Calculate distribution (usando diasParaEstudar, N√ÉO diasRestantes)
            const totalHoras = diasParaEstudar * horasDia;
            const semanas = Math.floor(diasParaEstudar / 7);

            html += `<h4>üéØ Estrat√©gia de Estudo</h4>`;
            html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;

            if (diasRestantes < 30) {
                html += `<p><strong>‚ö° MODO INTENSIVO:</strong> Menos de 30 dias para a prova!</p>`;
                html += `<ul>`;
                html += `<li>Foque nas mat√©rias de maior peso</li>`;
                html += `<li>Fa√ßa no m√≠nimo 1 simulado por semana</li>`;
                html += `<li>Revise diariamente o que estudou</li>`;
                html += `<li>√öltimos 7 dias: apenas revis√£o e simulados</li>`;
                html += `</ul>`;
            } else if (diasRestantes < 90) {
                html += `<p><strong>üéØ MODO FOCADO:</strong> Tempo moderado para prepara√ß√£o</p>`;
                html += `<ul>`;
                html += `<li>Ciclo completo de todas as mat√©rias</li>`;
                html += `<li>1 simulado a cada 2 semanas</li>`;
                html += `<li>√öltimos 30 dias: foco em revis√£o</li>`;
                html += `<li>Use flashcards para memoriza√ß√£o</li>`;
                html += `</ul>`;
            } else {
                html += `<p><strong>üìö MODO COMPLETO:</strong> Tempo ideal para prepara√ß√£o profunda</p>`;
                html += `<ul>`;
                html += `<li>Estudo aprofundado de teoria</li>`;
                html += `<li>M√∫ltiplos ciclos de revis√£o</li>`;
                html += `<li>Simulados mensais</li>`;
                html += `<li>Tempo para corre√ß√£o de defici√™ncias</li>`;
                html += `</ul>`;
            }
            html += `</div>`;

            // Weekly distribution WITH TOPICS
            html += `<h4>üìÜ Distribui√ß√£o Semanal com Assuntos Espec√≠ficos (${semanas} semanas)</h4>`;
            html += `<p style="color: var(--text-secondary); margin-bottom: 15px;">Cada dia com t√≥picos espec√≠ficos do edital para garantir cobertura completa</p>`;

            const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];

            // Extract topics for each subject - USE GLOBAL EXTRACTED TOPICS FROM EDITAL!
            const materiasComTopicos = [];
            materiasArray.forEach(materiaLine => {
                // Try to separate subject name from topics
                // Format can be: "Portugu√™s: topic1, topic2" or just "Portugu√™s"
                const parts = materiaLine.split(':');
                const nomeMateria = parts[0].trim();
                const topicosManual = parts[1] ? parts[1].split(',').map(t => t.trim()).filter(t => t) : [];

                // PRIORITY: Use global extracted topics from edital analysis if available
                let topicosParaUsar = topicosManual;

                if (topicosManual.length === 0 && extractedEditalTopics[nomeMateria] && extractedEditalTopics[nomeMateria].length > 0) {
                    topicosParaUsar = extractedEditalTopics[nomeMateria];
                    console.log(`‚úÖ Usando ${topicosParaUsar.length} t√≥picos extra√≠dos do edital para: ${nomeMateria}`);
                } else if (topicosManual.length === 0) {
                    // Try fuzzy match (case insensitive, partial match)
                    const matchKey = Object.keys(extractedEditalTopics).find(key =>
                        key.toLowerCase().includes(nomeMateria.toLowerCase()) ||
                        nomeMateria.toLowerCase().includes(key.toLowerCase())
                    );
                    if (matchKey && extractedEditalTopics[matchKey].length > 0) {
                        topicosParaUsar = extractedEditalTopics[matchKey];
                        console.log(`‚úÖ Match fuzzy! Usando ${topicosParaUsar.length} t√≥picos de "${matchKey}" para: ${nomeMateria}`);
                    } else {
                        topicosParaUsar = ['Consulte o conte√∫do program√°tico no edital'];
                        console.log(`‚ö†Ô∏è Nenhum t√≥pico encontrado para: ${nomeMateria}`);
                    }
                }

                materiasComTopicos.push({
                    nome: nomeMateria,
                    topicos: topicosParaUsar
                });
            });

            html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;

            const topicosPorSemana = Math.ceil(materiasComTopicos.reduce((sum, m) => sum + m.topicos.length, 0) / semanas);

            for (let sem = 1; sem <= Math.min(4, semanas); sem++) {
                html += `<h5>üìå Semana ${sem}</h5>`;
                html += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">`;
                html += `<thead><tr style="background: var(--bg-elevated);">`;
                html += `<th style="padding: 10px; text-align: left;">Dia</th>`;
                html += `<th style="padding: 10px; text-align: left;">Disciplinas e Assuntos</th>`;
                html += `<th style="padding: 10px; text-align: center;">Horas</th>`;
                html += `</tr></thead><tbody>`;

                // Track what was studied this week for Sunday revision
                const topicosEstudadosNaSemana = [];

                diasSemana.forEach((dia, idx) => {
                    html += `<tr style="border-bottom: 1px solid var(--border); vertical-align: top;">`;
                    html += `<td style="padding: 10px;"><strong>${dia}</strong></td>`;

                    if (idx === 6) { // Domingo - REVIS√ÉO APENAS DO QUE FOI ESTUDADO NA SEMANA
                        html += `<td style="padding: 10px;"><strong style="color: var(--accent-warm);">üìä REVIS√ÉO DA SEMANA + SIMULADO</strong><br>`;
                        html += `<p style="font-size: 13px; color: var(--text-secondary); margin: 5px 0;">Revise apenas o que voc√™ estudou esta semana:</p>`;
                        html += `<ul style="margin: 5px 0 0 20px; font-size: 14px; color: var(--text-secondary);">`;

                        // Show only what was studied this week
                        topicosEstudadosNaSemana.forEach(item => {
                            html += `<li><strong>${item.materia}:</strong> ${item.topicos.join(', ')}</li>`;
                        });

                        html += `</ul>`;
                        html += `<p style="font-size: 13px; color: var(--accent-warm); margin-top: 10px;"><strong>üíØ Simulado:</strong> Fa√ßa quest√µes APENAS dos t√≥picos acima para testar sua compreens√£o da semana!</p>`;
                        html += `</td>`;
                        html += `<td style="padding: 10px; text-align: center;">${horasDia}h</td>`;
                    } else {
                        // Distribute subjects across the week
                        const numMateriasHoje = (idx === 5) ? 2 : 2; // 2 subjects per day
                        const startIdx = (idx + (sem - 1) * 6) % materiasComTopicos.length;

                        html += `<td style="padding: 10px;">`;
                        html += `<ul style="margin: 0; padding: 0; list-style: none; line-height: 2;">`;

                        for (let i = 0; i < numMateriasHoje; i++) {
                            const materiaIdx = (startIdx + i) % materiasComTopicos.length;
                            const materia = materiasComTopicos[materiaIdx];

                            // Calculate which topics to show this week for this subject
                            const topicosParaHoje = [];
                            const topicosPerCycle = Math.max(1, Math.floor(materia.topicos.length / Math.min(4, semanas)));
                            const startTopicIdx = ((sem - 1) * topicosPerCycle) % materia.topicos.length;

                            for (let t = 0; t < Math.min(3, topicosPerCycle); t++) {
                                const topicIdx = (startTopicIdx + t) % materia.topicos.length;
                                if (materia.topicos[topicIdx]) {
                                    topicosParaHoje.push(materia.topicos[topicIdx]);
                                }
                            }

                            // TRACK TOPICS FOR SUNDAY REVISION
                            if (topicosParaHoje.length > 0) {
                                const existing = topicosEstudadosNaSemana.find(item => item.materia === materia.nome);
                                if (existing) {
                                    existing.topicos.push(...topicosParaHoje);
                                } else {
                                    topicosEstudadosNaSemana.push({
                                        materia: materia.nome,
                                        topicos: [...topicosParaHoje]
                                    });
                                }
                            }

                            html += `<li style="margin-bottom: 12px;">`;
                            html += `<strong style="color: var(--accent-primary);">${materia.nome}:</strong>`;
                            if (topicosParaHoje.length > 0) {
                                html += `<ul style="margin: 3px 0 0 20px; font-size: 14px; color: var(--text-secondary);">`;
                                topicosParaHoje.forEach(topico => {
                                    html += `<li>${topico}</li>`;
                                });
                                html += `</ul>`;
                            }
                            html += `</li>`;
                        }

                        html += `</ul></td>`;
                        html += `<td style="padding: 10px; text-align: center;">${horasDia}h</td>`;
                    }

                    html += `</tr>`;
                });

                html += `</tbody></table>`;
            }

            html += `<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px; margin-top: 15px;">`;
            html += `<p style="margin: 0;"><strong>üí° Dica:</strong> Este cronograma distribui os assuntos do edital ao longo das semanas. `;
            html += `Repita os ciclos at√© a prova, ajustando conforme sua evolu√ß√£o. Use a aba <strong>Estat√≠sticas</strong> para acompanhar seu progresso!</p>`;
            html += `</div>`;

            html += `</div>`;

            // √öLTIMA SEMANA - REVIS√ÉO INTENSIVA
            if (ultimaSemanaRevisao) {
                html += `<h4 style="color: var(--accent-warm); margin-top: 30px;">üî• √öLTIMA SEMANA - REVIS√ÉO INTENSIVA (7 dias antes da prova)</h4>`;
                html += `<div style="background: linear-gradient(135deg, var(--accent-warm), #e74c3c); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">`;
                html += `<p style="margin-bottom: 15px;"><strong>‚ö†Ô∏è ATEN√á√ÉO: √öltima semana √© SOMENTE revis√£o + simulados!</strong></p>`;
                html += `<table style="width: 100%; border-collapse: collapse; color: white;">`;
                html += `<thead><tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">`;
                html += `<th style="padding: 10px; text-align: left;">Dia</th>`;
                html += `<th style="padding: 10px; text-align: left;">Atividade</th>`;
                html += `</tr></thead><tbody>`;

                const ultimaSemana = [
                    { dia: 'Segunda', ativ: 'üìö Revis√£o geral de todas as mat√©rias + Resolu√ß√£o de quest√µes' },
                    { dia: 'Ter√ßa', ativ: 'üìù SIMULADO COMPLETO (tempo real de prova)' },
                    { dia: 'Quarta', ativ: 'üîç Corre√ß√£o do simulado + Revisar erros + Estudar pontos fracos' },
                    { dia: 'Quinta', ativ: 'üìñ Revis√£o das mat√©rias de maior peso + Flashcards' },
                    { dia: 'Sexta', ativ: 'üéØ Revis√£o leve + Conferir documentos e local de prova' },
                    { dia: 'S√°bado', ativ: 'üòå DESCANSO! N√£o estude. Relaxe, durma cedo' },
                    { dia: 'Domingo', ativ: 'üéØ DIA DA PROVA! Caf√© da manh√£, chegue cedo, confie em si!' }
                ];

                ultimaSemana.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">`;
                    html += `<td style="padding: 10px;"><strong>${item.dia}</strong></td>`;
                    html += `<td style="padding: 10px;">${item.ativ}</td>`;
                    html += `</tr>`;
                });

                html += `</tbody></table>`;
                html += `<p style="margin-top: 15px; font-size: 14px;">üí° <strong>Importante:</strong> Na √∫ltima semana, N√ÉO estude conte√∫do novo! Apenas revise e descanse.</p>`;
                html += `</div>`;
            }

            // Tips by level
            html += `<h4>üí° Dicas Espec√≠ficas para N√≠vel ${nivel.charAt(0).toUpperCase() + nivel.slice(1)}</h4>`;
            html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">`;
            html += `<ul>`;

            if (nivel === 'iniciante') {
                html += `<li>üìñ Comece pela teoria antes de fazer quest√µes</li>`;
                html += `<li>üéß Use o Leitor de Texto para refor√ßar conceitos</li>`;
                html += `<li>üé¥ Crie flashcards dos conceitos b√°sicos</li>`;
                html += `<li>‚è∞ Use Pomodoro de 25min para manter o foco</li>`;
            } else if (nivel === 'intermediario') {
                html += `<li>üìù Equilibre 50% teoria e 50% quest√µes</li>`;
                html += `<li>üìä Fa√ßa simulados semanalmente</li>`;
                html += `<li>üîç Identifique suas mat√©rias fracas e reforce</li>`;
                html += `<li>‚ö° Aumente gradualmente para Pomodoro de 50min</li>`;
            } else {
                html += `<li>üéØ Foco em quest√µes e simulados (70%)</li>`;
                html += `<li>üìà An√°lise estat√≠stica dos seus erros</li>`;
                html += `<li>üîÑ Revis√£o de jurisprud√™ncia recente</li>`;
                html += `<li>‚è±Ô∏è Treino de tempo: responda quest√µes cronometrando</li>`;
            }

            html += `</ul>`;
            html += `</div>`;

            // Final tips
            html += `<div style="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--success);">`;
            html += `<h4 style="color: var(--success);">‚úÖ Lembre-se:</h4>`;
            html += `<ul>`;
            html += `<li>üîÑ <strong>Consist√™ncia > Intensidade:</strong> Melhor estudar ${horasDia}h todo dia do que 20h em um √∫nico dia</li>`;
            html += `<li>üí§ <strong>Descanso √© essencial:</strong> Durma bem para consolidar o aprendizado</li>`;
            html += `<li>üéØ <strong>Qualidade > Quantidade:</strong> Estudo focado vale mais que horas distra√≠das</li>`;
            html += `<li>üìä <strong>Acompanhe seu progresso:</strong> Use a aba Estat√≠sticas para monitorar sua evolu√ß√£o</li>`;
            html += `</ul>`;
            html += `</div>`;

            return html;
        }

        function renderSavedEditais() {
            const listEl = document.getElementById('savedEditalList');

            if (savedEditais.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>Nenhuma an√°lise salva ainda</p></div>';
                return;
            }

            listEl.innerHTML = savedEditais.slice().reverse().map((item, idx) => `
                <div class="saved-item">
                    <div class="saved-item-header">
                        <div>
                            <div class="saved-item-title">An√°lise #${savedEditais.length - idx}</div>
                            <div class="saved-item-date">${item.date}</div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteEdital(${savedEditais.length - 1 - idx})">üóëÔ∏è</button>
                    </div>
                    <div class="saved-item-content">
                        <strong>Consulta:</strong> ${item.input}<br><br>
                        <div class="ai-response">${item.response}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderSavedCronogramas() {
            const savedCronogramas = Storage.get('savedCronogramas', []);
            const listEl = document.getElementById('savedCronogramaList');

            if (savedCronogramas.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>Nenhum cronograma salvo ainda</p></div>';
                return;
            }

            listEl.innerHTML = savedCronogramas.slice().reverse().map((item, idx) => `
                <div class="saved-item">
                    <div class="saved-item-header">
                        <div>
                            <div class="saved-item-title">${item.concurso}</div>
                            <div class="saved-item-date">${item.date}</div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteCronograma(${savedCronogramas.length - 1 - idx})">üóëÔ∏è</button>
                    </div>
                    <div class="saved-item-content">
                        <div class="ai-response">${item.response}</div>
                    </div>
                </div>
            `).join('');
        }

        function deleteEdital(index) {
            showConfirmDialog('Tem certeza que deseja excluir esta an√°lise?', () => {
                savedEditais.splice(index, 1);
                Storage.set('savedEditais', savedEditais);
                renderSavedEditais();
                showNotification('üóëÔ∏è An√°lise exclu√≠da');
            });
        }

        function deleteCronograma(index) {
            showConfirmDialog('Tem certeza que deseja excluir este cronograma?', () => {
                const savedCronogramas = Storage.get('savedCronogramas', []);
                savedCronogramas.splice(index, 1);
                Storage.set('savedCronogramas', savedCronogramas);
                renderSavedCronogramas();
                showNotification('üóëÔ∏è Cronograma exclu√≠do');
            });
        }

        // PROCESSAR CONTE√öDO PROGRAM√ÅTICO (colado pelo usu√°rio)
        document.getElementById('processarConteudo').addEventListener('click', () => {
            const conteudoText = document.getElementById('conteudoProgramatico').value.trim();

            if (!conteudoText) {
                showNotification('‚ö†Ô∏è Cole o conte√∫do program√°tico primeiro!');
                return;
            }

            // RESET GLOBAL
            extractedEditalTopics = {};

            // STEP 1: Join continuation lines (ONLY lines with SUBJECT NAME: are new subjects)
            const rawLines = conteudoText.split('\n');
            const consolidatedLines = [];
            let currentLine = '';

            rawLines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Detect new subject:
                // 1. ALL CAPS without number: "L√çNGUA PORTUGUESA:"
                // 2. Number + ALL CAPS: "1. GERENCIAMENTO:" (but NOT "1. Compreens√£o de textos")
                const allCapsWithColon = /^[A-Z√Ä-√ö][A-Z√Ä-√ö\s]{2,}:/.test(line);
                const numberedAllCapsWithColon = /^\d+\.\s+[A-Z√Ä-√ö][A-Z√Ä-√ö\s]{2,}:/.test(line);
                const looksLikeSubject = allCapsWithColon || numberedAllCapsWithColon;

                if (looksLikeSubject && currentLine) {
                    // Save previous subject and start new one
                    consolidatedLines.push(currentLine);
                    currentLine = line;
                } else if (looksLikeSubject) {
                    // First subject
                    currentLine = line;
                } else {
                    // Continuation line (even if starts with numbers!) - append to current
                    if (currentLine) {
                        currentLine += ' ' + line;
                    } else {
                        // If no current line yet, this is the first line but doesn't look like subject
                        currentLine = line;
                    }
                }
            });

            // Don't forget the last one
            if (currentLine) {
                consolidatedLines.push(currentLine);
            }

            console.log(`üìù ${rawLines.length} linhas originais ‚Üí ${consolidatedLines.length} mat√©rias consolidadas`);
            console.log('Linhas consolidadas:', consolidatedLines);

            // STEP 2: Parse consolidated lines - SEPARAR POR N√öMERO!
            let processedCount = 0;

            consolidatedLines.forEach((line, idx) => {
                console.log(`\nüîç Processando linha ${idx + 1}:`, line.substring(0, 100) + '...');
                line = line.trim();
                if (!line) return;

                // Split by colon to separate materia from topics
                let materia, topicosStr;

                if (line.includes(':')) {
                    const parts = line.split(':');
                    materia = parts[0].trim();
                    topicosStr = parts.slice(1).join(':').trim();
                } else {
                    // No delimiter - whole line is the subject
                    materia = line;
                    topicosStr = '';
                }

                if (materia) {
                    // Clean subject name (remove leading numbers like "1. ")
                    materia = materia.replace(/^\d+\.\s*/, '');

                    // Parse topics - SEPARAR POR N√öMERO (1, 2, 3, 4.1, etc.)
                    let topicos = [];
                    if (topicosStr) {
                        // REGEX ATUALIZADO: Aceita "1 texto", "1. texto" ou "1.1 texto"
                        // Captura: 1, 2, 3, 4.1, 5.2, etc. (com ou sem ponto ap√≥s o n√∫mero)
                        const regex = /(\d+(?:\.\d+)?)[.\s]+([^0-9]+?)(?=\s+\d+(?:\.\d+)?[.\s]|$)/g;
                        let match;

                        while ((match = regex.exec(topicosStr)) !== null) {
                            const numero = match[1];
                            let texto = match[2].trim();

                            // Limpar pontua√ß√£o final se houver (mas manter pontos no meio do texto)
                            texto = texto.replace(/[.,;:]+$/, '').trim();

                            if (texto && texto.length > 2) {
                                // Incluir o n√∫mero no texto do t√≥pico
                                topicos.push(`${numero}. ${texto}`);
                            }
                        }

                        // Se n√£o achou t√≥picos numerados, tenta por v√≠rgula/ponto-e-v√≠rgula
                        if (topicos.length === 0) {
                            topicos = topicosStr.split(/[,;]/).map(t => t.trim()).filter(t => t && t.length > 2);
                        }
                    }

                    if (topicos.length > 0) {
                        extractedEditalTopics[materia] = topicos;
                        processedCount++;
                        console.log(`‚úÖ ${materia}: ${topicos.length} t√≥picos`);
                        console.log('T√≥picos:', topicos);
                    }
                }
            });

            if (processedCount > 0) {
                showNotification(`‚úÖ ${processedCount} mat√©rias processadas! Conte√∫do pronto para usar no cronograma, quest√µes e flashcards.`);

                // Show preview
                let preview = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
                preview += '<h3 style="color: var(--accent-primary); margin-bottom: 15px;">üìã Conte√∫do Program√°tico Processado</h3>';

                Object.keys(extractedEditalTopics).forEach((materia, idx) => {
                    const topicos = extractedEditalTopics[materia];
                    preview += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-primary);">`;

                    if (topicos.length > 0) {
                        preview += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${materia}:</strong> `;
                        preview += topicos.join(', ');
                        preview += '.</p>';
                    } else {
                        preview += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${materia}</strong> `;
                        preview += '<span style="color: var(--text-secondary); font-style: italic;">(sem t√≥picos especificados)</span></p>';
                    }

                    preview += '</div>';
                });

                preview += '<div style="margin-top: 20px; padding: 15px; background: var(--bg-elevated); border-radius: 8px;">';
                preview += '<p style="margin: 0;"><strong>‚úÖ Pronto!</strong> Este conte√∫do ser√° usado automaticamente em:</p>';
                preview += '<ul style="margin: 10px 0 0 20px; line-height: 1.8;">';
                preview += '<li>üìÖ Cronograma C√≠clico (com t√≥picos espec√≠ficos por dia)</li>';
                preview += '<li>üìù Caderno de Quest√µes</li>';
                preview += '<li>üéØ Simulados</li>';
                preview += '<li>üÉè Flashcards</li>';
                preview += '</ul></div>';
                preview += '</div>';

                document.getElementById('editalOutput').innerHTML = preview;

                // Save to storage
                Storage.set('conteudoProgramatico', extractedEditalTopics);

                // Update Dashboard
                updateDashboard();
            } else {
                showNotification('‚ö†Ô∏è Nenhuma mat√©ria foi encontrada. Verifique o formato!');
            }
        });

        document.getElementById('analyzeEdital').addEventListener('click', analyzeEdital);
        document.getElementById('generateCronograma').addEventListener('click', generateCronograma);

        // ==================== DASHBOARD ====================

        // Fun√ß√µes para Informa√ß√µes do Edital
        function toggleEditarInfoEdital() {
            const displayMode = document.getElementById('editalInfoDisplay');
            const editMode = document.getElementById('editalInfoEdit');
            const btnText = document.getElementById('editEditalInfo');

            if (editMode.style.display === 'none') {
                // Carregar valores atuais nos inputs
                const info = Storage.get('editalInfo', {});
                document.getElementById('inputCargo').value = info.cargo || '';
                document.getElementById('inputDataProva').value = info.dataProva || '';
                document.getElementById('inputVagas').value = info.vagas || '';
                document.getElementById('inputSalario').value = info.salario || '';
                document.getElementById('inputOrgao').value = info.orgao || '';
                document.getElementById('inputEscolaridade').value = info.escolaridade || '';

                displayMode.style.display = 'none';
                editMode.style.display = 'block';
                btnText.innerHTML = '‚ùå Cancelar';
            } else {
                displayMode.style.display = 'grid';
                editMode.style.display = 'none';
                btnText.innerHTML = '‚úèÔ∏è Editar';
            }
        }

        function salvarInfoEdital() {
            const info = {
                cargo: document.getElementById('inputCargo').value,
                dataProva: document.getElementById('inputDataProva').value,
                vagas: document.getElementById('inputVagas').value,
                salario: document.getElementById('inputSalario').value,
                orgao: document.getElementById('inputOrgao').value,
                escolaridade: document.getElementById('inputEscolaridade').value
            };

            Storage.set('editalInfo', info);
            loadEditalInfo();
            toggleEditarInfoEdital();
            updateDashboard(); // Atualizar countdown com nova data
            showNotification('‚úÖ Informa√ß√µes salvas com sucesso!');
        }

        function loadEditalInfo() {
            const info = Storage.get('editalInfo', {});

            document.getElementById('displayCargo').textContent = info.cargo || 'N√£o informado';
            document.getElementById('displayVagas').textContent = info.vagas || 'N√£o informado';
            document.getElementById('displaySalario').textContent = info.salario || 'N√£o informado';
            document.getElementById('displayOrgao').textContent = info.orgao || 'N√£o informado';
            document.getElementById('displayEscolaridade').textContent = info.escolaridade || 'N√£o informado';

            if (info.dataProva) {
                const [year, month, day] = info.dataProva.split('-');
                document.getElementById('displayDataProva').textContent = `${day}/${month}/${year}`;
            } else {
                document.getElementById('displayDataProva').textContent = 'N√£o informado';
            }
        }

        function updateDashboard() {
            // Get passadas from localStorage (novo sistema)
            const passadas = Storage.get('topicPassadas', {});

            // Calculate stats
            let totalMaterias = Object.keys(extractedEditalTopics).length;
            let totalTopicos = 0;
            let topicosComPassada = 0; // T√≥picos com pelo menos 1 passada = progresso real

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia];
                totalTopicos += topicos.length;

                // Count studied topics for this materia (pelo menos 1 passada)
                if (passadas[materia]) {
                    topicos.forEach(topico => {
                        const numPassadas = passadas[materia][topico] || 0;
                        if (numPassadas > 0) {
                            topicosComPassada++;
                        }
                    });
                }
            });

            // PROGRESSO = % de t√≥picos com pelo menos 1 passada
            const percentual = totalTopicos > 0 ? Math.round((topicosComPassada / totalTopicos) * 100) : 0;

            // Update stats cards
            document.getElementById('totalMaterias').textContent = totalMaterias;
            document.getElementById('totalTopicos').textContent = totalTopicos;
            document.getElementById('topicosEstudados').textContent = topicosComPassada;
            document.getElementById('percentualProgresso').textContent = percentual + '%';

            // Update trof√©u geral
            const trofeuGeral = getTrofeu(percentual);
            const trofeuCard = document.getElementById('trofeuGeral');
            if (trofeuGeral) {
                document.getElementById('trofeuGeralEmoji').textContent = trofeuGeral.emoji;
                document.getElementById('trofeuGeralNome').textContent = trofeuGeral.nome;
                trofeuCard.style.display = 'block';
            } else {
                trofeuCard.style.display = 'none';
            }

            // Update countdown
            updateExamCountdown();

            // Update progress bars per materia
            renderMateriasProgress(passadas);
        }

        function updateExamCountdown() {
            // PRIORIDADE 1: Data manual (definida pelo usu√°rio)
            const editalInfo = Storage.get('editalInfo', {});
            let examDate = null;

            if (editalInfo.dataProva) {
                const [year, month, day] = editalInfo.dataProva.split('-');
                examDate = new Date(year, month - 1, day);
            } else {
                // PRIORIDADE 2: Data extra√≠da da an√°lise do edital
                const savedEditais = Storage.get('savedEditais', []);
                savedEditais.forEach(edital => {
                    if (edital.response && edital.response.includes('Data da Prova:')) {
                        // Try to extract date from analysis
                        const match = edital.response.match(/Data da Prova:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/);
                        if (match) {
                            const [day, month, year] = match[1].split('/');
                            const date = new Date(year, month - 1, day);
                            if (!examDate || date < examDate) {
                                examDate = date;
                            }
                        }
                    }
                });
            }

            if (examDate) {
                const today = new Date();
                const diffTime = examDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                document.getElementById('diasRestantes').textContent = diffDays + ' dias';

                // Calculate required pace
                const totalTopicos = document.getElementById('totalTopicos').textContent;
                const topicosEstudados = document.getElementById('topicosEstudados').textContent;
                const topicosRestantes = parseInt(totalTopicos) - parseInt(topicosEstudados);

                if (diffDays > 0 && topicosRestantes > 0) {
                    const topicosPorDia = Math.ceil(topicosRestantes / diffDays);
                    document.getElementById('ritmoEstudo').textContent =
                        `Voc√™ precisa estudar ${topicosPorDia} t√≥picos por dia para terminar a tempo!`;
                } else if (topicosRestantes === 0) {
                    document.getElementById('ritmoEstudo').textContent = 'üéâ Parab√©ns! Voc√™ j√° estudou todo o conte√∫do!';
                } else {
                    document.getElementById('ritmoEstudo').textContent = '‚ö†Ô∏è Data da prova j√° passou!';
                }
            } else {
                document.getElementById('diasRestantes').textContent = '--';
                document.getElementById('ritmoEstudo').textContent = 'Defina a data da prova em "An√°lise de Edital"';
            }
        }

        // Vari√°vel global para guardar quais mat√©rias est√£o expandidas
        let expandedMaterias = new Set();

        // Sistema de trof√©us/medalhas por progresso
        function getTrofeu(percentual) {
            if (percentual >= 100) {
                return { emoji: 'ü•á', nome: 'Trof√©u de Ouro - 100%' };
            } else if (percentual >= 50) {
                return { emoji: 'ü•à', nome: 'Trof√©u de Prata - 50%' };
            } else if (percentual >= 30) {
                return { emoji: 'ü•â', nome: 'Trof√©u de Bronze - 30%' };
            } else if (percentual >= 20) {
                return { emoji: '‚≠ê', nome: 'Medalha de Participa√ß√£o - 20%' };
            }
            return null;
        }

        function renderMateriasProgress(passadas) {
            const container = document.getElementById('materiasProgressList');

            if (Object.keys(extractedEditalTopics).length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                        Nenhum conte√∫do program√°tico processado ainda.<br>
                        <a href="#" onclick="switchTab('edital'); return false;" style="color: var(--accent-primary); text-decoration: underline;">V√° para "An√°lise de Edital"</a> e processe o conte√∫do program√°tico.
                    </p>
                `;
                return;
            }

            let html = '';

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia];
                const totalTopicos = topicos.length;
                const materiaId = materia.replace(/\s/g, '_');

                // Calcular progresso baseado nas passadas
                let pontuacaoMaxima = totalTopicos * 3; // 3 passadas por t√≥pico
                let pontuacaoAtual = 0;
                let topicosComPassada = 0;
                let passada1 = 0, passada2 = 0, passada3 = 0;

                if (passadas[materia]) {
                    topicos.forEach(topico => {
                        const numPassadas = passadas[materia][topico] || 0;
                        pontuacaoAtual += numPassadas;
                        if (numPassadas > 0) topicosComPassada++;
                        if (numPassadas >= 1) passada1++;
                        if (numPassadas >= 2) passada2++;
                        if (numPassadas >= 3) passada3++;
                    });
                }

                // L√ìGICA CORRETA: Progresso = % de t√≥picos com PELO MENOS 1 passada
                // Se estudou 100% do conte√∫do em 1 passada = 100% do edital coberto!
                // 2¬™ e 3¬™ passadas s√£o REVIS√ïES, n√£o afetam o progresso principal
                const percentual = totalTopicos > 0 ? Math.round((topicosComPassada / totalTopicos) * 100) : 0;

                // Sistema de trof√©us/medalhas
                const trofeu = getTrofeu(percentual);

                // Verificar se esta mat√©ria est√° expandida
                const isExpanded = expandedMaterias.has(materiaId);
                const displayStyle = isExpanded ? 'block' : 'none';
                const arrowRotation = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';

                html += `
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--accent-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer;" onclick="toggleMateriaTopics('${materiaId}')">
                                <span id="arrow_${materiaId}" style="display: inline-block; transition: transform 0.3s; transform: ${arrowRotation};">‚ñ∂</span>
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 18px;">${materia}</h4>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${trofeu ? `<span style="font-size: 24px;" title="${trofeu.nome}">${trofeu.emoji}</span>` : ''}
                                <span style="font-size: 16px; font-weight: 700; color: var(--accent-primary);">${percentual}%</span>
                                <button onclick="deleteMateria('${materia}')"
                                        title="Excluir esta mat√©ria"
                                        style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>

                        <div style="background: var(--bg-secondary); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 10px;">
                            <div style="background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); height: 100%; width: ${percentual}%; transition: width 0.5s ease;"></div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            <span>üìã ${totalTopicos} t√≥picos</span>
                            <span>‚úÖ ${topicosComPassada} iniciados</span>
                            <span style="color: #ffc107;">üìñ ${passada1} (1¬™)</span>
                            <span style="color: #2196F3;">üîÑ ${passada2} (2¬™)</span>
                            <span style="color: #4CAF50;">‚úì ${passada3} (3¬™)</span>
                            <span>‚è≥ ${totalTopicos - topicosComPassada} n√£o iniciados</span>
                        </div>

                        <!-- Lista de T√≥picos (Expand√≠vel) -->
                        <div id="topics_${materiaId}" style="display: ${displayStyle}; margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border);">
                `;

                // Renderizar t√≥picos inline
                topicos.forEach((topico, idx) => {
                    const currentPassada = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                    const p1Checked = currentPassada >= 1;
                    const p2Checked = currentPassada >= 2;
                    const p3Checked = currentPassada >= 3;

                    html += `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);">
                            <span style="flex: 1; color: var(--text-primary); font-size: 14px; line-height: 1.5;">
                                ${topico}
                            </span>
                            <div style="display: flex; gap: 15px; align-items: center; flex-shrink: 0;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" ${p1Checked ? 'checked' : ''}
                                           onchange="togglePassadaInline('${materia}', '${topico.replace(/'/g, "\\'")}', 1, this.checked)"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #ffc107;">
                                    <span style="color: #ffc107; font-weight: 600; font-size: 13px;">1¬™</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" ${p2Checked ? 'checked' : ''}
                                           onchange="togglePassadaInline('${materia}', '${topico.replace(/'/g, "\\'")}', 2, this.checked)"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #2196F3;">
                                    <span style="color: #2196F3; font-weight: 600; font-size: 13px;">2¬™</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" ${p3Checked ? 'checked' : ''}
                                           onchange="togglePassadaInline('${materia}', '${topico.replace(/'/g, "\\'")}', 3, this.checked)"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #4CAF50;">
                                    <span style="color: #4CAF50; font-weight: 600; font-size: 13px;">3¬™</span>
                                </label>
                                <button onclick="deleteTopico('${materia}', '${topico.replace(/'/g, "\\'")}')"
                                        title="Excluir este t√≥pico"
                                        style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 8px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleMateriaTopics(materiaId) {
            // Adicionar ou remover do Set de mat√©rias expandidas
            if (expandedMaterias.has(materiaId)) {
                expandedMaterias.delete(materiaId);
            } else {
                expandedMaterias.add(materiaId);
            }

            // Atualizar visualmente sem reconstruir tudo
            const topicsDiv = document.getElementById(`topics_${materiaId}`);
            const arrow = document.getElementById(`arrow_${materiaId}`);

            if (expandedMaterias.has(materiaId)) {
                topicsDiv.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                topicsDiv.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function togglePassadaInline(materia, topico, passada, isChecked) {
            const passadas = Storage.get('topicPassadas', {});

            if (!passadas[materia]) {
                passadas[materia] = {};
            }

            if (isChecked) {
                // Marcar esta passada
                passadas[materia][topico] = passada;
                const emoji = passada === 1 ? 'üìñ' : passada === 2 ? 'üîÑ' : '‚úÖ';
                showNotification(`${emoji} ${passada}¬™ passada marcada!`);
            } else {
                // Desmarcar esta passada
                if (passada === 1) {
                    delete passadas[materia][topico];
                } else {
                    passadas[materia][topico] = passada - 1;
                }
                showNotification(`‚Ü©Ô∏è ${passada}¬™ passada desmarcada!`);
            }

            Storage.set('topicPassadas', passadas);
            updateDashboard();
        }

        function deleteTopico(materia, topico) {
            showConfirmDialog(`Tem certeza que deseja excluir o t√≥pico:<br><br>"<strong>${topico}</strong>"<br><br>da mat√©ria "${materia}"?`, () => {
                // Remover t√≥pico do array
                if (extractedEditalTopics[materia]) {
                    extractedEditalTopics[materia] = extractedEditalTopics[materia].filter(t => t !== topico);

                    // Se a mat√©ria ficou sem t√≥picos, remove ela tamb√©m
                    if (extractedEditalTopics[materia].length === 0) {
                        delete extractedEditalTopics[materia];
                        const materiaId = materia.replace(/\s/g, '_');
                        expandedMaterias.delete(materiaId);
                        showNotification(`üóëÔ∏è T√≥pico exclu√≠do! A mat√©ria "${materia}" foi removida pois ficou sem t√≥picos.`);
                    } else {
                        showNotification(`üóëÔ∏è T√≥pico exclu√≠do com sucesso!`);
                    }

                    Storage.set('conteudoProgramatico', extractedEditalTopics);
                }

                // Remover progresso de passadas deste t√≥pico
                const passadas = Storage.get('topicPassadas', {});
                if (passadas[materia]) {
                    delete passadas[materia][topico];
                    Storage.set('topicPassadas', passadas);
                }

                updateDashboard();
            });
        }

        function deleteMateria(materia) {
            showConfirmDialog(`Tem certeza que deseja excluir a mat√©ria "${materia}"?<br><br>‚ö†Ô∏è Isso tamb√©m excluir√° todo o progresso de passadas desta mat√©ria.`, () => {
                // Remover do conte√∫do program√°tico
                delete extractedEditalTopics[materia];
                Storage.set('conteudoProgramatico', extractedEditalTopics);

                // Remover progresso de passadas
                const passadas = Storage.get('topicPassadas', {});
                delete passadas[materia];
                Storage.set('topicPassadas', passadas);

                // Remover do set de mat√©rias expandidas
                const materiaId = materia.replace(/\s/g, '_');
                expandedMaterias.delete(materiaId);

                showNotification(`üóëÔ∏è Mat√©ria "${materia}" exclu√≠da com sucesso!`);
                updateDashboard();
            });
        }

        function carregarConteudoParaEdicao() {
            if (Object.keys(extractedEditalTopics).length === 0) {
                showNotification('‚ö†Ô∏è N√£o h√° conte√∫do salvo para editar!');
                return;
            }

            // Converter o objeto de volta para o formato de texto
            let conteudoTexto = '';
            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia];
                conteudoTexto += `${materia}: ${topicos.join(', ')}\n`;
            });

            // Colocar no textarea
            document.getElementById('conteudoProgramatico').value = conteudoTexto.trim();

            showNotification('‚úèÔ∏è Conte√∫do carregado! Edite e clique em "Processar" novamente.');

            // Scroll para o textarea
            document.getElementById('conteudoProgramatico').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function limparConteudoProgramatico() {
            showConfirmDialog('‚ö†Ô∏è <strong>ATEN√á√ÉO!</strong><br><br>Isso ir√° excluir TODAS as mat√©rias e TODO o progresso de passadas.<br><br>Tem certeza que deseja continuar?', () => {
                // Limpar tudo
                extractedEditalTopics = {};
                Storage.set('conteudoProgramatico', {});
                Storage.set('topicPassadas', {});
                expandedMaterias.clear();

                // Limpar textarea
                document.getElementById('conteudoProgramatico').value = '';
                document.getElementById('editalOutput').innerHTML = '';

                showNotification('üóëÔ∏è Todo o conte√∫do program√°tico foi exclu√≠do!');
                updateDashboard();
            });
        }

        function switchTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active to selected tab
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // ==================== END DASHBOARD ====================

        // Load saved conteudo programatico on page load
        const savedConteudo = Storage.get('conteudoProgramatico', null);
        if (savedConteudo) {
            extractedEditalTopics = savedConteudo;
            console.log('‚úÖ Conte√∫do program√°tico carregado:', Object.keys(extractedEditalTopics).length, 'mat√©rias');
        }

        renderSavedEditais();
        renderSavedCronogramas();
        loadEditalInfo();
        updateDashboard();

        // PWA - Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('‚ùå Falha ao registrar Service Worker:', error);
                    });
            });
        }

        // PWA - Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Mostrar notifica√ß√£o para instalar
            setTimeout(() => {
                const installMsg = document.createElement('div');
                installMsg.className = 'result-message result-info';
                installMsg.innerHTML = `
                    üì≤ Instale o VINE CONCURSOS IA na tela inicial do seu celular!
                    <button class="btn" onclick="installApp()" style="margin-top: 10px;">Instalar Agora</button>
                `;
                installMsg.style.position = 'fixed';
                installMsg.style.bottom = '20px';
                installMsg.style.left = '20px';
                installMsg.style.right = '20px';
                installMsg.style.zIndex = '2000';
                installMsg.id = 'installPrompt';
                document.body.appendChild(installMsg);
            }, 3000);
        });

        window.installApp = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;

                const prompt = document.getElementById('installPrompt');
                if (prompt) prompt.remove();
            }
        };

        // Detectar se est√° rodando como PWA instalado
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('üöÄ App rodando como PWA instalado!');
        }

        // Update system status indicators
        function updateSystemStatus() {
            // PWA Status
            const pwaInstalled = window.matchMedia('(display-mode: standalone)').matches;
            document.getElementById('pwaStatus').textContent = pwaInstalled ? '‚úÖ Instalado' : '‚ö†Ô∏è Web';

            // Storage Status
            document.getElementById('storageStatus').textContent = useLocalStorage ? '‚úÖ Ativo' : '‚ö†Ô∏è Mem√≥ria';

            // Service Worker Status
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    document.getElementById('swStatus').textContent = registration ? '‚úÖ Ativo' : '‚ö†Ô∏è Inativo';
                });
            } else {
                document.getElementById('swStatus').textContent = '‚ùå N√£o suportado';
            }

            // Poe API Status
            document.getElementById('poeStatus').textContent = window.Poe ? '‚úÖ Dispon√≠vel' : '‚ö†Ô∏è Indispon√≠vel';
        }

        // Update status when tab changes
        document.querySelectorAll('.tab-btn').forEach(btn => {
            const originalClick = btn.onclick;
            btn.addEventListener('click', () => {
                if (btn.dataset.tab === 'ajuda') {
                    setTimeout(updateSystemStatus, 100);
                }
            });
        });

        // Initial status update
        updateSystemStatus();
    </script>
</body>
</html>