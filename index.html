<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VINE CONCURSOS IA - Seu Aliado nos Estudos</title>
    <meta name="description" content="Assistente inteligente para prepara√ß√£o em concursos p√∫blicos com an√°lise de editais, cronogramas, flashcards e muito mais">
    <meta name="theme-color" content="#00d9ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="VINE IA">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- PDF.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>

    <style>
        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151b3d;
            --bg-tertiary: #1e2749;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-warm: #f59e0b;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
            --border: #2d3657;
        }

        body.dark {
            --bg-primary: #0a0e27;
            --bg-secondary: #151b3d;
            --bg-tertiary: #1e2749;
            --accent-primary: #00d9ff;
            --accent-secondary: #7c3aed;
            --accent-warm: #f59e0b;
            --text-primary: #e8eaed;
            --text-secondary: #9ca3af;
            --success: #10b981;
            --danger: #ef4444;
            --border: #2d3657;
        }

        body.light {
            --bg-primary: #fafafa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --accent-primary: #0891b2;
            --accent-secondary: #7c3aed;
            --accent-warm: #ea580c;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --success: #059669;
            --danger: #dc2626;
            --border: #e2e8f0;
        }

        body.kindle {
            --bg-primary: #f7f3e9;
            --bg-secondary: #eeead5;
            --bg-tertiary: #e5e0cc;
            --accent-primary: #a07d3a;
            --accent-secondary: #b8946e;
            --accent-warm: #c89b68;
            --text-primary: #4a403a;
            --text-secondary: #7a6f65;
            --success: #8b9a5f;
            --danger: #c6725e;
            --border: #d4cdb8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .mono {
            font-family: 'IBM Plex Mono', monospace;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--accent-primary);
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-family: 'Outfit', sans-serif;
        }

        .tab-btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-color: transparent;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: var(--accent-primary);
        }

        .timer-display {
            font-size: 72px;
            text-align: center;
            margin: 30px 0;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            font-family: 'Outfit', sans-serif;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 217, 255, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-color: var(--accent-primary);
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            transition: border-color 0.2s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .flashcard {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 40px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 30px 0;
            position: relative;
            perspective: 1000px;
        }

        .flashcard:hover {
            border-color: var(--accent-primary);
            transform: scale(1.02);
        }

        .flashcard-content {
            font-size: 24px;
            line-height: 1.6;
        }

        .flashcard-hint {
            position: absolute;
            bottom: 15px;
            right: 15px;
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .flashcard-list {
            display: grid;
            gap: 15px;
        }

        .flashcard-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }

        .flashcard-item-content {
            flex: 1;
        }

        .flashcard-item strong {
            color: var(--accent-primary);
            display: block;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-primary);
            margin: 10px 0;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-tertiary);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--border);
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .question-card {
            background: var(--bg-tertiary);
            padding: 25px;
            border-radius: 12px;
            border: 2px solid var(--border);
            margin: 20px 0;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .options {
            display: grid;
            gap: 12px;
        }

        .option {
            padding: 15px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .option:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .option.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: white;
        }

        .option.correct {
            border-color: var(--success);
            background: var(--success);
            color: white;
        }

        .option.incorrect {
            border-color: var(--danger);
            background: var(--danger);
            color: white;
        }

        .result-message {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .result-success {
            background: var(--success);
            color: white;
        }

        .result-info {
            background: var(--accent-primary);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--accent-primary);
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: var(--accent-primary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .ai-response {
            background: var(--bg-tertiary);
            border-left: 4px solid var(--accent-primary);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.8;
        }

        .ai-response h3 {
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Anima√ß√µes para popup de conquista */
        @keyframes popupBounce {
            0% { transform: translate(-50%, -50%) scale(0); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        @keyframes popupFadeOut {
            to { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        @keyframes medalhaRotate {
            0% { transform: rotate(-10deg) scale(1); }
            100% { transform: rotate(10deg) scale(1.1); }
        }

        .loading-message {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            color: var(--text-secondary);
        }

        .saved-item {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        .saved-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .saved-item-title {
            font-weight: 600;
            color: var(--accent-primary);
            font-size: 16px;
        }

        .saved-item-date {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .saved-item-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 24px;
            }

            .timer-display {
                font-size: 56px;
            }

            .flashcard-content {
                font-size: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- PDF.js para leitura de PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Configurar PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
</head>
<body>
    <div class="app-container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h1 style="margin: 0;">üìö VINE CONCURSOS IA</h1>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label style="color: var(--text-secondary); font-size: 14px;">Tema:</label>
                    <select id="themeSelector" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); cursor: pointer;">
                        <option value="dark">üåô Escuro</option>
                        <option value="kindle">üìñ Kindle (S√©pia)</option>
                        <option value="light">‚òÄÔ∏è Claro</option>
                    </select>
                    <button onclick="switchTab('config')" style="padding: 8px 16px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='var(--accent-primary)'; this.style.borderColor='var(--accent-primary)';" onmouseout="this.style.background='var(--bg-secondary)'; this.style.borderColor='var(--border)';">
                        ‚öôÔ∏è Config
                    </button>
                </div>
            </div>
            <div class="tabs">
                <button class="tab-btn active" data-tab="dashboard">üìä Dashboard</button>
                <button class="tab-btn" data-tab="edital">üìã An√°lise de Edital</button>
                <button class="tab-btn" data-tab="cronograma">üìÖ Cronograma</button>
                <button class="tab-btn" data-tab="pomodoro">‚è±Ô∏è Pomodoro</button>
                <button class="tab-btn" data-tab="leitor">üéß Leitor de Texto</button>
                <button class="tab-btn" data-tab="flashcards">üé¥ Flashcards</button>
                <button class="tab-btn" data-tab="simulado">üìù Simulado</button>
                <button class="tab-btn" data-tab="estatisticas">üìä Estat√≠sticas</button>
                <button class="tab-btn" data-tab="ajuda">‚ùì Como Instalar</button>
            </div>
        </header>

        <!-- TAB: DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="card">
                <h2 style="margin-bottom: 25px;">üìä Vis√£o Geral do Seu Progresso</h2>

                <!-- Informa√ß√µes do Edital -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 16px; margin-bottom: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: white; font-size: 20px;">üìã Informa√ß√µes do Edital</h3>
                        <button id="editEditalInfo" onclick="toggleEditarInfoEdital()" style="padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                            ‚úèÔ∏è Editar
                        </button>
                    </div>

                    <!-- Display Mode -->
                    <div id="editalInfoDisplay" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">Cargo/Concurso</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayCargo">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üìÖ Data da Prova</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayDataProva">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üë• Vagas</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayVagas">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üí∞ Sal√°rio Inicial</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displaySalario">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üè¢ √ìrg√£o</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayOrgao">N√£o informado</div>
                        </div>
                        <div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 13px; margin-bottom: 5px;">üéì Escolaridade</div>
                            <div style="color: white; font-weight: 600; font-size: 16px;" id="displayEscolaridade">N√£o informado</div>
                        </div>
                    </div>

                    <!-- Edit Mode (Hidden by default) -->
                    <div id="editalInfoEdit" style="display: none;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">Cargo/Concurso</label>
                                <input type="text" id="inputCargo" placeholder="Ex: Analista Judici√°rio - TRT" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üìÖ Data da Prova</label>
                                <input type="date" id="inputDataProva" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üë• Vagas</label>
                                <input type="text" id="inputVagas" placeholder="Ex: 50" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üí∞ Sal√°rio Inicial</label>
                                <input type="text" id="inputSalario" placeholder="Ex: R$ 8.500,00" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üè¢ √ìrg√£o</label>
                                <input type="text" id="inputOrgao" placeholder="Ex: Tribunal Regional do Trabalho" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                            <div>
                                <label style="color: rgba(255,255,255,0.9); font-size: 13px; display: block; margin-bottom: 5px;">üéì Escolaridade</label>
                                <input type="text" id="inputEscolaridade" placeholder="Ex: Superior Completo" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); color: white; font-size: 14px;">
                            </div>
                        </div>
                        <button onclick="salvarInfoEdital()" style="margin-top: 20px; padding: 12px 24px; background: white; color: #667eea; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 15px; transition: all 0.2s;">
                            ‚úÖ Salvar Informa√ß√µes
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Total Mat√©rias -->
                    <div onclick="mostrarDetalhesMateria()" style="background: linear-gradient(135deg, #FFE66D 0%, #FFDB4D 100%); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative;" onmouseover="this.style.transform='translateY(-4px) rotate(0.5deg)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1)'">
                        <div style="font-size: 36px; margin-bottom: 10px;">üìö</div>
                        <div style="font-size: 32px; font-weight: 700; color: #333; margin-bottom: 5px;" id="totalMaterias">0</div>
                        <div style="font-size: 14px; color: rgba(0,0,0,0.7); font-weight: 500;">Mat√©rias no Edital</div>
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: rgba(0,0,0,0.4);">üëÜ clique</div>
                    </div>

                    <!-- Total T√≥picos -->
                    <div onclick="mostrarDetalhesTopicos()" style="background: linear-gradient(135deg, #A8E6CF 0%, #8FD9B6 100%); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative;" onmouseover="this.style.transform='translateY(-4px) rotate(-0.5deg)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1)'">
                        <div style="font-size: 36px; margin-bottom: 10px;">üìã</div>
                        <div style="font-size: 32px; font-weight: 700; color: #333; margin-bottom: 5px;" id="totalTopicos">0</div>
                        <div style="font-size: 14px; color: rgba(0,0,0,0.7); font-weight: 500;">T√≥picos Totais</div>
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: rgba(0,0,0,0.4);">üëÜ clique</div>
                    </div>

                    <!-- T√≥picos Estudados -->
                    <div onclick="mostrarDetalhesEstudados()" style="background: linear-gradient(135deg, #FFB6D9 0%, #FF9DC6 100%); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative;" onmouseover="this.style.transform='translateY(-4px) rotate(0.5deg)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1)'">
                        <div style="font-size: 36px; margin-bottom: 10px;">‚úÖ</div>
                        <div style="font-size: 32px; font-weight: 700; color: #333; margin-bottom: 5px;" id="topicosEstudados">0</div>
                        <div style="font-size: 14px; color: rgba(0,0,0,0.7); font-weight: 500;">T√≥picos Estudados</div>
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: rgba(0,0,0,0.4);">üëÜ clique</div>
                    </div>

                    <!-- Progresso % -->
                    <div onclick="mostrarDetalhesProgresso()" style="background: linear-gradient(135deg, #B4D7FF 0%, #9BC5F5 100%); padding: 25px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; position: relative;" onmouseover="this.style.transform='translateY(-4px) rotate(-0.5deg)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.15)'" onmouseout="this.style.transform=''; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1), inset 0 -2px 0 rgba(0,0,0,0.1)'">
                        <div style="font-size: 36px; margin-bottom: 10px;">üéØ</div>
                        <div style="font-size: 32px; font-weight: 700; color: #333; margin-bottom: 5px;" id="percentualProgresso">0%</div>
                        <div style="font-size: 14px; color: rgba(0,0,0,0.7); font-weight: 500;">Progresso Geral</div>
                        <div style="position: absolute; top: 10px; right: 10px; font-size: 12px; color: rgba(0,0,0,0.4);">üëÜ clique</div>
                    </div>

                    <!-- Trof√©u Geral -->
                    <div id="trofeuGeral" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 25px; border-radius: 16px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); display: none;">
                        <div style="font-size: 48px; margin-bottom: 10px;" id="trofeuGeralEmoji">üèÜ</div>
                        <div style="font-size: 16px; font-weight: 700; color: white; margin-bottom: 5px;" id="trofeuGeralNome">Trof√©u</div>
                        <div style="font-size: 14px; color: rgba(255,255,255,0.9); font-weight: 500;">Conquista Desbloqueada!</div>
                    </div>
                </div>

                <!-- Gr√°ficos Visuais -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Gr√°fico de Pizza - Distribui√ß√£o por Disciplina -->
                    <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 16px; border: 2px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 18px; display: flex; align-items: center; gap: 10px;">
                            üìä Distribui√ß√£o por Disciplina
                        </h3>
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartPizza"></canvas>
                        </div>
                    </div>

                    <!-- Gr√°fico de Linha - Progresso ao Longo do Tempo -->
                    <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 16px; border: 2px solid var(--border);">
                        <h3 style="margin-bottom: 15px; color: var(--text-primary); font-size: 18px; display: flex; align-items: center; gap: 10px;">
                            üìà Evolu√ß√£o do Progresso
                        </h3>
                        <div style="position: relative; height: 350px;">
                            <canvas id="chartLinha"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Countdown Timer -->
                <div id="examCountdown" style="background: var(--bg-tertiary); padding: 25px; border-radius: 16px; text-align: center; margin-bottom: 30px; border: 2px solid var(--border);">
                    <div style="font-size: 18px; color: var(--text-secondary); margin-bottom: 10px;">‚è≥ Tempo at√© a prova:</div>
                    <div style="font-size: 42px; font-weight: 700; color: var(--accent-primary);" id="diasRestantes">--</div>
                    <div style="font-size: 16px; color: var(--text-secondary); margin-top: 10px;">
                        <span id="ritmoEstudo">Defina a data da prova em "An√°lise de Edital"</span>
                    </div>
                </div>

                <!-- Progresso por Mat√©ria -->
                <div id="progressoPorMateria">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">üìà Progresso por Mat√©ria</h3>
                    <div id="materiasProgressList">
                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                            Nenhum conte√∫do program√°tico processado ainda.<br>
                            <a href="#" onclick="switchTab('edital'); return false;" style="color: var(--accent-primary); text-decoration: underline;">V√° para "An√°lise de Edital"</a> e processe o conte√∫do program√°tico.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: AN√ÅLISE DE EDITAL -->
        <div id="edital" class="tab-content">
            <div class="card">
                <h2>Analisar Edital</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Arraste um PDF do edital ou cole o texto diretamente. O sistema ir√° analisar e extrair informa√ß√µes importantes.
                </p>

                <!-- PDF Upload Area (COMPACTO) -->
                <div id="pdfDropArea" style="border: 2px dashed var(--border); border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; background: var(--bg-tertiary); cursor: pointer; transition: all 0.3s ease; min-height: 80px; display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <div style="font-size: 32px;">üìÑ</div>
                    <div>
                        <p style="color: var(--text-primary); font-weight: 600; margin: 0;">Arraste o PDF aqui</p>
                        <p style="color: var(--text-secondary); font-size: 13px; margin: 0;">ou clique para selecionar</p>
                    </div>
                    <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
                </div>

                <div style="text-align: center; color: var(--text-secondary); margin: 15px 0; font-size: 13px;">
                    ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ OU ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                </div>

                <!-- Campo √∫nico para texto (mostra PDF extra√≠do aqui tamb√©m) -->
                <div class="input-group">
                    <label>Texto do Edital</label>
                    <textarea id="editalInput" placeholder="Cole o texto completo do edital aqui. Ap√≥s arrastar o PDF, o texto aparecer√° automaticamente neste campo." style="min-height: 250px;"></textarea>
                </div>

                <!-- Bot√£o Analisar PRIMEIRO (tamanho normal) -->
                <button class="btn" id="analyzeEdital" style="font-size: 16px; padding: 12px 24px; margin-bottom: 20px;">
                    üîç Analisar Edital
                </button>

                <!-- Resultado: Disciplinas em lista vertical -->
                <div id="disciplinasExtraidas" style="display: none; margin-bottom: 20px;">
                    <h3 style="color: var(--text-primary); margin-bottom: 15px;">üìö Disciplinas Identificadas</h3>
                    <div id="listaDisciplinas" style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; border: 2px solid var(--border);">
                        <!-- Lista ser√° preenchida aqui -->
                    </div>
                </div>

                <!-- Conte√∫do Program√°tico (preenchido automaticamente pela an√°lise) -->
                <div class="input-group">
                    <label>üìã Conte√∫do Program√°tico</label>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Ap√≥s analisar, o sistema preenche automaticamente. Uma mat√©ria por linha com seus t√≥picos.<br>
                        <strong>Exemplo:</strong> Portugu√™s: Concord√¢ncia verbal, Ortografia, Interpreta√ß√£o de textos
                    </p>
                    <textarea id="conteudoProgramatico" placeholder="Ser√° preenchido automaticamente ap√≥s a an√°lise..." style="min-height: 150px;"></textarea>
                </div>

                <!-- Bot√µes simplificados -->
                <div style="display: flex; gap: 10px; margin-top: 15px; align-items: center;">
                    <button class="btn" id="processarConteudo" style="flex: 2;">
                        ‚úÖ Processar Conte√∫do
                    </button>
                    <button class="btn btn-secondary" onclick="limparConteudoProgramatico()" style="flex: 1;">
                        üóëÔ∏è Limpar
                    </button>
                    <div style="flex: 2; display: flex; align-items: center; gap: 10px;">
                        <label style="color: var(--text-secondary); font-size: 13px; white-space: nowrap;">Velocidade:</label>
                        <input type="range" id="analysisSpeed" min="0.5" max="4" step="0.1" value="1" style="flex: 1;" oninput="document.getElementById('speedValue').textContent = this.value + 'x'">
                        <span id="speedValue" style="color: var(--text-primary); font-weight: 600; min-width: 45px;">1.0x</span>
                        <button class="btn btn-secondary" onclick="ouvirAnalise()" style="padding: 10px 20px;">
                            üéß Ouvir
                        </button>
                    </div>
                </div>

                <div id="editalOutput" style="margin-top: 20px;"></div>
            </div>

            <div class="card">
                <h2>An√°lises Salvas</h2>
                <div id="savedEditalList"></div>
            </div>
        </div>

        <!-- TAB: CRONOGRAMA -->
        <div id="cronograma" class="tab-content">
            <!-- ETAPA 1: An√°lise Inteligente do Edital -->
            <div class="card" id="cronogramaEtapa1">
                <h2>üî¨ An√°lise Inteligente do Edital com IA</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Cole o texto bruto do edital abaixo. A IA ir√° extrair automaticamente todas as disciplinas, conte√∫dos detalhados e criar um raio-X completo do concurso.
                </p>

                <!-- Informa√ß√µes B√°sicas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div class="input-group">
                        <label>üéØ Cargo / Concurso</label>
                        <input type="text" id="cronoCargo" placeholder="Ex: Analista Judici√°rio - TRT SP">
                    </div>
                    <div class="input-group">
                        <label>‚è∞ Horas/dia dispon√≠veis</label>
                        <input type="number" id="cronoHorasDia" value="4" min="1" max="16">
                    </div>
                    <div class="input-group">
                        <label>üìö Seu n√≠vel atual</label>
                        <select id="cronoNivel">
                            <option value="iniciante">Iniciante</option>
                            <option value="intermediario" selected>Intermedi√°rio</option>
                            <option value="avancado">Avan√ßado</option>
                        </select>
                    </div>
                </div>

                <!-- √Årea de Upload de PDF -->
                <div class="input-group">
                    <label>üìÑ Envie o edital em PDF ou cole o texto</label>

                    <!-- Drag & Drop Zone -->
                    <div
                        id="cronoPdfDropZone"
                        style="
                            border: 2px dashed var(--border);
                            border-radius: 12px;
                            padding: 30px;
                            text-align: center;
                            background: var(--bg-secondary);
                            cursor: pointer;
                            transition: all 0.3s ease;
                            margin-bottom: 15px;
                        "
                        onclick="document.getElementById('cronoPdfFileInput').click()"
                    >
                        <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                            Arraste o PDF do edital aqui
                        </div>
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
                            ou clique para selecionar o arquivo
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            Formatos aceitos: PDF
                        </div>
                    </div>

                    <!-- Input file oculto -->
                    <input
                        type="file"
                        id="cronoPdfFileInput"
                        accept=".pdf,application/pdf"
                        style="display: none;"
                    >

                    <!-- Ou separador -->
                    <div style="display: flex; align-items: center; gap: 10px; margin: 20px 0;">
                        <div style="flex: 1; height: 1px; background: var(--border);"></div>
                        <div style="color: var(--text-secondary); font-size: 13px; font-weight: 500;">OU</div>
                        <div style="flex: 1; height: 1px; background: var(--border);"></div>
                    </div>

                    <!-- √Årea de texto -->
                    <textarea
                        id="cronoEditalBruto"
                        placeholder="Cole aqui o texto completo do edital (conte√∫do program√°tico)..."
                        style="min-height: 200px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; line-height: 1.6;"
                    ></textarea>

                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">
                        üí° <strong>Dica:</strong> Envie o PDF ou cole o texto. O sistema extrai automaticamente: disciplinas, t√≥picos, data da prova e todas as informa√ß√µes!
                    </div>
                </div>

                <button class="btn" id="btnAnalisarEdital" style="font-size: 18px; padding: 15px 30px;">
                    üöÄ Analisar Edital
                </button>

                <!-- Loading State -->
                <div id="cronoLoadingAnalise" style="display: none; margin-top: 20px; text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="color: var(--text-secondary); margin-top: 15px;">
                        <span style="font-size: 15px;">Analisando edital...</span><br>
                        <span style="font-size: 13px;" id="cronoLoadingSubtext">Extraindo disciplinas e t√≥picos</span>
                    </p>
                </div>

                <!-- Resultado da An√°lise (RAIO-X) -->
                <div id="cronoRaioX" style="display: none; margin-top: 30px;">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>

            <!-- ETAPA 2: Ciclos Semanais Edit√°veis (aparece ap√≥s an√°lise) -->
            <div class="card" id="cronogramaEtapa2" style="display: none;">
                <h2>üìÖ Ciclos Semanais de Estudo</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Distribui√ß√£o autom√°tica considerando: <strong>volume</strong>, <strong>incid√™ncia</strong>, <strong>complexidade</strong> e <strong>seu dom√≠nio</strong>. Totalmente edit√°vel!
                </p>

                <div id="cronoCiclosSemanais">
                    <!-- Ser√° preenchido com tabela de ciclos semanais -->
                </div>

                <button class="btn" id="btnGerarCalendario" style="margin-top: 20px;">
                    üìÜ Gerar Calend√°rio Mensal
                </button>
            </div>

            <!-- ETAPA 3: Calend√°rio Visual + YouTube Links (aparece ap√≥s ciclos) -->
            <div class="card" id="cronogramaEtapa3" style="display: none;">
                <h2>üìÜ Calend√°rio Mensal de Estudos</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Visualiza√ß√£o mensal com links do YouTube para cada t√≥pico. Acompanhe horas planejadas vs. realizadas.
                </p>

                <div id="cronoCalendarioMensal">
                    <!-- Calend√°rio visual ser√° renderizado aqui -->
                </div>
            </div>
        </div>

        <!-- TAB: POMODORO -->
        <div id="pomodoro" class="tab-content">
            <div class="card">
                <h2>Timer Pomodoro</h2>
                <div class="timer-display mono" id="timerDisplay">25:00</div>

                <div class="btn-group">
                    <button class="btn" id="startTimer">‚ñ∂Ô∏è Iniciar</button>
                    <button class="btn btn-secondary" id="pauseTimer">‚è∏Ô∏è Pausar</button>
                    <button class="btn btn-secondary" id="resetTimer">üîÑ Resetar</button>
                </div>

                <div class="input-group">
                    <label>Tempo de Foco (minutos)</label>
                    <input type="number" id="focusTime" value="25" min="1" max="60">
                </div>

                <div class="input-group">
                    <label>Tempo de Pausa (minutos)</label>
                    <input type="number" id="breakTime" value="5" min="1" max="30">
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="sessionProgress" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="card">
                <h2>Meta Di√°ria</h2>
                <div class="input-group">
                    <label>Pomodoros hoje: <span class="mono" id="todayPomodoros">0</span> / <span id="goalDisplay">8</span></label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="goalProgress" style="width: 0%">0%</div>
                    </div>
                </div>
                <div class="input-group">
                    <label>Meta di√°ria de Pomodoros</label>
                    <input type="number" id="dailyGoal" value="8" min="1" max="20">
                </div>
            </div>
        </div>

        <!-- TAB: LEITOR DE TEXTO -->
        <div id="leitor" class="tab-content">
            <div class="card">
                <h2>üéß Leitor de Texto (Text-to-Speech)</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Converta textos de PDFs ou anota√ß√µes em √°udio para estudar em qualquer lugar. Ajuste a velocidade para otimizar seu tempo de estudo!
                </p>

                <div class="input-group">
                    <label>Texto para Leitura</label>
                    <textarea id="textToRead" placeholder="Cole aqui o texto do PDF, edital ou suas anota√ß√µes..." style="min-height: 200px;"></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn" id="startReading">‚ñ∂Ô∏è Ler Texto</button>
                    <button class="btn btn-secondary" id="pauseReading">‚è∏Ô∏è Pausar</button>
                    <button class="btn btn-secondary" id="stopReading">‚èπÔ∏è Parar</button>
                </div>

                <div class="input-group" style="margin-top: 30px;">
                    <label>Voz:</label>
                    <select id="voiceSelect" style="width: 100%; margin-bottom: 15px;">
                        <option value="">Voz padr√£o do sistema</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>üìñ Dicion√°rio de Pron√∫ncia Personalizado</label>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
                        Ensine a pron√∫ncia correta de palavras. Formato: <code style="background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">palavra errada -> palavra correta</code> (uma por linha)
                    </p>
                    <textarea id="pronunciationDict" placeholder="Exemplos:&#10;pomodoro -> pom√¥doro&#10;flashcard -> fl√©chicarde&#10;burnout -> b√©rn√°ute" style="width: 100%; min-height: 100px; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-secondary); color: var(--text-primary); font-family: 'IBM Plex Mono', monospace; font-size: 13px; resize: vertical;"></textarea>
                </div>

                <div class="input-group">
                    <label>Velocidade de Leitura: <span id="speedLabel" class="mono" style="color: var(--accent-primary);">1.0x</span></label>
                    <input type="range" id="readingSpeed" min="0.5" max="6" step="0.1" value="1" style="width: 100%;">
                    <div style="display: flex; justify-content: space-between; margin-top: 5px; color: var(--text-secondary); font-size: 12px;">
                        <span>0.5x</span>
                        <span>1.5x</span>
                        <span>3.0x</span>
                        <span>4.5x</span>
                        <span>6.0x</span>
                    </div>
                </div>

                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 8px; margin-top: 20px; color: white;">
                    <h3 style="margin-bottom: 10px;">üí° Dicas para Otimizar o Estudo</h3>
                    <ul style="line-height: 1.8; margin-left: 20px;">
                        <li><strong>Velocidade 0.5x-0.8x:</strong> Ideal para conte√∫dos dif√≠ceis ou primeira leitura</li>
                        <li><strong>Velocidade 1.0x:</strong> Velocidade normal de conversa√ß√£o</li>
                        <li><strong>Velocidade 1.5x-2.0x:</strong> √ìtimo para revis√µes e economizar tempo</li>
                        <li><strong>Use fones Bluetooth:</strong> Estude enquanto caminha, dirige ou faz exerc√≠cios</li>
                        <li><strong>Divida textos longos:</strong> Processe em partes para melhor absor√ß√£o</li>
                    </ul>
                </div>

                <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid var(--accent-warm);">
                    <p style="color: var(--text-secondary); margin: 0;">
                        <strong style="color: var(--accent-warm);">‚ö†Ô∏è Nota:</strong> A s√≠ntese de voz √© processada pelo navegador (offline). A qualidade e as vozes dispon√≠veis dependem do seu sistema operacional e navegador.
                    </p>
                </div>
            </div>
        </div>

        <!-- TAB: FLASHCARDS -->
        <div id="flashcards" class="tab-content">
            <div class="card">
                <h2>Adicionar Flashcard</h2>
                <div class="input-group">
                    <label>Mat√©ria</label>
                    <input type="text" id="flashcardSubject" placeholder="Ex: Direito Constitucional">
                </div>
                <div class="input-group">
                    <label>Pergunta</label>
                    <textarea id="flashcardQuestion" placeholder="Digite a pergunta..."></textarea>
                </div>
                <div class="input-group">
                    <label>Resposta</label>
                    <textarea id="flashcardAnswer" placeholder="Digite a resposta..."></textarea>
                </div>
                <button class="btn" id="addFlashcard">‚ûï Adicionar Flashcard</button>
            </div>

            <div class="card">
                <h2>Revisar Flashcards</h2>
                <div id="flashcardReview"></div>
            </div>

            <div class="card">
                <h2>Meus Flashcards</h2>
                <div id="flashcardList"></div>
            </div>
        </div>

        <!-- TAB: SIMULADO -->
        <div id="simulado" class="tab-content">
            <div class="card">
                <h2>Adicionar Quest√£o</h2>
                <div class="input-group">
                    <label>Mat√©ria</label>
                    <input type="text" id="questionSubject" placeholder="Ex: Portugu√™s">
                </div>
                <div class="input-group">
                    <label>Enunciado</label>
                    <textarea id="questionText" placeholder="Digite o enunciado da quest√£o..."></textarea>
                </div>
                <div class="input-group">
                    <label>Op√ß√£o A</label>
                    <input type="text" id="optionA" placeholder="Op√ß√£o A">
                </div>
                <div class="input-group">
                    <label>Op√ß√£o B</label>
                    <input type="text" id="optionB" placeholder="Op√ß√£o B">
                </div>
                <div class="input-group">
                    <label>Op√ß√£o C</label>
                    <input type="text" id="optionC" placeholder="Op√ß√£o C">
                </div>
                <div class="input-group">
                    <label>Op√ß√£o D</label>
                    <input type="text" id="optionD" placeholder="Op√ß√£o D">
                </div>
                <div class="input-group">
                    <label>Resposta Correta</label>
                    <select id="correctAnswer">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                    </select>
                </div>
                <button class="btn" id="addQuestion">‚ûï Adicionar Quest√£o</button>
            </div>

            <div class="card">
                <h2>Realizar Simulado</h2>
                <div id="simuladoArea"></div>
            </div>
        </div>

        <!-- TAB: ESTAT√çSTICAS -->
        <div id="estatisticas" class="tab-content">
            <div class="card">
                <h2>Suas Estat√≠sticas</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total de Pomodoros</div>
                        <div class="stat-value" id="totalPomodoros">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Tempo Total de Estudo</div>
                        <div class="stat-value" id="totalStudyTime">0h</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Flashcards Criados</div>
                        <div class="stat-value" id="totalFlashcards">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Quest√µes Criadas</div>
                        <div class="stat-value" id="totalQuestions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Simulados Realizados</div>
                        <div class="stat-value" id="totalSimulados">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Taxa de Acerto</div>
                        <div class="stat-value" id="accuracyRate">0%</div>
                    </div>
                </div>

                <!-- HIST√ìRICO DE MEDALHAS CONQUISTADAS -->
                <div id="medalhasHistoricoSection" style="margin-top: 40px; display: none;">
                    <h3 style="margin-bottom: 20px; color: var(--text-primary);">üèÜ Hist√≥rico de Medalhas Conquistadas</h3>
                    <div id="medalhasHistoricoContent"></div>
                </div>

                <button class="btn btn-danger" id="clearData" style="margin-top: 20px;">üóëÔ∏è Limpar Todos os Dados</button>
            </div>
        </div>

        <!-- TAB: AJUDA/INSTALA√á√ÉO -->
        <div id="ajuda" class="tab-content">
            <div class="card">
                <h2>üì≤ Como Instalar o App no Celular</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    Transforme o VINE CONCURSOS IA em um app nativo! Siga os passos abaixo de acordo com seu dispositivo:
                </p>

                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">ü§ñ Android (Chrome)</h3>
                    <ol style="line-height: 2; color: var(--text-primary);">
                        <li>Abra este site no <strong>Google Chrome</strong></li>
                        <li>Toque no menu <strong>‚ãÆ</strong> (tr√™s pontos) no canto superior direito</li>
                        <li>Selecione <strong>"Adicionar √† tela inicial"</strong> ou <strong>"Instalar app"</strong></li>
                        <li>Confirme tocando em <strong>"Adicionar"</strong></li>
                        <li>‚úÖ Pronto! O √≠cone aparecer√° na sua tela inicial</li>
                    </ol>
                </div>

                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üçé iOS (iPhone/iPad)</h3>
                    <ol style="line-height: 2; color: var(--text-primary);">
                        <li>Abra este site no <strong>Safari</strong></li>
                        <li>Toque no bot√£o <strong>Compartilhar</strong> ‚¨ÜÔ∏è (na barra inferior)</li>
                        <li>Role para baixo e toque em <strong>"Adicionar √† Tela de In√≠cio"</strong></li>
                        <li>Edite o nome se quiser e toque em <strong>"Adicionar"</strong></li>
                        <li>‚úÖ Pronto! O app estar√° dispon√≠vel como qualquer outro</li>
                    </ol>
                </div>

                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 8px; margin: 20px 0; color: white;">
                    <h3 style="margin-bottom: 15px;">‚ú® Vantagens do App Instalado</h3>
                    <ul style="line-height: 2;">
                        <li>üöÄ <strong>Acesso r√°pido</strong> - √çcone na tela inicial</li>
                        <li>üì¥ <strong>Funciona offline</strong> - Use sem internet</li>
                        <li>üíæ <strong>Dados salvos</strong> - Tudo persiste localmente</li>
                        <li>üì± <strong>Tela cheia</strong> - Sem barra do navegador</li>
                        <li>‚ö° <strong>Mais r√°pido</strong> - Carregamento instant√¢neo</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h2>ü§ñ Recursos com IA</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    As funcionalidades de <strong>An√°lise de Edital</strong> e <strong>Gera√ß√£o de Cronograma</strong> usam Intelig√™ncia Artificial.
                </p>
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                    <h4 style="color: var(--accent-primary); margin-bottom: 10px;">üìã Para usar a IA:</h4>
                    <ol style="line-height: 2; color: var(--text-primary);">
                        <li>Publique este app no <a href="https://poe.com" target="_blank" style="color: var(--accent-primary);">Poe.com</a> (gratuito)</li>
                        <li>A IA funcionar√° automaticamente quando acessado via Poe</li>
                        <li>Ou use as outras funcionalidades offline (Pomodoro, Flashcards, Simulados)</li>
                    </ol>
                </div>
            </div>

            <div class="card">
                <h2>üí° Compartilhar com Amigos</h2>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    Quer compartilhar o VINE CONCURSOS IA com seus colegas de estudos?
                </p>
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                    <p style="line-height: 1.8; color: var(--text-primary); margin-bottom: 15px;">
                        <strong>Op√ß√£o 1:</strong> Hospede gratuitamente em <a href="https://netlify.com/drop" target="_blank" style="color: var(--accent-primary);">Netlify</a> ou <a href="https://vercel.com" target="_blank" style="color: var(--accent-primary);">Vercel</a>
                        <br>Voc√™ ter√° um link permanente para compartilhar: <code style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px;">https://vine-concursos.netlify.app</code>
                    </p>
                    <p style="line-height: 1.8; color: var(--text-primary);">
                        <strong>Op√ß√£o 2:</strong> Publique no Poe.com como Canvas App
                        <br>Todos que tiverem conta Poe poder√£o usar com IA integrada!
                    </p>
                </div>
            </div>

            <div class="card">
                <h2>‚ÑπÔ∏è Informa√ß√µes do Sistema</h2>
                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">Status do PWA</div>
                        <div class="stat-value" id="pwaStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Armazenamento</div>
                        <div class="stat-value" id="storageStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Service Worker</div>
                        <div class="stat-value" id="swStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">API Poe</div>
                        <div class="stat-value" id="poeStatus" style="font-size: 24px;">‚ùì</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: CONFIGURA√á√ïES -->
        <div id="config" class="tab-content">
            <div class="card">
                <h2>‚öôÔ∏è Configura√ß√µes da IA</h2>
                <p style="color: var(--text-secondary); margin-bottom: 25px;">
                    Configure a integra√ß√£o com Google Gemini para an√°lises mais potentes e independentes.
                </p>

                <!-- Status da API -->
                <div id="geminiStatus" style="padding: 15px; border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; gap: 12px; background: var(--bg-tertiary); border: 2px solid var(--border);">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div>
                        <strong style="color: var(--text-primary);">Google Gemini API n√£o configurada</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-secondary);">Configure sua API Key abaixo para desbloquear recursos avan√ßados</p>
                    </div>
                </div>

                <!-- Configura√ß√£o da API Key -->
                <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px; border: 1px solid var(--border);">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">üîë API Key do Google Gemini</h3>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Sua API Key:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="password" id="geminiApiKey" placeholder="Cole sua API Key aqui (ex: AIzaSy...)" style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-family: 'IBM Plex Mono', monospace; font-size: 14px;">
                            <button onclick="toggleApiKeyVisibility()" style="padding: 12px 20px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; color: var(--text-primary); font-size: 14px;">
                                üëÅÔ∏è Mostrar
                            </button>
                        </div>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                            ‚ö†Ô∏è Sua API Key fica salva apenas no seu navegador. Nunca compartilhe com terceiros.
                        </p>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">Modelo:</label>
                        <select id="geminiModel" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary); font-size: 14px; cursor: pointer;">
                            <option value="gemini-1.5-flash">‚ö° Gemini 1.5 Flash (R√°pido e Barato - Recomendado)</option>
                            <option value="gemini-1.5-pro">üß† Gemini 1.5 Pro (Mais Poderoso)</option>
                            <option value="gemini-2.0-flash-exp">üöÄ Gemini 2.0 Flash Experimental (Novo)</option>
                        </select>
                        <p style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                            üí° Flash 1.5 √© ideal para an√°lise de editais: 1M tokens de contexto, super r√°pido e econ√¥mico
                        </p>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button onclick="salvarConfigGemini()" style="flex: 1; padding: 14px; background: var(--accent-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            üíæ Salvar Configura√ß√£o
                        </button>
                        <button onclick="testarApiGemini()" style="flex: 1; padding: 14px; background: var(--accent-secondary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 15px; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            üß™ Testar Conex√£o
                        </button>
                        <button onclick="limparConfigGemini()" style="padding: 14px 20px; background: var(--danger); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>

                <!-- Como obter API Key -->
                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 25px; border-radius: 12px; margin-top: 25px; color: white;">
                    <h3 style="margin-bottom: 15px;">üìñ Como obter sua API Key GRATUITA</h3>
                    <ol style="line-height: 2;">
                        <li>Acesse <a href="https://aistudio.google.com/apikey" target="_blank" style="color: white; text-decoration: underline; font-weight: 600;">Google AI Studio</a></li>
                        <li>Fa√ßa login com sua conta Google</li>
                        <li>Clique em <strong>"Get API Key"</strong> ou <strong>"Create API Key"</strong></li>
                        <li>Copie a chave gerada (come√ßa com "AIza...")</li>
                        <li>Cole aqui em cima e clique em <strong>"Salvar Configura√ß√£o"</strong></li>
                        <li>‚úÖ Pronto! Teste a conex√£o e comece a usar</li>
                    </ol>
                    <p style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; font-size: 14px;">
                        <strong>üí∞ Totalmente Gratuito:</strong> Google oferece uma cota generosa gratuita mensalmente. Perfeito para an√°lise de editais!
                    </p>
                </div>

                <!-- Recursos dispon√≠veis -->
                <div style="background: var(--bg-tertiary); padding: 25px; border-radius: 12px; margin-top: 25px; border: 1px solid var(--border);">
                    <h3 style="color: var(--accent-primary); margin-bottom: 15px;">‚ú® Recursos com Gemini API</h3>
                    <div style="display: grid; gap: 15px;">
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">üìö</span>
                            <div>
                                <strong style="color: var(--text-primary);">An√°lise de Editais Completos</strong>
                                <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 14px;">1 milh√£o de tokens = editais gigantescos sem cortes</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">üîç</span>
                            <div>
                                <strong style="color: var(--text-primary);">Busca na Web Integrada</strong>
                                <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 14px;">Pesquisa quest√µes, concursos e conte√∫dos atualizados</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">‚ö°</span>
                            <div>
                                <strong style="color: var(--text-primary);">Super R√°pido</strong>
                                <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 14px;">Flash mode: respostas em segundos</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">üîí</span>
                            <div>
                                <strong style="color: var(--text-primary);">100% Privado</strong>
                                <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 14px;">Tudo funciona direto no seu navegador</p>
                            </div>
                        </div>
                        <div style="display: flex; align-items: start; gap: 12px;">
                            <span style="font-size: 24px;">üéØ</span>
                            <div>
                                <strong style="color: var(--text-primary);">Independente do Poe</strong>
                                <p style="color: var(--text-secondary); margin: 5px 0 0 0; font-size: 14px;">Funciona em qualquer lugar: localhost, Netlify, Vercel, etc.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal" id="confirmModal">
        <div class="modal-content">
            <h3 id="modalTitle">Confirmar a√ß√£o</h3>
            <p id="modalMessage">Tem certeza que deseja continuar?</p>
            <div class="btn-group">
                <button class="btn btn-secondary" id="modalCancel">Cancelar</button>
                <button class="btn btn-danger" id="modalConfirm">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        // Detect color scheme
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.remove('light');
        } else {
            document.documentElement.classList.add('light');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.remove('light');
            } else {
                document.documentElement.classList.add('light');
            }
        });

        // Data Management - Hybrid storage (memory + localStorage when available)
        const memoryStore = {};
        let useLocalStorage = false;

        // Check if localStorage is available
        try {
            const testKey = '__storage_test__';
            window.localStorage.setItem(testKey, 'test');
            window.localStorage.removeItem(testKey);
            useLocalStorage = true;
            console.log('‚úÖ localStorage dispon√≠vel - dados ser√£o persistidos');
        } catch (e) {
            console.log('‚ö†Ô∏è localStorage n√£o dispon√≠vel - usando mem√≥ria tempor√°ria');
        }

        const Storage = {
            get(key, defaultValue = null) {
                if (useLocalStorage) {
                    try {
                        const data = window.localStorage.getItem('vine_' + key);
                        return data ? JSON.parse(data) : defaultValue;
                    } catch (e) {
                        return memoryStore[key] !== undefined ? memoryStore[key] : defaultValue;
                    }
                }
                return memoryStore[key] !== undefined ? memoryStore[key] : defaultValue;
            },
            set(key, value) {
                memoryStore[key] = value;
                if (useLocalStorage) {
                    try {
                        window.localStorage.setItem('vine_' + key, JSON.stringify(value));
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            },
            remove(key) {
                delete memoryStore[key];
                if (useLocalStorage) {
                    try {
                        window.localStorage.removeItem('vine_' + key);
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            },
            clear() {
                Object.keys(memoryStore).forEach(key => delete memoryStore[key]);
                if (useLocalStorage) {
                    try {
                        Object.keys(window.localStorage).forEach(key => {
                            if (key.startsWith('vine_')) {
                                window.localStorage.removeItem(key);
                            }
                        });
                    } catch (e) {
                        console.error('Storage error:', e);
                    }
                }
            }
        };

        // Theme Switching
        const themeSelector = document.getElementById('themeSelector');
        const body = document.body;

        // Load saved theme or default to 'dark'
        const savedTheme = Storage.get('theme', 'dark');
        body.className = savedTheme;
        themeSelector.value = savedTheme;

        // Theme change listener
        themeSelector.addEventListener('change', (e) => {
            const theme = e.target.value;
            body.className = theme;
            Storage.set('theme', theme);
            console.log('Tema alterado para:', theme);
        });

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        // POMODORO TIMER
        let timerInterval = null;
        let timeLeft = 25 * 60;
        let totalTime = 25 * 60;
        let isBreak = false;
        let pomodorosToday = Storage.get('pomodorosToday', { date: new Date().toDateString(), count: 0 });

        // Reset counter if new day
        if (pomodorosToday.date !== new Date().toDateString()) {
            pomodorosToday = { date: new Date().toDateString(), count: 0 };
            Storage.set('pomodorosToday', pomodorosToday);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent =
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            const progress = ((totalTime - timeLeft) / totalTime) * 100;
            const progressBar = document.getElementById('sessionProgress');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
        }

        function startTimer() {
            if (timerInterval) return;

            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;

                    if (!isBreak) {
                        // Pomodoro completed
                        pomodorosToday.count++;
                        Storage.set('pomodorosToday', pomodorosToday);
                        updatePomodoroStats();

                        // Increment total pomodoros
                        const stats = Storage.get('stats', {});
                        stats.totalPomodoros = (stats.totalPomodoros || 0) + 1;
                        stats.totalStudyTime = (stats.totalStudyTime || 0) + parseInt(document.getElementById('focusTime').value);
                        Storage.set('stats', stats);

                        showNotification('‚úÖ Pomodoro conclu√≠do! Hora de uma pausa.');

                        // Switch to break
                        isBreak = true;
                        const breakMinutes = parseInt(document.getElementById('breakTime').value);
                        timeLeft = breakMinutes * 60;
                        totalTime = breakMinutes * 60;
                    } else {
                        showNotification('üéØ Pausa conclu√≠da! Pronto para mais um Pomodoro?');
                        isBreak = false;
                        resetTimer();
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function resetTimer() {
            pauseTimer();
            isBreak = false;
            const focusMinutes = parseInt(document.getElementById('focusTime').value);
            timeLeft = focusMinutes * 60;
            totalTime = focusMinutes * 60;
            updateTimerDisplay();
        }

        function updatePomodoroStats() {
            const goal = parseInt(document.getElementById('dailyGoal').value);
            document.getElementById('todayPomodoros').textContent = pomodorosToday.count;
            document.getElementById('goalDisplay').textContent = goal;

            const progress = Math.min((pomodorosToday.count / goal) * 100, 100);
            const progressBar = document.getElementById('goalProgress');
            progressBar.style.width = `${progress}%`;
            progressBar.textContent = `${Math.round(progress)}%`;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'result-message result-success';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '2000';
            notification.style.maxWidth = '500px';
            document.body.appendChild(notification);

            setTimeout(() => notification.remove(), 3000);
        }

        // ========== GOOGLE GEMINI API FUNCTIONS ==========

        // Toggle visibilidade da API Key
        function toggleApiKeyVisibility() {
            const input = document.getElementById('geminiApiKey');
            const button = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà Ocultar';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è Mostrar';
            }
        }

        // Salvar configura√ß√£o do Gemini
        function salvarConfigGemini() {
            const apiKey = document.getElementById('geminiApiKey').value.trim();
            const model = document.getElementById('geminiModel').value;

            if (!apiKey) {
                showNotification('‚ö†Ô∏è Por favor, insira uma API Key v√°lida');
                return;
            }

            if (!apiKey.startsWith('AIza')) {
                showNotification('‚ö†Ô∏è API Key do Gemini deve come√ßar com "AIza"');
                return;
            }

            // Salvar no localStorage
            Storage.set('geminiConfig', {
                apiKey: apiKey,
                model: model,
                savedAt: new Date().toISOString()
            });

            atualizarStatusGemini();
            showNotification('‚úÖ Configura√ß√£o do Gemini salva com sucesso!');
        }

        // Limpar configura√ß√£o
        function limparConfigGemini() {
            showConfirmDialog(
                'Tem certeza que deseja remover a configura√ß√£o do Gemini?',
                () => {
                    Storage.remove('geminiConfig');
                    document.getElementById('geminiApiKey').value = '';
                    document.getElementById('geminiModel').value = 'gemini-1.5-flash';
                    atualizarStatusGemini();
                    showNotification('üóëÔ∏è Configura√ß√£o do Gemini removida');
                }
            );
        }

        // Atualizar status visual
        function atualizarStatusGemini() {
            const config = Storage.get('geminiConfig', null);
            const statusDiv = document.getElementById('geminiStatus');

            // Se o elemento n√£o existe ainda, n√£o fazer nada
            if (!statusDiv) {
                console.log('‚ö†Ô∏è Elemento geminiStatus n√£o encontrado');
                return;
            }

            if (config && config.apiKey) {
                statusDiv.innerHTML = `
                    <span style="font-size: 24px;">‚úÖ</span>
                    <div>
                        <strong style="color: var(--success);">Google Gemini API configurada</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-secondary);">
                            Modelo: ${config.model.replace('gemini-', '').replace('-latest', '')} |
                            Salvo em: ${new Date(config.savedAt).toLocaleString('pt-BR')}
                        </p>
                    </div>
                `;
                statusDiv.style.background = 'linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1))';
                statusDiv.style.borderColor = 'var(--success)';

                // Preencher campos (verificar se existem)
                const apiKeyInput = document.getElementById('geminiApiKey');
                const modelSelect = document.getElementById('geminiModel');
                if (apiKeyInput) apiKeyInput.value = config.apiKey;
                if (modelSelect) modelSelect.value = config.model;
            } else {
                statusDiv.innerHTML = `
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div>
                        <strong style="color: var(--text-primary);">Google Gemini API n√£o configurada</strong>
                        <p style="margin: 5px 0 0 0; font-size: 14px; color: var(--text-secondary);">Configure sua API Key abaixo para desbloquear recursos avan√ßados</p>
                    </div>
                `;
                statusDiv.style.background = 'var(--bg-tertiary)';
                statusDiv.style.borderColor = 'var(--border)';
            }
        }

        // Testar conex√£o com Gemini
        async function testarApiGemini() {
            const config = Storage.get('geminiConfig', null);

            if (!config || !config.apiKey) {
                showNotification('‚ö†Ô∏è Configure a API Key primeiro');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Testando...';
            button.disabled = true;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${config.model}:generateContent?key=${config.apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: 'Responda apenas: OK'
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Erro desconhecido');
                }

                const data = await response.json();
                console.log('Resposta do Gemini:', data);

                showNotification('‚úÖ Conex√£o com Gemini estabelecida com sucesso!');

            } catch (error) {
                console.error('Erro ao testar Gemini:', error);
                showNotification('‚ùå Erro: ' + error.message);
            } finally {
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // Fun√ß√£o para chamar API do Gemini
        async function callGeminiAPI(prompt, options = {}) {
            const config = Storage.get('geminiConfig', null);

            if (!config || !config.apiKey) {
                throw new Error('Gemini API n√£o configurada');
            }

            const model = options.model || config.model;
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${config.apiKey}`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: options.temperature || 0.7,
                        topK: options.topK || 40,
                        topP: options.topP || 0.95,
                        maxOutputTokens: options.maxOutputTokens || 8192,
                    }
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || `HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();

            if (!data.candidates || data.candidates.length === 0) {
                throw new Error('Nenhuma resposta gerada pelo Gemini');
            }

            const text = data.candidates[0].content.parts[0].text;
            return text;
        }

        // ========== FIM GEMINI API FUNCTIONS ==========

        document.getElementById('startTimer').addEventListener('click', startTimer);
        document.getElementById('pauseTimer').addEventListener('click', pauseTimer);
        document.getElementById('resetTimer').addEventListener('click', resetTimer);
        document.getElementById('focusTime').addEventListener('change', resetTimer);
        document.getElementById('breakTime').addEventListener('change', () => {
            if (isBreak) {
                const breakMinutes = parseInt(document.getElementById('breakTime').value);
                timeLeft = breakMinutes * 60;
                totalTime = breakMinutes * 60;
                updateTimerDisplay();
            }
        });
        document.getElementById('dailyGoal').addEventListener('change', updatePomodoroStats);

        updateTimerDisplay();
        updatePomodoroStats();

        // TEXT READER (TTS)
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let isPaused = false;
        let availableVoices = [];

        // GLOBAL: Store extracted topics from edital analysis
        let extractedEditalTopics = {}; // Format: { "Portugu√™s": ["topic1", "topic2"], "Matem√°tica": ["topic3", "topic4"] }

        // Load available voices
        function loadVoices() {
            availableVoices = speechSynthesis.getVoices();
            const voiceSelect = document.getElementById('voiceSelect');
            voiceSelect.innerHTML = '<option value="">Voz padr√£o do sistema</option>';

            // Filter Portuguese voices first, then all voices
            const ptVoices = availableVoices.filter(voice => voice.lang.startsWith('pt'));
            const otherVoices = availableVoices.filter(voice => !voice.lang.startsWith('pt'));

            if (ptVoices.length > 0) {
                const ptGroup = document.createElement('optgroup');
                ptGroup.label = 'üáßüá∑ Vozes em Portugu√™s';
                ptVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    ptGroup.appendChild(option);
                });
                voiceSelect.appendChild(ptGroup);
            }

            if (otherVoices.length > 0) {
                const otherGroup = document.createElement('optgroup');
                otherGroup.label = 'üåç Outras vozes';
                otherVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.name;
                    option.textContent = `${voice.name} (${voice.lang})`;
                    otherGroup.appendChild(option);
                });
                voiceSelect.appendChild(otherGroup);
            }
        }

        // Load voices on page load and when voices change
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        // Function to apply pronunciation dictionary
        function applyPronunciationDict(text) {
            const dictText = document.getElementById('pronunciationDict').value.trim();
            if (!dictText) return text;

            let processedText = text;
            const lines = dictText.split('\n');

            lines.forEach(line => {
                const match = line.match(/(.+?)\s*->\s*(.+)/);
                if (match) {
                    const wrong = match[1].trim();
                    const correct = match[2].trim();
                    // Replace all occurrences (case insensitive)
                    const regex = new RegExp(wrong, 'gi');
                    processedText = processedText.replace(regex, correct);
                }
            });

            return processedText;
        }

        document.getElementById('startReading').addEventListener('click', () => {
            let text = document.getElementById('textToRead').value.trim();

            if (!text) {
                showNotification('‚ö†Ô∏è Digite ou cole um texto primeiro!');
                return;
            }

            // If paused, resume
            if (isPaused && speechSynthesis.paused) {
                speechSynthesis.resume();
                isPaused = false;
                showNotification('‚ñ∂Ô∏è Leitura retomada');
                return;
            }

            // If already speaking, resume
            if (speechSynthesis.speaking) {
                speechSynthesis.resume();
                return;
            }

            // Apply pronunciation dictionary
            text = applyPronunciationDict(text);

            // Create new utterance
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'pt-BR';
            currentUtterance.rate = parseFloat(document.getElementById('readingSpeed').value);

            // Set selected voice
            const selectedVoiceName = document.getElementById('voiceSelect').value;
            if (selectedVoiceName) {
                const selectedVoice = availableVoices.find(voice => voice.name === selectedVoiceName);
                if (selectedVoice) {
                    currentUtterance.voice = selectedVoice;
                }
            }

            currentUtterance.onstart = () => {
                showNotification('üéß Iniciando leitura...');
            };

            currentUtterance.onend = () => {
                showNotification('‚úÖ Leitura conclu√≠da!');
                isPaused = false;
            };

            currentUtterance.onerror = (event) => {
                showNotification('‚ùå Erro na leitura: ' + event.error);
                isPaused = false;
            };

            speechSynthesis.speak(currentUtterance);
        });

        document.getElementById('pauseReading').addEventListener('click', () => {
            if (speechSynthesis.speaking && !speechSynthesis.paused) {
                speechSynthesis.pause();
                isPaused = true;
                showNotification('‚è∏Ô∏è Leitura pausada');
            }
        });

        document.getElementById('stopReading').addEventListener('click', () => {
            if (speechSynthesis.speaking || speechSynthesis.paused) {
                speechSynthesis.cancel();
                isPaused = false;
                showNotification('‚èπÔ∏è Leitura interrompida');
            }
        });

        document.getElementById('readingSpeed').addEventListener('input', (e) => {
            const speed = parseFloat(e.target.value);
            document.getElementById('speedLabel').textContent = speed.toFixed(1) + 'x';

            // Update speed in real-time if speaking
            if (currentUtterance && speechSynthesis.speaking) {
                // Need to restart with new speed
                const text = document.getElementById('textToRead').value.trim();
                const wasPaused = speechSynthesis.paused;

                speechSynthesis.cancel();
                currentUtterance = new SpeechSynthesisUtterance(text);
                currentUtterance.lang = 'pt-BR';
                currentUtterance.rate = speed;

                if (!wasPaused) {
                    speechSynthesis.speak(currentUtterance);
                }
            }
        });

        // FLASHCARDS
        let flashcards = Storage.get('flashcards', []);
        let currentFlashcardIndex = 0;
        let showingAnswer = false;

        function addFlashcard() {
            const subject = document.getElementById('flashcardSubject').value.trim();
            const question = document.getElementById('flashcardQuestion').value.trim();
            const answer = document.getElementById('flashcardAnswer').value.trim();

            if (!subject || !question || !answer) {
                showNotification('‚ö†Ô∏è Preencha todos os campos do flashcard');
                return;
            }

            flashcards.push({ subject, question, answer, id: Date.now() });
            Storage.set('flashcards', flashcards);

            document.getElementById('flashcardSubject').value = '';
            document.getElementById('flashcardQuestion').value = '';
            document.getElementById('flashcardAnswer').value = '';

            renderFlashcards();
            showNotification('‚úÖ Flashcard adicionado com sucesso!');
        }

        function renderFlashcards() {
            const listEl = document.getElementById('flashcardList');

            if (flashcards.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìö</div><p>Nenhum flashcard criado ainda.<br>Adicione seu primeiro flashcard acima!</p></div>';
                document.getElementById('flashcardReview').innerHTML = '<div class="empty-state"><p>Adicione flashcards para come√ßar a revisar</p></div>';
                return;
            }

            listEl.innerHTML = '<div class="flashcard-list">' + flashcards.map((fc, idx) => `
                <div class="flashcard-item">
                    <div class="flashcard-item-content">
                        <strong>${fc.subject}</strong>
                        <div>${fc.question}</div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteFlashcard(${idx})">üóëÔ∏è</button>
                </div>
            `).join('') + '</div>';

            renderFlashcardReview();
        }

        function renderFlashcardReview() {
            const reviewEl = document.getElementById('flashcardReview');

            if (flashcards.length === 0) {
                reviewEl.innerHTML = '<div class="empty-state"><p>Adicione flashcards para come√ßar a revisar</p></div>';
                return;
            }

            const fc = flashcards[currentFlashcardIndex];

            reviewEl.innerHTML = `
                <div class="flashcard" onclick="flipFlashcard()">
                    <div class="flashcard-content">
                        ${showingAnswer ? fc.answer : fc.question}
                    </div>
                    <div class="flashcard-hint">
                        ${showingAnswer ? '(Resposta)' : 'Clique para revelar a resposta'}
                    </div>
                </div>
                <div style="text-align: center; color: var(--text-secondary); margin-bottom: 15px;">
                    <strong>${fc.subject}</strong> - Flashcard ${currentFlashcardIndex + 1} de ${flashcards.length}
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="previousFlashcard()">‚¨ÖÔ∏è Anterior</button>
                    <button class="btn" onclick="nextFlashcard()">Pr√≥ximo ‚û°Ô∏è</button>
                </div>
            `;
        }

        function flipFlashcard() {
            showingAnswer = !showingAnswer;
            renderFlashcardReview();
        }

        function nextFlashcard() {
            showingAnswer = false;
            currentFlashcardIndex = (currentFlashcardIndex + 1) % flashcards.length;
            renderFlashcardReview();
        }

        function previousFlashcard() {
            showingAnswer = false;
            currentFlashcardIndex = (currentFlashcardIndex - 1 + flashcards.length) % flashcards.length;
            renderFlashcardReview();
        }

        function deleteFlashcard(index) {
            showConfirmDialog('Tem certeza que deseja excluir este flashcard?', () => {
                flashcards.splice(index, 1);
                Storage.set('flashcards', flashcards);
                if (currentFlashcardIndex >= flashcards.length) {
                    currentFlashcardIndex = Math.max(0, flashcards.length - 1);
                }
                renderFlashcards();
                showNotification('üóëÔ∏è Flashcard exclu√≠do');
            });
        }

        document.getElementById('addFlashcard').addEventListener('click', addFlashcard);
        renderFlashcards();

        // SIMULADO
        let questions = Storage.get('questions', []);
        let currentSimulado = null;
        let simuladoAnswers = [];

        function addQuestion() {
            const subject = document.getElementById('questionSubject').value.trim();
            const text = document.getElementById('questionText').value.trim();
            const optionA = document.getElementById('optionA').value.trim();
            const optionB = document.getElementById('optionB').value.trim();
            const optionC = document.getElementById('optionC').value.trim();
            const optionD = document.getElementById('optionD').value.trim();
            const correct = document.getElementById('correctAnswer').value;

            if (!subject || !text || !optionA || !optionB || !optionC || !optionD) {
                showNotification('‚ö†Ô∏è Preencha todos os campos da quest√£o');
                return;
            }

            questions.push({
                id: Date.now(),
                subject,
                text,
                options: { A: optionA, B: optionB, C: optionC, D: optionD },
                correct
            });

            Storage.set('questions', questions);

            document.getElementById('questionSubject').value = '';
            document.getElementById('questionText').value = '';
            document.getElementById('optionA').value = '';
            document.getElementById('optionB').value = '';
            document.getElementById('optionC').value = '';
            document.getElementById('optionD').value = '';

            showNotification('‚úÖ Quest√£o adicionada com sucesso!');
            renderSimulado();
        }

        function startSimulado() {
            if (questions.length === 0) {
                showNotification('‚ö†Ô∏è Adicione quest√µes antes de iniciar um simulado');
                return;
            }

            currentSimulado = [...questions].sort(() => Math.random() - 0.5);
            simuladoAnswers = new Array(currentSimulado.length).fill(null);
            renderSimulado();
        }

        function renderSimulado() {
            const simuladoEl = document.getElementById('simuladoArea');

            if (!currentSimulado) {
                if (questions.length === 0) {
                    simuladoEl.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìù</div><p>Nenhuma quest√£o cadastrada.<br>Adicione quest√µes acima para criar um simulado!</p></div>';
                } else {
                    simuladoEl.innerHTML = `
                        <div style="text-align: center;">
                            <p style="margin-bottom: 20px; color: var(--text-secondary);">
                                ${questions.length} quest√£o(√µes) dispon√≠vel(is)
                            </p>
                            <button class="btn" onclick="startSimulado()">üöÄ Iniciar Simulado</button>
                        </div>
                    `;
                }
                return;
            }

            let html = '';
            currentSimulado.forEach((q, idx) => {
                html += `
                    <div class="question-card" id="question-${idx}">
                        <div style="color: var(--accent-secondary); font-weight: 600; margin-bottom: 10px;">
                            ${q.subject} - Quest√£o ${idx + 1}
                        </div>
                        <div class="question-text">${q.text}</div>
                        <div class="options">
                            ${['A', 'B', 'C', 'D'].map(opt => `
                                <div class="option" onclick="selectOption(${idx}, '${opt}')" id="q${idx}-${opt}">
                                    <strong>${opt})</strong> ${q.options[opt]}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            html += '<div class="btn-group"><button class="btn" onclick="finishSimulado()">‚úÖ Finalizar Simulado</button></div>';
            simuladoEl.innerHTML = html;
        }

        function selectOption(questionIdx, option) {
            simuladoAnswers[questionIdx] = option;

            ['A', 'B', 'C', 'D'].forEach(opt => {
                const el = document.getElementById(`q${questionIdx}-${opt}`);
                el.classList.remove('selected');
            });

            document.getElementById(`q${questionIdx}-${option}`).classList.add('selected');
        }

        function finishSimulado() {
            const unanswered = simuladoAnswers.filter(a => a === null).length;

            if (unanswered > 0) {
                showConfirmDialog(
                    `Voc√™ deixou ${unanswered} quest√£o(√µes) sem resposta. Deseja finalizar mesmo assim?`,
                    () => gradeSimulado()
                );
            } else {
                gradeSimulado();
            }
        }

        function gradeSimulado() {
            let correct = 0;

            currentSimulado.forEach((q, idx) => {
                const userAnswer = simuladoAnswers[idx];
                const isCorrect = userAnswer === q.correct;

                if (isCorrect) correct++;

                ['A', 'B', 'C', 'D'].forEach(opt => {
                    const el = document.getElementById(`q${idx}-${opt}`);
                    el.classList.remove('selected');
                    el.style.pointerEvents = 'none';

                    if (opt === q.correct) {
                        el.classList.add('correct');
                    } else if (opt === userAnswer && !isCorrect) {
                        el.classList.add('incorrect');
                    }
                });
            });

            const percentage = Math.round((correct / currentSimulado.length) * 100);

            // Update stats
            const stats = Storage.get('stats', {});
            stats.totalSimulados = (stats.totalSimulados || 0) + 1;
            stats.totalCorrect = (stats.totalCorrect || 0) + correct;
            stats.totalAnswered = (stats.totalAnswered || 0) + currentSimulado.length;
            Storage.set('stats', stats);
            updateStats();

            const resultMessage = document.createElement('div');
            resultMessage.className = 'result-message result-success';
            resultMessage.innerHTML = `
                <strong>Simulado Finalizado!</strong><br>
                Voc√™ acertou ${correct} de ${currentSimulado.length} quest√µes (${percentage}%)
            `;

            document.getElementById('simuladoArea').insertBefore(
                resultMessage,
                document.getElementById('simuladoArea').firstChild
            );

            setTimeout(() => {
                resultMessage.innerHTML += '<br><button class="btn btn-secondary" onclick="resetSimulado()" style="margin-top: 15px;">üîÑ Novo Simulado</button>';
            }, 1000);
        }

        function resetSimulado() {
            currentSimulado = null;
            simuladoAnswers = [];
            renderSimulado();
        }

        document.getElementById('addQuestion').addEventListener('click', addQuestion);
        renderSimulado();

        // STATISTICS
        function updateStats() {
            const stats = Storage.get('stats', {});

            document.getElementById('totalPomodoros').textContent = stats.totalPomodoros || 0;
            document.getElementById('totalStudyTime').textContent =
                Math.round((stats.totalStudyTime || 0) / 60) + 'h';
            document.getElementById('totalFlashcards').textContent = flashcards.length;
            document.getElementById('totalQuestions').textContent = questions.length;
            document.getElementById('totalSimulados').textContent = stats.totalSimulados || 0;

            const accuracy = stats.totalAnswered > 0
                ? Math.round((stats.totalCorrect / stats.totalAnswered) * 100)
                : 0;
            document.getElementById('accuracyRate').textContent = accuracy + '%';
        }

        updateStats();

        // CLEAR DATA
        document.getElementById('clearData').addEventListener('click', () => {
            showConfirmDialog(
                'Tem certeza que deseja apagar TODOS os dados? Esta a√ß√£o n√£o pode ser desfeita!',
                () => {
                    Storage.clear();
                    location.reload();
                }
            );
        });

        // MODAL SYSTEM
        let confirmCallback = null;

        function showConfirmDialog(message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            document.getElementById('modalMessage').textContent = message;
            modal.classList.add('active');
            confirmCallback = onConfirm;
        }

        function showCustomDialog(title, htmlContent) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s;
            `;

            const dialogBox = document.createElement('div');
            dialogBox.style.cssText = `
                background: var(--bg-secondary);
                border-radius: 16px;
                max-width: 650px;
                width: 92%;
                max-height: 80vh;
                overflow: hidden;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            `;

            dialogBox.innerHTML = `
                <div style="padding: 25px; border-bottom: 1px solid var(--border);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; color: var(--text-primary); font-size: 20px;">${title}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='none'">&times;</button>
                    </div>
                </div>
                <div style="padding: 25px;">
                    ${htmlContent}
                </div>
                <div style="padding: 20px 25px; border-top: 1px solid var(--border); text-align: right;">
                    <button onclick="this.closest('.modal').remove()" class="btn" style="background: var(--accent-primary); padding: 10px 24px;">Fechar</button>
                </div>
            `;

            modal.className = 'modal';
            modal.appendChild(dialogBox);
            document.body.appendChild(modal);

            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });

            // Add CSS animations if not already present
            if (!document.getElementById('customDialogStyles')) {
                const style = document.createElement('style');
                style.id = 'customDialogStyles';
                style.textContent = `
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: scale(0.9) translateY(-20px); opacity: 0; }
                        to { transform: scale(1) translateY(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        document.getElementById('modalCancel').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
            confirmCallback = null;
        });

        document.getElementById('modalConfirm').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.remove('active');
            if (confirmCallback) {
                confirmCallback();
                confirmCallback = null;
            }
        });

        // Close modal on background click
        document.getElementById('confirmModal').addEventListener('click', (e) => {
            if (e.target.id === 'confirmModal') {
                document.getElementById('confirmModal').classList.remove('active');
                confirmCallback = null;
            }
        });

        // AN√ÅLISE DE EDITAL COM IA
        let savedEditais = Storage.get('savedEditais', []);

        // Register handlers for Poe Embed API
        if (window.Poe) {
            window.Poe.registerHandler("edital-handler", (result) => {
                const msg = result.responses[0];
                const outputEl = document.getElementById('editalOutput');

                if (msg.status === "error") {
                    outputEl.innerHTML = `<div class="result-message" style="background: var(--danger); color: white;">Erro: ${msg.statusText}</div>`;
                } else if (msg.status === "incomplete") {
                    outputEl.innerHTML = `<div class="loading-message"><div class="loading-spinner"></div> Analisando edital...</div><div class="ai-response">${msg.content}</div>`;
                } else if (msg.status === "complete") {
                    outputEl.innerHTML = `<div class="ai-response">${msg.content}</div>`;

                    // Save the analysis
                    savedEditais.push({
                        id: Date.now(),
                        date: new Date().toLocaleString('pt-BR'),
                        input: document.getElementById('editalInput').value.substring(0, 200) + '...',
                        response: msg.content
                    });
                    Storage.set('savedEditais', savedEditais);
                    renderSavedEditais();
                }
            });

            window.Poe.registerHandler("cronograma-analise-handler", (result) => {
                const msg = result.responses[0];

                if (msg.status === "error") {
                    document.getElementById('cronoLoadingAnalise').style.display = 'none';
                    showNotification(`‚ùå Erro ao analisar edital: ${msg.statusText}`);
                } else if (msg.status === "incomplete") {
                    // Manter loading ativo
                } else if (msg.status === "complete") {
                    processarAnaliseIA(msg.content);
                }
            });
        }

        async function analyzeEdital() {
            const input = document.getElementById('editalInput').value.trim();

            if (!input) {
                showNotification('‚ö†Ô∏è Digite o texto do edital ou fa√ßa uma pergunta');
                return;
            }

            const outputEl = document.getElementById('editalOutput');
            outputEl.innerHTML = `<div class="loading-message"><div class="loading-spinner"></div> Analisando edital...</div>`;

            // PRIORIDADE 1: Tentar Google Gemini API (se configurado)
            const geminiConfig = Storage.get('geminiConfig', null);
            if (geminiConfig && geminiConfig.apiKey) {
                console.log('üöÄ Usando Google Gemini API...');
                const prompt = `Voc√™ √© um especialista em an√°lise de editais de concursos p√∫blicos brasileiros. Analise o edital abaixo e extraia APENAS as informa√ß√µes essenciais.

EDITAL:
${input}

INSTRU√á√ïES:
1. Identifique o CARGO do concurso
2. Liste APENAS as disciplinas que fazem parte do conte√∫do program√°tico deste cargo espec√≠fico (ignore outras disciplinas do edital que sejam de outros cargos)
3. Para cada disciplina, liste os principais t√≥picos/assuntos cobrados
4. Extraia a DATA DA PROVA
5. Identifique quantas QUEST√ïES ou PESO de cada disciplina (se houver)

FORMATO DA RESPOSTA (use exatamente este formato):

**CARGO:** [Nome do cargo]

**DATA DA PROVA:** [data ou "n√£o informada"]

**DISCIPLINAS E CONTE√öDO:**

1. **[Nome da Disciplina]** ([X quest√µes] ou [Peso X] se informado)
   - T√≥pico 1
   - T√≥pico 2
   - T√≥pico 3
   [continue...]

2. **[Nome da Disciplina 2]** ([X quest√µes] ou [Peso X] se informado)
   - T√≥pico 1
   - T√≥pico 2
   [continue...]

[Continue para todas as disciplinas do cargo]

**OBSERVA√á√ïES IMPORTANTES:**
- [Requisitos, escolaridade, ou outras informa√ß√µes relevantes]

Seja OBJETIVO e liste APENAS as disciplinas do cargo analisado.`;

                try {
                    const response = await callGeminiAPI(prompt, {
                        maxOutputTokens: 8192,
                        temperature: 0.7
                    });

                    console.log('‚úÖ Resposta do Gemini recebida');

                    // Extrair informa√ß√µes da resposta estruturada do Gemini
                    const cargoMatch = response.match(/\*\*CARGO:\*\*\s*(.+)/i);
                    const cargo = cargoMatch ? cargoMatch[1].trim() : 'N√£o identificado';

                    const dataMatch = response.match(/\*\*DATA DA PROVA:\*\*\s*(.+)/i);
                    const dataProva = dataMatch ? dataMatch[1].trim() : '';

                    // Extrair disciplinas e t√≥picos da resposta do Gemini
                    const disciplinasComTopicos = [];
                    const disciplinaRegex = /\d+\.\s+\*\*(.+?)\*\*\s*(\([^)]+\))?\s*([\s\S]+?)(?=\n\d+\.\s+\*\*|\*\*OBSERVA√á√ïES|$)/g;
                    let match;

                    while ((match = disciplinaRegex.exec(response)) !== null) {
                        const nomeDisciplina = match[1].trim();
                        const info = match[2] ? match[2].trim() : '';
                        const topicosTexto = match[3];

                        // Extrair t√≥picos (linhas que come√ßam com -)
                        const topicos = [];
                        const topicoRegex = /-\s*(.+)/g;
                        let topicoMatch;
                        while ((topicoMatch = topicoRegex.exec(topicosTexto)) !== null) {
                            topicos.push(topicoMatch[1].trim());
                        }

                        disciplinasComTopicos.push({
                            nome: nomeDisciplina,
                            info: info,
                            topicos: topicos
                        });
                    }

                    console.log('üìö Disciplinas extra√≠das:', disciplinasComTopicos.length);

                    // Mostrar disciplinas em lista vertical com t√≥picos
                    if (disciplinasComTopicos.length > 0) {
                        mostrarDisciplinasComTopicos(disciplinasComTopicos);

                        // Preencher conte√∫do program√°tico
                        let conteudoTexto = '';
                        disciplinasComTopicos.forEach(disc => {
                            conteudoTexto += `${disc.nome}: ${disc.topicos.join(', ')}\n`;
                        });
                        const textarea = document.getElementById('conteudoProgramatico');
                        if (textarea) {
                            textarea.value = conteudoTexto.trim();
                        }
                    }

                    // Salvar no AppData
                    AppData.edital.textoCompleto = input;
                    AppData.edital.cargoDesejado = cargo;
                    AppData.edital.dataProva = dataProva;
                    AppData.edital.disciplinas = disciplinasComTopicos;
                    AppData.edital.analisadoEm = new Date().toISOString();
                    AppData.salvar();

                    // Exibir resultado do Gemini
                    outputEl.innerHTML = `
                        <div style="padding: 12px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--success);">
                            <strong style="color: var(--success);">‚úÖ An√°lise gerada por Google Gemini ${geminiConfig.model.replace('gemini-', '')}</strong>
                        </div>
                        <div class="ai-response" style="white-space: pre-wrap;">${response}</div>
                    `;

                    // Save the analysis
                    savedEditais.push({
                        id: Date.now(),
                        date: new Date().toLocaleString('pt-BR'),
                        input: input.substring(0, 200) + '...',
                        response: response
                    });
                    Storage.set('savedEditais', savedEditais);
                    renderSavedEditais();

                    showNotification('‚úÖ An√°lise conclu√≠da com Gemini!');
                    console.log('‚úÖ Dados salvos:', foundSubjects.length, 'disciplinas');
                    return;

                } catch (err) {
                    console.log('‚ùå Gemini falhou:', err.message);
                    console.log('Tentando Poe API...');
                    // Continue para tentar Poe
                }
            }

            // PRIORIDADE 2: Tentar Poe API
            if (window.Poe) {
                const prompt = `Voc√™ √© um especialista em an√°lise de editais de concursos p√∫blicos. Analise o seguinte texto/pergunta e forne√ßa informa√ß√µes claras e organizadas:

${input}

Por favor, organize sua resposta de forma clara, destacando:
- Disciplinas e conte√∫dos program√°ticos
- Pesos e n√∫mero de quest√µes (se mencionado)
- Datas importantes
- Requisitos e informa√ß√µes relevantes
- Dicas de estudo baseadas no edital`;

                try {
                    await window.Poe.sendUserMessage(`@Claude-Sonnet-4.5 ${prompt}`, {
                        handler: "edital-handler",
                        stream: true,
                        openChat: false
                    });
                    return;
                } catch (err) {
                    console.log('Poe API n√£o dispon√≠vel, usando an√°lise offline');
                }
            }

            // PRIORIDADE 3: Fallback offline intelligent analysis
            setTimeout(() => {
                try {
                    console.log('Iniciando an√°lise offline...');
                    const analysis = analyzeEditalOffline(input);
                    console.log('An√°lise b√°sica conclu√≠da');

                    // Extract data for additional features
                    const foundSubjects = [];
                    const commonSubjects = [
                        'Portugu√™s', 'L√≠ngua Portuguesa', 'Reda√ß√£o',
                        'Matem√°tica', 'Matem√°tica Financeira',
                        'Racioc√≠nio L√≥gico', 'L√≥gica',
                        'Inform√°tica', 'No√ß√µes de Inform√°tica',
                        'Direito Constitucional', 'Constitucional',
                        'Direito Administrativo', 'Administrativo',
                        'Direito Penal', 'Penal',
                        'Direito Processual Penal', 'Processual Penal',
                        'Direito Civil', 'Civil',
                        'Direito do Trabalho', 'Trabalho',
                        'Direito Tribut√°rio', 'Tribut√°rio',
                        'Direito Previdenci√°rio', 'Previdenci√°rio',
                        'Contabilidade', 'Contabilidade Geral',
                        'Administra√ß√£o', 'Administra√ß√£o P√∫blica',
                        'Economia', 'Atualidades', 'Conhecimentos Gerais',
                        'Legisla√ß√£o', 'Estat√≠stica', '√âtica'
                    ];

                    commonSubjects.forEach(subject => {
                        const regex = new RegExp(subject, 'gi');
                        const matches = input.match(regex);
                        if (matches && matches.length > 0 && !foundSubjects.includes(subject)) {
                            foundSubjects.push(subject);
                        }
                    });

                    console.log('Disciplinas encontradas:', foundSubjects);

                    // NOVA FUNCIONALIDADE: Mostrar disciplinas em lista vertical
                    if (foundSubjects.length > 0) {
                        mostrarDisciplinasVerticais(foundSubjects);
                    }

                    // NOVA FUNCIONALIDADE: Preencher conte√∫do program√°tico automaticamente
                    preencherConteudoProgramatico(input, foundSubjects);

                    // Calculate days until exam - MELHORADO para buscar em m√∫ltiplos formatos
                    let daysUntilExam = null;
                    let dataProva = null;

                    // Estrat√©gia 1: Procurar por "data da prova", "realiza√ß√£o da prova", etc.
                    const provaPatterns = [
                        /(?:data\s+da\s+prova|realiza√ß√£o\s+da\s+prova|aplica√ß√£o\s+da\s+prova|prova\s+objetiva)[^\n]{0,80}?(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/gi,
                        /prova[^\n]{0,50}?(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/gi,
                        /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})[^\n]{0,50}?prova/gi
                    ];

                    for (const pattern of provaPatterns) {
                        const match = input.match(pattern);
                        if (match && match.length > 0) {
                            const dateStr = match[0].match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/);
                            if (dateStr) {
                                dataProva = dateStr[0];
                                break;
                            }
                        }
                    }

                    // Estrat√©gia 2: Se n√£o encontrou, procurar na se√ß√£o "Datas Importantes" ou "Cronograma"
                    if (!dataProva) {
                        const datasImportantesRegex = /(?:datas?\s+importantes?|cronograma)[^\n]*?\n([^]*?)(?:\n\n|$)/gi;
                        const secaoMatch = input.match(datasImportantesRegex);
                        if (secaoMatch && secaoMatch.length > 0) {
                            // Procurar por datas nesta se√ß√£o
                            const todasDatas = secaoMatch[0].match(/(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/g);
                            if (todasDatas && todasDatas.length > 0) {
                                // Pegar a √∫ltima data (geralmente √© a data da prova)
                                dataProva = todasDatas[todasDatas.length - 1];
                            }
                        }
                    }

                    // Calcular dias at√© a prova
                    if (dataProva) {
                        try {
                            const parts = dataProva.split(/[\/\-\.]/);
                            const examDate = new Date(parts[2], parts[1] - 1, parts[0]);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            daysUntilExam = Math.ceil((examDate - today) / (1000 * 60 * 60 * 24));

                            console.log('‚úÖ Data da prova encontrada:', dataProva, '- Dias restantes:', daysUntilExam);

                            // Salvar no AppData
                            AppData.edital.dataProva = dataProva;
                        } catch (e) {
                            console.error('Erro ao processar data:', e);
                        }
                    } else {
                        console.log('‚ö†Ô∏è Data da prova n√£o encontrada no edital');
                    }

                    console.log('Dias at√© a prova:', daysUntilExam);

                    // Generate all sections with error handling
                    let verticalizedSyllabus = '';
                    let cyclicSchedule = '';
                    let subjectSummary = '';

                    try {
                        console.log('Gerando edital verticalizado...');
                        verticalizedSyllabus = foundSubjects.length > 0 ? generateVerticalizedSyllabus(input, foundSubjects) : '';
                        console.log('‚úÖ Edital verticalizado OK');
                    } catch (e) {
                        console.error('Erro no edital verticalizado:', e);
                        verticalizedSyllabus = '<p style="color: var(--danger);">Erro ao gerar edital verticalizado</p>';
                    }

                    try {
                        console.log('Gerando cronograma c√≠clico...');
                        cyclicSchedule = foundSubjects.length > 0 ? generateCyclicSchedule(input, foundSubjects, daysUntilExam) : '';
                        console.log('‚úÖ Cronograma c√≠clico OK');
                    } catch (e) {
                        console.error('Erro no cronograma c√≠clico:', e);
                        cyclicSchedule = '<p style="color: var(--danger);">Erro ao gerar cronograma</p>';
                    }

                    try {
                        console.log('Gerando resumo dos assuntos...');
                        subjectSummary = foundSubjects.length > 0 ? generateSubjectSummary(input, foundSubjects) : '';
                        console.log('‚úÖ Resumo dos assuntos OK');
                    } catch (e) {
                        console.error('Erro no resumo:', e);
                        subjectSummary = '<p style="color: var(--danger);">Erro ao gerar resumo</p>';
                    }

                    console.log('Montando HTML final...');

                    outputEl.innerHTML = `
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-secondary);">
                                        Velocidade da Leitura: <span id="analysisSpeedLabel" class="mono" style="color: var(--accent-primary);">1.0x</span>
                                    </label>
                                    <input type="range" id="analysisSpeed" min="0.5" max="4" step="0.1" value="1"
                                        style="width: 100%;"
                                        oninput="document.getElementById('analysisSpeedLabel').textContent = parseFloat(this.value).toFixed(1) + 'x'">
                                    <div style="display: flex; justify-content: space-between; margin-top: 5px; color: var(--text-secondary); font-size: 12px;">
                                        <span>0.5x</span>
                                        <span>1.5x</span>
                                        <span>2.5x</span>
                                        <span>4.0x</span>
                                    </div>
                                </div>
                                <button class="btn" onclick="ouvirAnalise()" style="display: inline-flex; align-items: center; gap: 8px;">
                                    <span id="ouvirIcon">üéß</span> <span id="ouvirText">Ouvir An√°lise</span>
                                </button>
                            </div>
                        </div>
                        <div class="ai-response" id="analysisContent">
                            ${analysis}
                            ${verticalizedSyllabus}
                            ${cyclicSchedule}
                            ${subjectSummary}
                        </div>
                    `;

                    console.log('HTML inserido com sucesso!');

                    // Save the analysis
                    const fullAnalysis = analysis + verticalizedSyllabus + cyclicSchedule + subjectSummary;
                    savedEditais.push({
                        id: Date.now(),
                        date: new Date().toLocaleString('pt-BR'),
                        input: input.substring(0, 200) + '...',
                        response: fullAnalysis
                    });
                    Storage.set('savedEditais', savedEditais);
                    renderSavedEditais();

                    // Salvar dados no AppData para uso nas outras abas
                    AppData.edital.textoCompleto = input;
                    AppData.edital.disciplinas = foundSubjects.map(nome => ({
                        nome: nome,
                        topicos: extractedEditalTopics[nome] || []
                    }));
                    AppData.edital.analisadoEm = new Date().toISOString();
                    AppData.salvar();
                    console.log('‚úÖ Dados salvos no AppData:', AppData.edital.disciplinas.length, 'disciplinas');

                    showNotification('‚úÖ An√°lise conclu√≠da com sucesso!');
                    console.log('An√°lise completa finalizada!');

                } catch (error) {
                    console.error('ERRO na an√°lise:', error);
                    outputEl.innerHTML = `
                        <div class="result-message" style="background: var(--danger); color: white;">
                            ‚ùå Erro ao processar an√°lise: ${error.message}
                            <br><br>
                            <small>Verifique o console (F12) para mais detalhes.</small>
                        </div>
                    `;
                }
            }, 800);
        }

        function analyzeEditalOffline(text) {
            let html = '<h3>üìã An√°lise do Edital</h3>';

            // Extract disciplines
            const commonSubjects = [
                'Portugu√™s', 'L√≠ngua Portuguesa', 'Reda√ß√£o',
                'Matem√°tica', 'Matem√°tica Financeira',
                'Racioc√≠nio L√≥gico', 'L√≥gica',
                'Inform√°tica', 'No√ß√µes de Inform√°tica',
                'Direito Constitucional', 'Constitucional',
                'Direito Administrativo', 'Administrativo',
                'Direito Penal', 'Penal',
                'Direito Processual Penal', 'Processual Penal',
                'Direito Civil', 'Civil',
                'Direito do Trabalho', 'Trabalho',
                'Direito Tribut√°rio', 'Tribut√°rio',
                'Direito Previdenci√°rio', 'Previdenci√°rio',
                'Contabilidade', 'Contabilidade Geral',
                'Administra√ß√£o', 'Administra√ß√£o P√∫blica',
                'Economia', 'Atualidades', 'Conhecimentos Gerais',
                'Legisla√ß√£o', 'Estat√≠stica', '√âtica'
            ];

            const foundSubjects = [];
            const subjectDetails = {};

            commonSubjects.forEach(subject => {
                const regex = new RegExp(subject, 'gi');
                const matches = text.match(regex);
                if (matches && matches.length > 0) {
                    const normalized = subject;
                    if (!foundSubjects.includes(normalized)) {
                        foundSubjects.push(normalized);

                        // Try to find question count or weight
                        const contextRegex = new RegExp(`${subject}[^\\n]{0,100}(\\d+)\\s*(quest√µes|quest√£o|pontos|pts)`, 'gi');
                        const context = text.match(contextRegex);
                        if (context) {
                            subjectDetails[normalized] = context[0];
                        }
                    }
                }
            });

            if (foundSubjects.length > 0) {
                html += '<h4>üìö Disciplinas Identificadas:</h4><ul>';
                foundSubjects.forEach(subject => {
                    html += `<li><strong>${subject}</strong>`;
                    if (subjectDetails[subject]) {
                        html += ` - ${subjectDetails[subject]}`;
                    }
                    html += '</li>';
                });
                html += '</ul>';
            }

            // Extract dates with context
            const dateRegex = /([^\n.!?]*?)(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})([^\n.!?]*?)[\n.!?]/gi;
            const dateMatches = text.matchAll(dateRegex);
            const datesWithContext = [];

            for (const match of dateMatches) {
                const before = match[1].trim();
                const date = match[2];
                const after = match[3].trim();

                // Build context - get text before or after the date
                let context = '';

                // Common keywords for events
                const eventKeywords = [
                    'inscri√ß√£o', 'inscri√ß√µes', 'prova', 'exame', 'resultado',
                    'publica√ß√£o', 'divulga√ß√£o', 'prazo', 'entrega', 'recurso',
                    'edital', 'convoca√ß√£o', 'posse', 'nomea√ß√£o', 'homologa√ß√£o'
                ];

                // Check before and after for event keywords
                const fullContext = (before + ' ' + after).toLowerCase();
                let foundEvent = false;

                for (const keyword of eventKeywords) {
                    if (fullContext.includes(keyword)) {
                        // Extract a meaningful phrase
                        const words = (before + ' ' + after).split(/\s+/);
                        const relevantWords = words.slice(Math.max(0, words.length - 8), words.length);
                        context = relevantWords.join(' ').replace(/[:\-,;]/g, '').trim();
                        foundEvent = true;
                        break;
                    }
                }

                if (!foundEvent) {
                    // If no keyword found, use the text before the date
                    const words = before.split(/\s+/);
                    context = words.slice(Math.max(0, words.length - 6)).join(' ').replace(/[:\-,;]/g, '').trim();
                }

                // Clean up context
                if (context.length > 60) {
                    context = context.substring(Math.max(0, context.length - 60));
                }

                datesWithContext.push({ date, context });
            }

            if (datesWithContext.length > 0) {
                html += '<h4>üìÖ Datas Importantes:</h4><ul>';

                // Remove duplicates
                const uniqueDates = [];
                const seenDates = new Set();

                datesWithContext.forEach(item => {
                    if (!seenDates.has(item.date)) {
                        seenDates.add(item.date);
                        uniqueDates.push(item);
                    }
                });

                uniqueDates.forEach(item => {
                    if (item.context && item.context.length > 2) {
                        html += `<li><strong>${item.date}</strong> - ${item.context}</li>`;
                    } else {
                        html += `<li><strong>${item.date}</strong></li>`;
                    }
                });
                html += '</ul>';
            }

            // Extract numbers (quest√µes, vagas, etc)
            const vagasRegex = /(\d+)\s*vagas?/gi;
            const vagas = text.match(vagasRegex);
            if (vagas) {
                html += '<h4>üë• Vagas:</h4><ul>';
                vagas.forEach(v => html += `<li>${v}</li>`);
                html += '</ul>';
            }

            const questoesRegex = /(\d+)\s*quest√µes?/gi;
            const questoes = text.match(questoesRegex);
            if (questoes) {
                html += '<h4>üìù Quest√µes:</h4><ul>';
                questoes.forEach(q => html += `<li>${q}</li>`);
                html += '</ul>';
            }

            // Intelligent Recommendations based on extracted data
            html += '<h4>üí° Recomenda√ß√µes Personalizadas de Estudo:</h4>';

            // Extract question counts per subject
            const subjectWeights = [];
            foundSubjects.forEach(subject => {
                const regex = new RegExp(`${subject}[^\\n]{0,100}(\\d+)\\s*quest√µes?`, 'gi');
                const match = text.match(regex);
                if (match) {
                    const numberMatch = match[0].match(/(\d+)/);
                    if (numberMatch) {
                        subjectWeights.push({
                            subject: subject,
                            questions: parseInt(numberMatch[1])
                        });
                    }
                }
            });

            // Sort by weight (most questions first)
            subjectWeights.sort((a, b) => b.questions - a.questions);

            // Calculate total questions
            const totalQuestions = subjectWeights.reduce((sum, item) => sum + item.questions, 0);

            // Calculate days until exam
            let daysUntilExam = null;
            const provaRegex = /prova[^\\n]{0,50}(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/gi;
            const provaMatch = text.match(provaRegex);
            if (provaMatch) {
                const dateStr = provaMatch[0].match(/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})/);
                if (dateStr) {
                    const parts = dateStr[0].split(/[\/\-]/);
                    const examDate = new Date(parts[2], parts[1] - 1, parts[0]);
                    daysUntilExam = Math.ceil((examDate - new Date()) / (1000 * 60 * 60 * 24));
                }
            }

            html += '<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';

            // Priority subjects based on weight
            if (subjectWeights.length > 0) {
                html += '<p style="margin-bottom: 10px;"><strong>üìä Prioriza√ß√£o por Peso:</strong></p><ul>';

                subjectWeights.slice(0, 5).forEach((item, idx) => {
                    const percentage = ((item.questions / totalQuestions) * 100).toFixed(1);
                    let priority = '';
                    let emoji = '';

                    if (percentage >= 20) {
                        priority = 'PRIORIDADE M√ÅXIMA';
                        emoji = 'üî•';
                    } else if (percentage >= 15) {
                        priority = 'Alta prioridade';
                        emoji = '‚ö°';
                    } else if (percentage >= 10) {
                        priority = 'Prioridade m√©dia';
                        emoji = 'üìå';
                    } else {
                        priority = 'Prioridade normal';
                        emoji = 'üìù';
                    }

                    html += `<li>${emoji} <strong>${item.subject}:</strong> ${item.questions} quest√µes (${percentage}%) - <span style="color: var(--accent-primary);">${priority}</span></li>`;
                });
                html += '</ul>';

                // Study time recommendation
                html += '<p style="margin-top: 15px;"><strong>‚è∞ Distribui√ß√£o de Tempo Sugerida:</strong></p><ul>';
                subjectWeights.slice(0, 3).forEach(item => {
                    const percentage = ((item.questions / totalQuestions) * 100).toFixed(0);
                    html += `<li><strong>${item.subject}:</strong> ~${percentage}% do seu tempo de estudo</li>`;
                });
                html += '</ul>';
            }

            html += '</div>';

            // Time-based strategy
            if (daysUntilExam !== null) {
                html += '<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px; margin-bottom: 15px;">';
                html += '<p><strong>üìÖ Estrat√©gia baseada no tempo:</strong></p><ul>';

                if (daysUntilExam < 0) {
                    html += '<li>‚ö†Ô∏è A data da prova j√° passou ou est√° incorreta no edital</li>';
                } else if (daysUntilExam <= 30) {
                    html += '<li>üö® <strong>ATEN√á√ÉO: Menos de 30 dias!</strong> Modo INTENSIVO ativado</li>';
                    html += '<li>üéØ Foque nas mat√©rias de maior peso (top 3)</li>';
                    html += '<li>üìù Fa√ßa SIMULADOS semanais obrigat√≥rios</li>';
                    html += '<li>‚è±Ô∏è Estude no m√≠nimo 4-6h por dia</li>';
                    html += '<li>üîÑ √öltimos 7 dias: apenas revis√£o e simulados</li>';
                } else if (daysUntilExam <= 60) {
                    html += `<li>‚ö° Voc√™ tem ${daysUntilExam} dias - Tempo moderado</li>`;
                    html += '<li>üìö Cubra todas as mat√©rias em ciclos completos</li>';
                    html += '<li>üìä 1 simulado a cada 2 semanas</li>';
                    html += '<li>üé¥ Use flashcards para memoriza√ß√£o</li>';
                    html += '<li>‚è∞ Estude 3-5h por dia consistentemente</li>';
                } else if (daysUntilExam <= 120) {
                    html += `<li>üìÖ Voc√™ tem ${daysUntilExam} dias - Tempo bom para prepara√ß√£o</li>`;
                    html += '<li>üìñ Estudo aprofundado de teoria + quest√µes</li>';
                    html += '<li>üîÑ Fa√ßa 2-3 ciclos completos de todas as mat√©rias</li>';
                    html += '<li>üìù Simulado mensal para acompanhar evolu√ß√£o</li>';
                    html += '<li>‚è±Ô∏è 2-4h por dia √© suficiente se for consistente</li>';
                } else {
                    html += `<li>‚úÖ Voc√™ tem ${daysUntilExam} dias - Tempo excelente!</li>`;
                    html += '<li>üìö Aproveite para estudar com profundidade</li>';
                    html += '<li>üéØ Desenvolva base s√≥lida em cada mat√©ria</li>';
                    html += '<li>üìä Acompanhe estat√≠sticas e ajuste estrat√©gia</li>';
                    html += '<li>‚è∞ 2-3h por dia com qualidade √© ideal</li>';
                }

                html += '</ul></div>';
            }

            // Subject-specific tips
            html += '<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px;">';
            html += '<p><strong>üìö Dicas por Disciplina:</strong></p><ul>';

            const subjectTips = {
                'Direito Constitucional': 'üéØ Foque em: Direitos Fundamentais, Organiza√ß√£o do Estado, Controle de Constitucionalidade',
                'Constitucional': 'üéØ Foque em: Direitos Fundamentais, Organiza√ß√£o do Estado, Controle de Constitucionalidade',
                'Direito Administrativo': 'üèõÔ∏è Priorize: Atos Administrativos, Licita√ß√µes (Lei 14.133/21), Servidores P√∫blicos',
                'Administrativo': 'üèõÔ∏è Priorize: Atos Administrativos, Licita√ß√µes (Lei 14.133/21), Servidores P√∫blicos',
                'Portugu√™s': 'üìñ Essencial: Interpreta√ß√£o de Texto (40%), Gram√°tica (40%), Reda√ß√£o Oficial (20%)',
                'L√≠ngua Portuguesa': 'üìñ Essencial: Interpreta√ß√£o de Texto (40%), Gram√°tica (40%), Reda√ß√£o Oficial (20%)',
                'Racioc√≠nio L√≥gico': 'üßÆ Mat√©ria de TREINO! Fa√ßa 20+ quest√µes por dia, todo dia',
                'L√≥gica': 'üßÆ Mat√©ria de TREINO! Fa√ßa 20+ quest√µes por dia, todo dia',
                'Matem√°tica': 'üî¢ Pratique diariamente! Foque em: Porcentagem, Regra de 3, Equa√ß√µes',
                'Inform√°tica': 'üíª Estude: Windows/Linux, Office (Excel √© campe√£o), Redes e Seguran√ßa',
                'Direito Penal': '‚öñÔ∏è Parte Geral √© 60% das quest√µes! Domine antes da Parte Especial',
                'Direito Civil': 'üìú Base: Parte Geral, Obriga√ß√µes, Contratos (s√£o as mais cobradas)',
                'Contabilidade': 'üìä Fa√ßa exerc√≠cios pr√°ticos! Teoria sozinha n√£o basta',
            };

            foundSubjects.forEach(subject => {
                if (subjectTips[subject]) {
                    html += `<li>${subjectTips[subject]}</li>`;
                }
            });

            html += '<li>‚è∞ <strong>T√©cnica Pomodoro:</strong> Use a aba Pomodoro para manter foco e produtividade</li>';
            html += '<li>üìä <strong>Simulados regulares:</strong> Me√ßa seu progresso e identifique pontos fracos</li>';
            html += '<li>üé¥ <strong>Flashcards:</strong> Perfeito para leis, conceitos e jurisprud√™ncia</li>';
            html += '<li>üéß <strong>Use √°udio:</strong> Transforme PDFs em √°udio e estude em movimento</li>';

            html += '</ul></div>';

            return html;
        }

        // Extract detailed topics from syllabus - SMART EXTRACTION (only from content section)
        function extractTopics(text, subject) {
            const topics = [];

            // STEP 1: Find the CONTENT SECTION (programa, conte√∫do program√°tico, etc.)
            const contentSectionPatterns = [
                /CONTE[U√ö]DO\s+PROGRAM[A√Å]TICO/i,
                /PROGRAMA\s+(?:DO\s+)?EDITAL/i,
                /PROGRAMA\s+(?:DE\s+)?(?:PROVAS?|CONHECIMENTOS?)/i,
                /CONHECIMENTOS?\s+(?:ESPEC[I√ç]FICOS?|GERAIS?)/i,
                /DISCIPLINAS?/i
            ];

            let contentStart = -1;
            let contentEnd = text.length;

            // Find where content section starts
            for (const pattern of contentSectionPatterns) {
                const match = text.search(pattern);
                if (match !== -1 && (contentStart === -1 || match < contentStart)) {
                    contentStart = match;
                }
            }

            // If no content section found, use full text
            if (contentStart === -1) {
                contentStart = 0;
                console.log('‚ö†Ô∏è Se√ß√£o de conte√∫do program√°tico n√£o encontrada. Usando texto completo.');
            } else {
                console.log(`‚úÖ Se√ß√£o de conte√∫do program√°tico encontrada em posi√ß√£o ${contentStart}`);
            }

            // STEP 2: Find where content section ENDS (before irrelevant sections)
            const stopSectionPatterns = [
                /ATRIBUI[√áC][O√ï]ES\s+DO\s+CARGO/i,
                /REQUISITOS?\s+(?:PARA|DO)/i,
                /INSCRI[√áC][O√ï]ES/i,
                /DAS\s+INSCRI[√áC][O√ï]ES/i,
                /SOBRE\s+O\s+CONCURSO/i,
                /INFORMA[√áC][O√ï]ES\s+GERAIS/i,
                /RESERVA\s+DE\s+VAGAS/i,
                /CRONOGRAMA/i
            ];

            for (const pattern of stopSectionPatterns) {
                const match = text.substring(contentStart).search(pattern);
                if (match !== -1) {
                    const absolutePos = contentStart + match;
                    if (absolutePos < contentEnd) {
                        contentEnd = absolutePos;
                        console.log(`‚ö†Ô∏è Encontrou se√ß√£o irrelevante em ${absolutePos}. Parando extra√ß√£o.`);
                    }
                }
            }

            // Extract only from content section
            const contentSection = text.substring(contentStart, contentEnd);

            // STEP 3: Find the specific subject within the content section
            const subjectIndex = contentSection.toLowerCase().indexOf(subject.toLowerCase());
            let content = '';

            if (subjectIndex !== -1) {
                // Get everything after the subject name, but only up to 2000 chars OR next subject
                const afterSubject = contentSection.substring(subjectIndex + subject.length);

                // Try to find where next subject starts (all caps or numbered section)
                const nextSubjectPattern = /\n\s*(?:[A-Z√Ä-√ö][A-Z√Ä-√ö\s]{5,}|(?:\d+\s+QUEST[O√ï]ES|QUEST[O√ï]ES))/;
                const nextSubjectMatch = afterSubject.search(nextSubjectPattern);

                if (nextSubjectMatch !== -1 && nextSubjectMatch < 2000) {
                    content = afterSubject.substring(0, nextSubjectMatch);
                    console.log(`‚úÖ Encontrou pr√≥xima se√ß√£o em ${nextSubjectMatch} chars. Limitando extra√ß√£o.`);
                } else {
                    content = afterSubject.substring(0, 2000);
                }

                console.log(`‚úÖ Encontrou "${subject}" no conte√∫do program√°tico.`);
            } else {
                console.log(`‚ùå N√£o encontrou "${subject}" na se√ß√£o de conte√∫do program√°tico.`);
                return topics;
            }

            if (content) {
                console.log(`üìù Processando ${content.length} caracteres para "${subject}"...`);

                // ESTRAT√âGIA 1: N√∫meros (1., 1.1., 1.1.1., etc.)
                const numberedRegex = /(\d+(?:\.\d+)*)\.\s*([^\n]+)/gi;
                let matches = [...content.matchAll(numberedRegex)];
                matches.forEach(m => {
                    const topic = m[2].trim();
                    if (topic.length > 3 && topic.length < 400) {
                        const clean = topic.replace(/[:\-;,]+$/, '').trim();
                        if (!topics.includes(clean)) topics.push(clean);
                    }
                });

                // ESTRAT√âGIA 2: Letras (a), b), c), etc.)
                const letterRegex = /([a-z])\)\s*([^\n]+)/gi;
                matches = [...content.matchAll(letterRegex)];
                matches.forEach(m => {
                    const topic = m[2].trim();
                    if (topic.length > 3 && topic.length < 400) {
                        const clean = topic.replace(/[:\-;,]+$/, '').trim();
                        if (!topics.includes(clean)) topics.push(clean);
                    }
                });

                // ESTRAT√âGIA 3: Bullets (-, ‚Ä¢, *, etc.)
                const bulletRegex = /[-‚Ä¢\*]\s*([^\n]+)/gi;
                matches = [...content.matchAll(bulletRegex)];
                matches.forEach(m => {
                    const topic = m[1].trim();
                    if (topic.length > 3 && topic.length < 400) {
                        const clean = topic.replace(/[:\-;,]+$/, '').trim();
                        if (!topics.includes(clean)) topics.push(clean);
                    }
                });

                // ESTRAT√âGIA 4: TODAS AS LINHAS (muito agressivo!)
                if (topics.length < 3) {
                    console.log('‚ö†Ô∏è Poucos t√≥picos encontrados. Usando extra√ß√£o linha por linha...');
                    const lines = content.split(/[\n\r]+/);
                    lines.forEach(line => {
                        const trimmed = line.trim();
                        // Aceita quase tudo que n√£o seja obviamente ruim
                        if (trimmed.length > 8 && trimmed.length < 500 &&
                            !trimmed.match(/^\d+\s*quest√µes?/i) &&
                            !trimmed.match(/^p√°g/i) &&
                            !trimmed.match(/^\s*$/)) {
                            // Limpa n√∫meros iniciais
                            let clean = trimmed.replace(/^[\d.\-\s)a-z]+/, '').trim();
                            clean = clean.replace(/[:\-;,]+$/, '').trim();
                            if (clean.length > 5 && !topics.includes(clean)) {
                                topics.push(clean);
                            }
                        }
                    });
                }

                // ESTRAT√âGIA 5: Split por pontos, v√≠rgulas, ponto-e-v√≠rgula
                if (topics.length < 3) {
                    console.log('‚ö†Ô∏è √öLTIMA tentativa: split por pontua√ß√£o...');
                    const parts = content.split(/[.;,]+/);
                    parts.forEach(part => {
                        const trimmed = part.trim();
                        if (trimmed.length > 10 && trimmed.length < 300) {
                            if (!topics.includes(trimmed)) topics.push(trimmed);
                        }
                    });
                }

                console.log(`‚úÖ ${topics.length} t√≥picos extra√≠dos para "${subject}"`);
            } else {
                console.log(`‚ùå Nenhum conte√∫do encontrado para ${subject}`);
            }

            if (topics.length > 0) {
                console.log(`‚úÖ SUCESSO! ${topics.length} t√≥picos para "${subject}":`, topics.slice(0, 5));
            } else {
                console.log(`‚ùå FALHA! Nenhum t√≥pico extra√≠do para "${subject}"`);
            }
            return topics.slice(0, 50); // Limit to 50 topics per subject
        }

        // Mostrar disciplinas em lista vertical (√°rea de resultado na aba An√°lise de Edital)
        function mostrarDisciplinasVerticais(foundSubjects) {
            const container = document.getElementById('disciplinasExtraidas');
            const lista = document.getElementById('listaDisciplinas');

            if (!foundSubjects || foundSubjects.length === 0) {
                container.style.display = 'none';
                return;
            }

            let html = '<div style="display: grid; gap: 10px;">';

            foundSubjects.forEach((disciplina, index) => {
                html += `
                    <div style="display: flex; align-items: center; padding: 12px; background: var(--bg-secondary); border-radius: 6px; border-left: 4px solid var(--accent-primary);">
                        <span style="font-weight: 600; color: var(--accent-primary); margin-right: 12px; font-size: 18px;">${index + 1}.</span>
                        <span style="color: var(--text-primary); font-weight: 500;">${disciplina}</span>
                    </div>
                `;
            });

            html += '</div>';
            lista.innerHTML = html;
            container.style.display = 'block';
        }

        // Mostrar disciplinas COM t√≥picos (usado na an√°lise do Gemini)
        function mostrarDisciplinasComTopicos(disciplinas) {
            const container = document.getElementById('disciplinasExtraidas');
            const lista = document.getElementById('listaDisciplinas');

            if (!disciplinas || disciplinas.length === 0) {
                container.style.display = 'none';
                return;
            }

            let html = '<div style="display: grid; gap: 12px;">';

            disciplinas.forEach((disc, index) => {
                const topicosHtml = disc.topicos && disc.topicos.length > 0
                    ? `<ul style="margin: 10px 0 0 0; padding-left: 20px; color: var(--text-secondary); line-height: 1.8;">
                        ${disc.topicos.map(topico => `<li>${topico}</li>`).join('')}
                       </ul>`
                    : '<p style="color: var(--text-secondary); font-style: italic; margin-top: 8px;">T√≥picos n√£o especificados</p>';

                html += `
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-weight: 600; color: var(--accent-primary); font-size: 18px;">${index + 1}.</span>
                            <div style="flex: 1;">
                                <span style="color: var(--text-primary); font-weight: 600; font-size: 16px;">${disc.nome}</span>
                                ${disc.info ? `<span style="color: var(--text-secondary); font-size: 13px; margin-left: 8px;">${disc.info}</span>` : ''}
                            </div>
                        </div>
                        ${topicosHtml}
                    </div>
                `;
            });

            html += '</div>';
            lista.innerHTML = html;
            container.style.display = 'block';
        }

        // Preencher conte√∫do program√°tico automaticamente
        function preencherConteudoProgramatico(textoCompleto, foundSubjects) {
            const textarea = document.getElementById('conteudoProgramatico');

            if (!foundSubjects || foundSubjects.length === 0) {
                textarea.value = '';
                return;
            }

            let conteudo = '';

            foundSubjects.forEach((disciplina, index) => {
                // Extrair t√≥picos para esta disciplina
                const topicos = extractTopics(textoCompleto, disciplina);

                // Formatar: Disciplina: t√≥pico1, t√≥pico2, t√≥pico3
                if (topicos && topicos.length > 0) {
                    conteudo += `${disciplina}: ${topicos.join(', ')}\n`;
                } else {
                    // Se n√£o encontrou t√≥picos espec√≠ficos, deixar em branco para o usu√°rio preencher
                    conteudo += `${disciplina}: \n`;
                }
            });

            textarea.value = conteudo.trim();
        }

        // Generate verticalized syllabus
        function generateVerticalizedSyllabus(text, foundSubjects) {
            // RESET GLOBAL TOPICS
            extractedEditalTopics = {};

            let html = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
            html += '<h3 style="color: var(--accent-primary); margin-bottom: 20px;">üìã Edital Verticalizado</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">Conte√∫do reorganizado por disciplina para facilitar seus estudos</p>';

            foundSubjects.forEach((subject, idx) => {
                const topics = extractTopics(text, subject);

                // SAVE TO GLOBAL for use in cronograma
                extractedEditalTopics[subject] = topics.length > 0 ? topics : [];

                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-primary);">`;

                if (topics.length > 0) {
                    // FORMATO INLINE: Mat√©ria: t√≥pico1, t√≥pico2, t√≥pico3, etc.
                    html += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${subject}:</strong> `;
                    html += topics.join(', ');
                    html += '.</p>';
                } else {
                    html += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${subject}:</strong> `;
                    html += '<span style="color: var(--text-secondary); font-style: italic;">T√≥picos n√£o especificados no edital. Consulte bibliografia recomendada.</span></p>';
                }

                html += '</div>';
            });

            html += '<div style="margin-top: 20px; padding: 15px; background: var(--bg-elevated); border-radius: 8px;">';
            html += '<p style="margin: 0;"><strong>üí° Dica:</strong> Salve este edital verticalizado e use como checklist durante seus estudos. Marque cada t√≥pico conforme for dominando!</p>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        // Generate cyclic weekly study schedule with specific topics
        function generateCyclicSchedule(text, foundSubjects, daysUntilExam) {
            let html = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
            html += '<h3 style="color: var(--accent-primary); margin-bottom: 20px;">üîÑ Cronograma C√≠clico Semanal</h3>';
            html += '<p style="color: var(--text-secondary); margin-bottom: 20px;">Estude todas as mat√©rias e t√≥picos em ciclos semanais completos</p>';

            // Extract topics for each subject
            const subjectsWithTopics = [];
            foundSubjects.forEach(subject => {
                const topics = extractTopics(text, subject);
                if (topics.length > 0) {
                    subjectsWithTopics.push({
                        subject: subject,
                        topics: topics
                    });
                } else {
                    subjectsWithTopics.push({
                        subject: subject,
                        topics: ['Todos os t√≥picos do edital']
                    });
                }
            });

            const numSubjects = subjectsWithTopics.length;
            const numCycles = daysUntilExam ? Math.floor(daysUntilExam / 7) : 4;
            const cyclesToShow = Math.min(numCycles, 4);

            const days = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];

            // Calculate how many subjects per day (aim for 2-3 subjects per day)
            const studyDaysPerWeek = 6;
            const subjectsPerDay = Math.max(2, Math.ceil(numSubjects / studyDaysPerWeek));

            for (let cycle = 1; cycle <= cyclesToShow; cycle++) {
                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;
                html += `<h4 style="color: var(--accent-secondary); margin-bottom: 15px;">üìÖ Ciclo ${cycle} - Semana ${cycle}</h4>`;

                html += '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: var(--bg-elevated);">';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Dia</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid var(--border);">Disciplinas e T√≥picos</th>';
                html += '<th style="padding: 10px; text-align: left; border: 1px solid var(--border);">M√©todo</th>';
                html += '</tr></thead><tbody>';

                days.forEach((day, dayIdx) => {
                    html += '<tr style="border: 1px solid var(--border); vertical-align: top;">';
                    html += `<td style="padding: 10px; font-weight: 600;">${day}</td>`;

                    if (dayIdx === 6) { // Sunday
                        html += '<td style="padding: 10px;"><strong style="color: var(--accent-warm);">REVIS√ÉO GERAL</strong><ul style="margin: 5px 0 0 20px; line-height: 1.6;">';
                        subjectsWithTopics.forEach(item => {
                            html += `<li><strong>${item.subject}:</strong> Revisar anota√ß√µes e resolver quest√µes</li>`;
                        });
                        html += '</ul></td>';
                        html += '<td style="padding: 10px;">üìä <strong>Simulado completo</strong><br>Me√ßa seu desempenho</td>';
                    } else {
                        // Distribute subjects across the week
                        const startIdx = (dayIdx * subjectsPerDay) % numSubjects;
                        const todaySubjectsData = [];

                        for (let i = 0; i < subjectsPerDay && todaySubjectsData.length < 3; i++) {
                            const idx = (startIdx + i + (cycle - 1) * subjectsPerDay) % numSubjects;
                            todaySubjectsData.push(subjectsWithTopics[idx]);
                        }

                        if (todaySubjectsData.length > 0) {
                            html += '<td style="padding: 10px;"><ul style="margin: 0; padding: 0; list-style: none; line-height: 1.8;">';

                            todaySubjectsData.forEach(item => {
                                const topicsToShow = item.topics.slice(0, 3); // Max 3 topics per subject per day
                                const startTopicIdx = ((cycle - 1) * 3) % item.topics.length;
                                const rotatedTopics = [
                                    item.topics[startTopicIdx % item.topics.length],
                                    item.topics[(startTopicIdx + 1) % item.topics.length],
                                    item.topics[(startTopicIdx + 2) % item.topics.length]
                                ].filter(t => t !== undefined);

                                html += `<li style="margin-bottom: 10px;"><strong style="color: var(--accent-primary);">${item.subject}:</strong><ul style="margin: 5px 0 0 20px; font-size: 14px; color: var(--text-secondary);">`;

                                rotatedTopics.forEach(topic => {
                                    html += `<li>${topic}</li>`;
                                });

                                html += '</ul></li>';
                            });

                            html += '</ul></td>';

                            // Activity based on cycle
                            if (cycle === 1) {
                                html += '<td style="padding: 10px;">üìñ <strong>Teoria</strong><br>Leitura de lei seca e doutrina</td>';
                            } else if (cycle === 2) {
                                html += '<td style="padding: 10px;">üìù <strong>Teoria + Quest√µes</strong><br>Quest√µes comentadas</td>';
                            } else if (cycle === 3) {
                                html += '<td style="padding: 10px;">üéØ <strong>Quest√µes</strong><br>Foco em treino e erros</td>';
                            } else {
                                html += '<td style="padding: 10px;">üîÑ <strong>Revis√£o</strong><br>Mapas mentais + quest√µes</td>';
                            }
                        } else {
                            html += '<td style="padding: 10px; color: var(--text-secondary);">Descanso</td>';
                            html += '<td style="padding: 10px;">üí§ Dia livre</td>';
                        }
                    }

                    html += '</tr>';
                });

                html += '</tbody></table></div>';
            }

            html += '<div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 15px; border-radius: 8px; color: white;">';
            html += '<h4 style="margin-bottom: 10px;">‚ú® Como usar o Cronograma C√≠clico:</h4>';
            html += '<ul style="margin-left: 20px; line-height: 1.8;">';
            html += '<li><strong>Ciclo 1:</strong> Foco em TEORIA e leitura de lei seca</li>';
            html += '<li><strong>Ciclo 2:</strong> TEORIA + quest√µes comentadas (entender o racioc√≠nio)</li>';
            html += '<li><strong>Ciclo 3:</strong> QUEST√ïES em volume + revisar erros</li>';
            html += '<li><strong>Ciclo 4+:</strong> REVIS√ÉO intensiva + quest√µes de fixa√ß√£o</li>';
            html += '<li><strong>Domingos:</strong> SEMPRE fazer simulado completo para medir evolu√ß√£o</li>';
            html += '</ul>';
            html += '</div>';

            html += '</div>';
            return html;
        }

        // Generate subject summary
        function generateSubjectSummary(text, foundSubjects) {
            let html = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
            html += '<h3 style="color: var(--accent-primary); margin-bottom: 20px;">üìù Resumo dos Assuntos</h3>';

            const summaryTips = {
                'Direito Constitucional': {
                    emoji: 'üéØ',
                    principais: ['Direitos Fundamentais (arts. 5¬∫ ao 17)', 'Organiza√ß√£o do Estado (arts. 18 a 43)', 'Administra√ß√£o P√∫blica (arts. 37 a 43)', 'Controle de Constitucionalidade', 'Poder Legislativo, Executivo e Judici√°rio'],
                    estrategia: 'Leia a CF/88 diariamente! Foque nos artigos mais cobrados (5¬∫, 37, 84, 102, 103)'
                },
                'Constitucional': {
                    emoji: 'üéØ',
                    principais: ['Direitos Fundamentais', 'Organiza√ß√£o do Estado', 'Administra√ß√£o P√∫blica', 'Controle de Constitucionalidade', 'Poderes da Rep√∫blica'],
                    estrategia: 'Leia a CF/88 diariamente! Foque nos artigos mais cobrados'
                },
                'Direito Administrativo': {
                    emoji: 'üèõÔ∏è',
                    principais: ['Princ√≠pios da Administra√ß√£o P√∫blica', 'Atos Administrativos', 'Licita√ß√µes (Lei 14.133/21)', 'Contratos Administrativos', 'Servidores P√∫blicos (Lei 8.112/90)', 'Responsabilidade Civil do Estado', 'Improbidade Administrativa (Lei 8.429/92)'],
                    estrategia: 'Domine a Lei 14.133/21 (nova lei de licita√ß√µes) e Lei 8.112/90. S√£o as mais cobradas!'
                },
                'Administrativo': {
                    emoji: 'üèõÔ∏è',
                    principais: ['Princ√≠pios', 'Atos Administrativos', 'Licita√ß√µes', 'Contratos', 'Servidores P√∫blicos', 'Responsabilidade Civil'],
                    estrategia: 'Domine Lei 14.133/21 e Lei 8.112/90'
                },
                'Portugu√™s': {
                    emoji: 'üìñ',
                    principais: ['Interpreta√ß√£o e Compreens√£o de Textos', 'Ortografia e Acentua√ß√£o', 'Classes Gramaticais', 'Sintaxe (Concord√¢ncia, Reg√™ncia, Crase)', 'Pontua√ß√£o', 'Reda√ß√£o Oficial'],
                    estrategia: 'Leia MUITO! Jornais, editoriais, textos oficiais. Fa√ßa quest√µes diariamente.'
                },
                'L√≠ngua Portuguesa': {
                    emoji: 'üìñ',
                    principais: ['Interpreta√ß√£o de Textos', 'Ortografia', 'Classes Gramaticais', 'Sintaxe', 'Pontua√ß√£o', 'Reda√ß√£o Oficial'],
                    estrategia: 'Leia muito e fa√ßa quest√µes diariamente'
                },
                'Racioc√≠nio L√≥gico': {
                    emoji: 'üßÆ',
                    principais: ['L√≥gica Proposicional (V ou F)', 'Equival√™ncias L√≥gicas', 'Diagramas L√≥gicos (Venn)', 'L√≥gica de Argumenta√ß√£o', 'Sequ√™ncias e Padr√µes', 'An√°lise Combinat√≥ria', 'Probabilidade'],
                    estrategia: 'PRATIQUE! Fa√ßa no m√≠nimo 20 quest√µes por dia. √â mat√©ria de treino, n√£o de teoria.'
                },
                'L√≥gica': {
                    emoji: 'üßÆ',
                    principais: ['L√≥gica Proposicional', 'Equival√™ncias', 'Diagramas', 'Argumenta√ß√£o', 'Sequ√™ncias'],
                    estrategia: 'Fa√ßa 20+ quest√µes por dia. Mat√©ria de treino!'
                },
                'Inform√°tica': {
                    emoji: 'üíª',
                    principais: ['Windows 10/11', 'Linux (Ubuntu)', 'Microsoft Office (Word, Excel, PowerPoint)', 'LibreOffice', 'Navegadores e Internet', 'Seguran√ßa da Informa√ß√£o', 'Redes de Computadores', 'Conceitos de Cloud'],
                    estrategia: 'Excel √© CAMPE√ÉO de quest√µes! Domine f√≥rmulas, fun√ß√µes e formata√ß√£o.'
                },
                'Matem√°tica': {
                    emoji: 'üî¢',
                    principais: ['Porcentagem', 'Regra de 3 Simples e Composta', 'Equa√ß√µes do 1¬∫ e 2¬∫ grau', 'Juros Simples e Compostos', 'Raz√£o e Propor√ß√£o', 'Geometria B√°sica'],
                    estrategia: 'Fa√ßa exerc√≠cios todos os dias! Matem√°tica √© pr√°tica constante.'
                }
            };

            foundSubjects.forEach((subject, idx) => {
                const summary = summaryTips[subject];

                html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px;">`;

                if (summary) {
                    html += `<h4 style="color: var(--accent-primary); margin-bottom: 10px;">${summary.emoji} ${subject}</h4>`;
                    html += '<p style="margin-bottom: 10px;"><strong>Principais T√≥picos:</strong></p>';
                    html += '<ul style="margin-left: 20px; margin-bottom: 15px; line-height: 1.8;">';
                    summary.principais.forEach(topic => {
                        html += `<li>${topic}</li>`;
                    });
                    html += '</ul>';
                    html += `<div style="background: var(--bg-elevated); padding: 10px; border-radius: 6px; border-left: 3px solid var(--accent-warm);">`;
                    html += `<p style="margin: 0;"><strong>üí° Estrat√©gia:</strong> ${summary.estrategia}</p>`;
                    html += '</div>';
                } else {
                    html += `<h4 style="color: var(--accent-primary); margin-bottom: 10px;">üìö ${subject}</h4>`;
                    const topics = extractTopics(text, subject);
                    if (topics.length > 0) {
                        html += '<ul style="margin-left: 20px; line-height: 1.8;">';
                        topics.slice(0, 10).forEach(topic => {
                            html += `<li>${topic}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p style="color: var(--text-secondary);">Consulte o edital para t√≥picos espec√≠ficos</p>';
                    }
                }

                html += '</div>';
            });

            html += '</div>';
            return html;
        }

        // PDF Upload and Processing
        let currentAnalysisUtterance = null;
        let isReadingAnalysis = false;

        const pdfDropArea = document.getElementById('pdfDropArea');
        const pdfFileInput = document.getElementById('pdfFileInput');

        // Click to select file
        pdfDropArea.addEventListener('click', () => {
            pdfFileInput.click();
        });

        // Drag and drop handlers
        pdfDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            pdfDropArea.style.borderColor = 'var(--accent-primary)';
            pdfDropArea.style.background = 'var(--bg-secondary)';
        });

        pdfDropArea.addEventListener('dragleave', () => {
            pdfDropArea.style.borderColor = 'var(--border)';
            pdfDropArea.style.background = 'var(--bg-tertiary)';
        });

        pdfDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            pdfDropArea.style.borderColor = 'var(--border)';
            pdfDropArea.style.background = 'var(--bg-tertiary)';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handlePDFFile(files[0]);
            }
        });

        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handlePDFFile(e.target.files[0]);
            }
        });

        async function handlePDFFile(file) {
            if (!file.type.includes('pdf')) {
                showNotification('‚ö†Ô∏è Por favor, selecione um arquivo PDF');
                return;
            }

            showNotification('üìÑ Processando PDF...');

            try {
                const arrayBuffer = await file.arrayBuffer();

                if (typeof pdfjsLib === 'undefined') {
                    // Fallback if PDF.js not loaded
                    showNotification('‚ö†Ô∏è Biblioteca PDF n√£o dispon√≠vel. Por favor, cole o texto manualmente.');
                    return;
                }

                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let fullText = '';

                // Extract text from all pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }

                // Put extracted text in textarea
                document.getElementById('editalInput').value = fullText;
                showNotification(`‚úÖ PDF processado! ${pdf.numPages} p√°gina(s) extra√≠da(s).`);

                // Auto-analyze
                setTimeout(() => {
                    document.getElementById('analyzeEdital').click();
                }, 500);

            } catch (error) {
                console.error('Erro ao processar PDF:', error);
                showNotification('‚ùå Erro ao processar PDF. Tente colar o texto manualmente.');
            }
        }

        // Function to read analysis aloud
        window.ouvirAnalise = function() {
            const content = document.getElementById('analysisContent');
            if (!content) return;

            const iconEl = document.getElementById('ouvirIcon');
            const textEl = document.getElementById('ouvirText');

            // If already reading, stop
            if (isReadingAnalysis && speechSynthesis.speaking) {
                speechSynthesis.cancel();
                isReadingAnalysis = false;
                iconEl.textContent = 'üéß';
                textEl.textContent = 'Ouvir An√°lise';
                return;
            }

            // Get clean text from HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const textToRead = tempDiv.innerText || tempDiv.textContent;

            if (!textToRead.trim()) {
                showNotification('‚ö†Ô∏è Nenhum conte√∫do para ler');
                return;
            }

            // Get selected speed
            const speedInput = document.getElementById('analysisSpeed');
            const speed = speedInput ? parseFloat(speedInput.value) : 1.0;

            currentAnalysisUtterance = new SpeechSynthesisUtterance(textToRead);
            currentAnalysisUtterance.lang = 'pt-BR';
            currentAnalysisUtterance.rate = speed;

            currentAnalysisUtterance.onstart = () => {
                isReadingAnalysis = true;
                iconEl.textContent = '‚è∏Ô∏è';
                textEl.textContent = 'Parar Leitura';
            };

            currentAnalysisUtterance.onend = () => {
                isReadingAnalysis = false;
                iconEl.textContent = 'üéß';
                textEl.textContent = 'Ouvir An√°lise';
                showNotification('‚úÖ Leitura conclu√≠da!');
            };

            currentAnalysisUtterance.onerror = () => {
                isReadingAnalysis = false;
                iconEl.textContent = 'üéß';
                textEl.textContent = 'Ouvir An√°lise';
            };

            speechSynthesis.speak(currentAnalysisUtterance);
        };

        // ==================== NOVO SISTEMA DE CRONOGRAMA INTELIGENTE ====================

        // ==================== REPOSIT√ìRIO CENTRAL DE DADOS ====================
        // Tudo fica salvo aqui e persiste no localStorage

        const AppData = {
            // Dados do edital analisado
            edital: {
                cargoDesejado: '',
                textoCompleto: '',
                dataProva: '',
                disciplinas: [], // An√°lise completa pela IA ou parser
                analisadoEm: null
            },

            // Dados do cronograma
            cronograma: {
                horasDia: 4,
                nivel: 'intermediario',
                ciclosSemanais: [],
                calendarioMensal: {}
            },

            // Salvar no localStorage
            salvar() {
                Storage.set('appData', {
                    edital: this.edital,
                    cronograma: this.cronograma
                });
            },

            // Carregar do localStorage
            carregar() {
                const dados = Storage.get('appData', null);
                if (dados) {
                    this.edital = dados.edital || this.edital;
                    this.cronograma = dados.cronograma || this.cronograma;
                    return true;
                }
                return false;
            },

            // Limpar tudo
            limpar() {
                this.edital = {
                    cargoDesejado: '',
                    textoCompleto: '',
                    dataProva: '',
                    disciplinas: [],
                    analisadoEm: null
                };
                this.cronograma = {
                    horasDia: 4,
                    nivel: 'intermediario',
                    ciclosSemanais: [],
                    calendarioMensal: {}
                };
                Storage.remove('appData');
            }
        };

        // Vari√°veis globais para o cronograma (DEPRECATED - usar AppData)
        let cronogramaData = {
            cargo: '',
            dataProva: '',
            horasDia: 4,
            disciplinas: [],
            ciclosSemanais: [],
            calendarioMensal: {}
        };

        // ETAPA 1: An√°lise Inteligente do Edital
        async function analisarEditalInteligente() {
            const cargo = document.getElementById('cronoCargo').value.trim();
            const horasDia = document.getElementById('cronoHorasDia').value;
            const nivel = document.getElementById('cronoNivel').value;
            const editalBruto = document.getElementById('cronoEditalBruto').value.trim();

            if (!cargo || !editalBruto) {
                showNotification('‚ö†Ô∏è Preencha o cargo e cole o texto do edital');
                return;
            }

            // Definir dom√≠nio base por n√≠vel
            const dominioBase = {
                'iniciante': 3,
                'intermediario': 5,
                'avancado': 7
            }[nivel];

            // Salvar dados b√°sicos
            cronogramaData.cargo = cargo;
            cronogramaData.horasDia = parseInt(horasDia);
            cronogramaData.nivel = nivel;
            cronogramaData.dominioBase = dominioBase;

            // Mostrar loading
            document.getElementById('cronoLoadingAnalise').style.display = 'block';
            document.getElementById('cronoRaioX').style.display = 'none';

            // Tentar an√°lise com Poe primeiro, fallback para offline
            if (window.Poe) {
                document.getElementById('cronoLoadingSubtext').textContent = 'Processando com an√°lise avan√ßada...';

                // Chamar IA para an√°lise
                const prompt = `Voc√™ √© um especialista em concursos p√∫blicos brasileiros. Analise o edital abaixo e forne√ßa um JSON estruturado com TODAS as informa√ß√µes.

üéØ CARGO: ${cargo}
üìö N√çVEL DO ESTUDANTE: ${nivel}

üìã EDITAL COMPLETO:
${editalBruto}

IMPORTANTE: Retorne APENAS um JSON v√°lido (sem markdown, sem explica√ß√µes) no seguinte formato:

{
  "dataProva": "YYYY-MM-DD ou null se n√£o encontrar",
  "disciplinas": [
    {
      "nome": "Nome da Disciplina",
      "topicos": ["T√≥pico 1", "T√≥pico 2", "T√≥pico 3", ...],
      "volume": 1-10 (escala de volume de conte√∫do),
      "incidencia": 1-10 (frequ√™ncia que cai em provas para esse cargo),
      "complexidade": 1-10 (dificuldade da mat√©ria),
      "dominioAluno": ${dominioBase} (use este valor como base para todas as disciplinas),
      "justificativa": "Breve explica√ß√£o sobre incid√™ncia para o cargo"
    }
  ]
}

INSTRU√á√ïES:
1. Extraia a DATA DA PROVA do texto do edital (procure por datas, cronograma, etc.)
2. Extraia TODOS os t√≥picos detalhados de cada disciplina
3. Use web search (voc√™ tem acesso) para determinar a incid√™ncia real de cada disciplina para o cargo "${cargo}"
4. Para dominioAluno, use ${dominioBase} como valor base (n√≠vel ${nivel})`;

                try {
                    await window.Poe.sendUserMessage(`@GPT-5.1 ${prompt} --web_search True`, {
                        handler: "cronograma-analise-handler",
                        stream: false,
                        openChat: false
                    });
                } catch (err) {
                    // Fallback para an√°lise offline
                    console.log('Poe API falhou, usando an√°lise offline robusta');
                    document.getElementById('cronoLoadingSubtext').textContent = 'Processando localmente...';
                    setTimeout(() => analisarEditalOffline(cargo, editalBruto, dominioBase), 500);
                }
            } else {
                // An√°lise offline direta (sem Poe)
                document.getElementById('cronoLoadingSubtext').textContent = 'Processando localmente...';
                setTimeout(() => analisarEditalOffline(cargo, editalBruto, dominioBase), 500);
            }
        }

        // ==================== AN√ÅLISE OFFLINE ROBUSTA ====================
        // Parser inteligente que funciona 100% offline
        function analisarEditalOffline(cargo, editalBruto, dominioBase) {
            try {
                // 1. DETECTAR DATA DA PROVA
                const dataProva = extrairDataProva(editalBruto);

                // 2. EXTRAIR DISCIPLINAS E T√ìPICOS
                const disciplinas = extrairDisciplinasTopicos(editalBruto, cargo, dominioBase);

                // 3. SALVAR DADOS
                cronogramaData.dataProva = dataProva;
                cronogramaData.disciplinas = disciplinas;

                // 4. CALCULAR DISTRIBUI√á√ÉO
                calcularDistribuicaoHoras();

                // 5. EXIBIR RAIO-X
                exibirRaioX();

                // 6. ESCONDER LOADING
                document.getElementById('cronoLoadingAnalise').style.display = 'none';

                // 7. AVAN√áAR PARA ETAPA 2
                gerarCiclosSemanais();

                showNotification('‚úÖ Edital analisado com sucesso!');

            } catch (err) {
                console.error('Erro na an√°lise offline:', err);
                document.getElementById('cronoLoadingAnalise').style.display = 'none';
                showNotification('‚ùå Erro ao analisar edital. Verifique o formato do texto.');
            }
        }

        // Extrai data da prova do texto
        function extrairDataProva(texto) {
            // Padr√µes de data comuns em editais
            const padroes = [
                /prova.*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/i,
                /data.*?prova.*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/i,
                /(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4}).*?prova/i,
                /aplica[√ßc][√£a]o.*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/i,
            ];

            for (const padrao of padroes) {
                const match = texto.match(padrao);
                if (match) {
                    const dia = match[1].padStart(2, '0');
                    const mes = match[2].padStart(2, '0');
                    const ano = match[3];
                    return `${ano}-${mes}-${dia}`;
                }
            }

            // Padr√£o "DD de MMMM de YYYY"
            const meses = {
                'janeiro': '01', 'fevereiro': '02', 'mar√ßo': '03', 'marco': '03',
                'abril': '04', 'maio': '05', 'junho': '06',
                'julho': '07', 'agosto': '08', 'setembro': '09',
                'outubro': '10', 'novembro': '11', 'dezembro': '12'
            };

            const padraoExtenso = /(\d{1,2})\s+de\s+(\w+)\s+de\s+(\d{4})/i;
            const matchExtenso = texto.match(padraoExtenso);
            if (matchExtenso) {
                const dia = matchExtenso[1].padStart(2, '0');
                const mesNome = matchExtenso[2].toLowerCase();
                const ano = matchExtenso[3];
                const mes = meses[mesNome];
                if (mes) {
                    return `${ano}-${mes}-${dia}`;
                }
            }

            // N√£o encontrou - usar 90 dias no futuro
            const dataFutura = new Date();
            dataFutura.setDate(dataFutura.getDate() + 90);
            return dataFutura.toISOString().split('T')[0];
        }

        // Filtra apenas a se√ß√£o do cargo espec√≠fico no edital
        function filtrarSecaoPorCargo(texto, cargo) {
            // Normalizar cargo para busca
            const cargoNormalizado = cargo.toLowerCase().trim();

            // Padr√µes para identificar se√ß√µes de cargo
            const padroesCargo = [
                // Padr√£o: "CARGO: Arquiteto" ou "CARGO - Arquiteto" ou "1. Arquiteto"
                new RegExp(`(?:cargo|fun√ß√£o|emprego|especialidade)[:\\s-]+[^\\n]*${cargoNormalizado}[^\\n]*`, 'i'),
                // Padr√£o: S√≥ o nome do cargo em mai√∫sculas ou com n√∫meros
                new RegExp(`^[\\d\\.\\)]*\\s*${cargoNormalizado}\\s*[\\d\\.\\)]*$`, 'im'),
                // Padr√£o: "Para o cargo de Arquiteto"
                new RegExp(`para\\s+(?:o\\s+)?cargo\\s+de\\s+[^\\n]*${cargoNormalizado}[^\\n]*`, 'i'),
            ];

            // Tentar encontrar onde come√ßa a se√ß√£o do cargo
            let inicioSecao = -1;
            let matchEncontrado = null;

            for (const padrao of padroesCargo) {
                const match = texto.match(padrao);
                if (match) {
                    inicioSecao = match.index;
                    matchEncontrado = match[0];
                    break;
                }
            }

            if (inicioSecao === -1) {
                // N√£o encontrou se√ß√£o espec√≠fica - retornar texto completo
                console.log('‚ö†Ô∏è Se√ß√£o do cargo n√£o identificada. Processando edital completo.');
                return texto;
            }

            // Encontrou! Agora precisa identificar onde TERMINA a se√ß√£o deste cargo
            const textoAPartir = texto.substring(inicioSecao);

            // Padr√µes que indicam in√≠cio de OUTRO cargo (fim da se√ß√£o atual)
            const padroesFimSecao = [
                /\n(?:cargo|fun√ß√£o|emprego|especialidade)[:\s-]+(?!.*${cargoNormalizado})/i,
                /\n\d+\.?\s+[A-Z][A-Z\s]+(?:CONHECIMENTOS|CONTE√öDO)/i, // Nova se√ß√£o em mai√∫sculas
                /\n(?:ANEXO|QUADRO)\s+(?:I{1,3}|[0-9]+)/i, // Novo anexo
                /\nCONCURSO\s+P√öBLICO/i, // Novo concurso
            ];

            let fimSecao = textoAPartir.length;

            for (const padrao of padroesFimSecao) {
                const match = textoAPartir.substring(100).match(padrao); // Pular primeiros 100 chars
                if (match) {
                    fimSecao = 100 + match.index;
                    break;
                }
            }

            const secaoFiltrada = textoAPartir.substring(0, fimSecao);

            console.log(`‚úÖ Se√ß√£o do cargo "${cargo}" identificada (${secaoFiltrada.length} caracteres)`);

            return secaoFiltrada;
        }

        // Extrai disciplinas e t√≥picos do edital
        function extrairDisciplinasTopicos(texto, cargo, dominioBase) {
            const disciplinas = [];

            // FILTRO POR CARGO: Tentar isolar apenas a se√ß√£o do cargo espec√≠fico
            texto = filtrarSecaoPorCargo(texto, cargo);

            // Base de conhecimento de disciplinas comuns
            const disciplinasConhecidas = {
                // Direito
                'direito constitucional': { keywords: ['constitucional', 'constitui√ß√£o'], complexidade: 7 },
                'direito administrativo': { keywords: ['administrativo', 'ato administrativo', 'licita√ß√£o'], complexidade: 8 },
                'direito civil': { keywords: ['civil', 'c√≥digo civil', 'contratos'], complexidade: 7 },
                'direito penal': { keywords: ['penal', 'c√≥digo penal', 'crimes'], complexidade: 8 },
                'direito processual civil': { keywords: ['processual civil', 'processo civil', 'cpc'], complexidade: 9 },
                'direito processual penal': { keywords: ['processual penal', 'processo penal', 'cpp'], complexidade: 9 },
                'direito do trabalho': { keywords: ['trabalho', 'clt', 'trabalhista'], complexidade: 7 },
                'direito tribut√°rio': { keywords: ['tribut√°rio', 'tributos', 'impostos'], complexidade: 8 },
                'direito previdenci√°rio': { keywords: ['previdenci√°rio', 'previd√™ncia', 'inss'], complexidade: 7 },

                // Conhecimentos Gerais
                'portugu√™s': { keywords: ['portugu√™s', 'l√≠ngua portuguesa', 'gram√°tica'], complexidade: 6 },
                'ingl√™s': { keywords: ['ingl√™s', 'l√≠ngua inglesa', 'english'], complexidade: 5 },
                'matem√°tica': { keywords: ['matem√°tica', 'c√°lculo'], complexidade: 7 },
                'racioc√≠nio l√≥gico': { keywords: ['racioc√≠nio l√≥gico', 'l√≥gica'], complexidade: 7 },
                'inform√°tica': { keywords: ['inform√°tica', 'computa√ß√£o', 'software'], complexidade: 5 },
                'atualidades': { keywords: ['atualidades', 'conhecimentos gerais'], complexidade: 4 },

                // Espec√≠ficas
                'contabilidade': { keywords: ['contabilidade', 'cont√°bil'], complexidade: 8 },
                'economia': { keywords: ['economia', 'econ√¥mico'], complexidade: 7 },
                'administra√ß√£o': { keywords: ['administra√ß√£o', 'gest√£o'], complexidade: 6 },
                'estat√≠stica': { keywords: ['estat√≠stica', 'probabilidade'], complexidade: 8 },
                'arquivologia': { keywords: ['arquivologia', 'arquivo'], complexidade: 6 },
            };

            // Detectar incid√™ncia baseada no cargo
            function calcularIncidencia(disciplina, cargo) {
                const cargoLower = cargo.toLowerCase();

                // Regras de incid√™ncia por tipo de cargo
                if (cargoLower.includes('tribunal') || cargoLower.includes('judici√°rio') || cargoLower.includes('analista judici√°rio')) {
                    if (disciplina.includes('processual')) return 10;
                    if (disciplina.includes('constitucional')) return 9;
                    if (disciplina.includes('administrativo')) return 9;
                    if (disciplina.includes('penal') || disciplina.includes('civil')) return 8;
                }

                if (cargoLower.includes('fiscal') || cargoLower.includes('auditor')) {
                    if (disciplina.includes('tribut√°rio')) return 10;
                    if (disciplina.includes('contabilidade')) return 10;
                    if (disciplina.includes('administrativo')) return 8;
                }

                if (cargoLower.includes('t√©cnico')) {
                    if (disciplina.includes('portugu√™s')) return 9;
                    if (disciplina.includes('inform√°tica')) return 8;
                    if (disciplina.includes('matem√°tica')) return 7;
                }

                // Incid√™ncia padr√£o
                if (disciplina.includes('portugu√™s')) return 9;
                if (disciplina.includes('constitucional')) return 8;
                if (disciplina.includes('administrativo')) return 8;

                return 6; // Padr√£o
            }

            // Tentar identificar se√ß√µes de disciplinas
            const linhas = texto.split('\n');
            let disciplinaAtual = null;
            let topicosAtuais = [];

            for (let i = 0; i < linhas.length; i++) {
                const linha = linhas[i].trim();
                if (!linha) continue;

                // Detectar in√≠cio de disciplina (padr√µes comuns)
                let isDisciplina = false;
                let nomeDisciplina = '';

                // Padr√£o: "DISCIPLINA:" ou "1. DISCIPLINA" ou "CONHECIMENTOS DE:"
                for (const [nome, info] of Object.entries(disciplinasConhecidas)) {
                    for (const keyword of info.keywords) {
                        if (linha.toLowerCase().includes(keyword) &&
                            (linha.length < 100 || linha.match(/^[\d\.\)]+\s*[A-Z]/))) {
                            isDisciplina = true;
                            nomeDisciplina = nome.charAt(0).toUpperCase() + nome.slice(1);
                            break;
                        }
                    }
                    if (isDisciplina) break;
                }

                if (isDisciplina) {
                    // Salvar disciplina anterior
                    if (disciplinaAtual && topicosAtuais.length > 0) {
                        const info = disciplinasConhecidas[disciplinaAtual.toLowerCase()] || {};
                        disciplinas.push({
                            nome: disciplinaAtual,
                            topicos: [...topicosAtuais],
                            volume: Math.min(10, Math.max(3, Math.ceil(topicosAtuais.length / 3))),
                            incidencia: calcularIncidencia(disciplinaAtual, cargo),
                            complexidade: info.complexidade || 6,
                            dominioAluno: dominioBase,
                            justificativa: `Disciplina identificada no edital para ${cargo}`
                        });
                    }

                    // Iniciar nova disciplina
                    disciplinaAtual = nomeDisciplina;
                    topicosAtuais = [];
                } else if (disciplinaAtual) {
                    // Adicionar como t√≥pico
                    const topicoLimpo = linha.replace(/^[\d\.\)]+\s*/, '').trim();
                    if (topicoLimpo.length > 5 && topicoLimpo.length < 200) {
                        topicosAtuais.push(topicoLimpo);
                    }
                }
            }

            // Salvar √∫ltima disciplina
            if (disciplinaAtual && topicosAtuais.length > 0) {
                const info = disciplinasConhecidas[disciplinaAtual.toLowerCase()] || {};
                disciplinas.push({
                    nome: disciplinaAtual,
                    topicos: [...topicosAtuais],
                    volume: Math.min(10, Math.max(3, Math.ceil(topicosAtuais.length / 3))),
                    incidencia: calcularIncidencia(disciplinaAtual, cargo),
                    complexidade: info.complexidade || 6,
                    dominioAluno: dominioBase,
                    justificativa: `Disciplina identificada no edital para ${cargo}`
                });
            }

            // Se n√£o encontrou nenhuma disciplina, tentar m√©todo alternativo
            if (disciplinas.length === 0) {
                // Usar todas as disciplinas conhecidas que aparecem no texto
                for (const [nome, info] of Object.entries(disciplinasConhecidas)) {
                    for (const keyword of info.keywords) {
                        if (texto.toLowerCase().includes(keyword)) {
                            disciplinas.push({
                                nome: nome.charAt(0).toUpperCase() + nome.slice(1),
                                topicos: ['Conforme conte√∫do program√°tico do edital'],
                                volume: 5,
                                incidencia: calcularIncidencia(nome, cargo),
                                complexidade: info.complexidade || 6,
                                dominioAluno: dominioBase,
                                justificativa: `Disciplina identificada no edital para ${cargo}`
                            });
                            break;
                        }
                    }
                }
            }

            return disciplinas;
        }

        // Processa o JSON retornado pela IA
        function processarAnaliseIA(conteudoIA) {
            try {
                // Tentar extrair JSON do conte√∫do (pode vir com markdown)
                let jsonStr = conteudoIA;

                // Remover blocos de c√≥digo markdown se existirem
                const jsonMatch = conteudoIA.match(/```(?:json)?\s*(\{[\s\S]*?\})\s*```/);
                if (jsonMatch) {
                    jsonStr = jsonMatch[1];
                } else if (conteudoIA.includes('{') && conteudoIA.includes('}')) {
                    // Tentar extrair JSON diretamente
                    const inicio = conteudoIA.indexOf('{');
                    const fim = conteudoIA.lastIndexOf('}') + 1;
                    jsonStr = conteudoIA.substring(inicio, fim);
                }

                const dados = JSON.parse(jsonStr);

                if (!dados.disciplinas || !Array.isArray(dados.disciplinas)) {
                    throw new Error('Formato inv√°lido: disciplinas n√£o encontradas');
                }

                // Extrair data da prova
                if (dados.dataProva && dados.dataProva !== 'null') {
                    cronogramaData.dataProva = dados.dataProva;
                } else {
                    // Se n√£o encontrou, usar 90 dias a partir de hoje como padr√£o
                    const dataFutura = new Date();
                    dataFutura.setDate(dataFutura.getDate() + 90);
                    cronogramaData.dataProva = dataFutura.toISOString().split('T')[0];
                    showNotification('‚ö†Ô∏è Data da prova n√£o encontrada no edital. Usando 90 dias como padr√£o. Voc√™ pode editar depois.');
                }

                // Salvar disciplinas
                cronogramaData.disciplinas = dados.disciplinas.map(d => ({
                    nome: d.nome || '',
                    topicos: d.topicos || [],
                    volume: parseInt(d.volume) || 5,
                    incidencia: parseInt(d.incidencia) || 5,
                    complexidade: parseInt(d.complexidade) || 5,
                    dominioAluno: parseInt(d.dominioAluno) || cronogramaData.dominioBase || 5,
                    justificativa: d.justificativa || '',
                    horasSugeridas: 0 // Ser√° calculado
                }));

                // Calcular distribui√ß√£o de horas
                calcularDistribuicaoHoras();

                // Exibir Raio-X
                exibirRaioX();

                // Esconder loading
                document.getElementById('cronoLoadingAnalise').style.display = 'none';

                // Avan√ßar para Etapa 2
                gerarCiclosSemanais();

            } catch (err) {
                console.error('Erro ao processar resposta da IA:', err);
                document.getElementById('cronoLoadingAnalise').style.display = 'none';
                showNotification('‚ùå Erro ao processar resposta da IA. Verifique se o formato est√° correto.');

                // Exibir resposta bruta para debug
                document.getElementById('cronoRaioX').innerHTML = `
                    <div style="background: var(--danger); color: white; padding: 15px; border-radius: 8px;">
                        <h4>‚ùå Erro ao processar JSON</h4>
                        <p>Resposta recebida:</p>
                        <pre style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; overflow-x: auto;">${conteudoIA}</pre>
                    </div>
                `;
                document.getElementById('cronoRaioX').style.display = 'block';
            }
        }

        // Calcula distribui√ß√£o de horas com base nos 4 fatores
        function calcularDistribuicaoHoras() {
            const totalDisciplinas = cronogramaData.disciplinas.length;

            // Calcular pontua√ß√£o de prioridade para cada disciplina
            cronogramaData.disciplinas.forEach(disc => {
                // F√≥rmula de prioridade:
                // volume (quanto mais, mais horas)
                // incid√™ncia (quanto mais, mais horas)
                // complexidade (quanto mais, mais horas)
                // dom√≠nio do aluno (quanto MENOS dom√≠nio, MAIS horas)

                const faltaDominio = 10 - disc.dominioAluno; // Inverter dom√≠nio
                disc.pontuacaoPrioridade = (
                    (disc.volume * 0.25) +
                    (disc.incidencia * 0.35) +
                    (disc.complexidade * 0.20) +
                    (faltaDominio * 0.20)
                );
            });

            // Calcular total de pontos
            const totalPontos = cronogramaData.disciplinas.reduce((sum, d) => sum + d.pontuacaoPrioridade, 0);

            // Distribuir horas proporcionalmente
            const horasSemanais = cronogramaData.horasDia * 6; // 6 dias (domingo = revis√£o)
            cronogramaData.disciplinas.forEach(disc => {
                const proporcao = disc.pontuacaoPrioridade / totalPontos;
                disc.horasSugeridas = Math.round(proporcao * horasSemanais * 10) / 10; // 1 casa decimal
            });

            // Ajustar para garantir que a soma seja exata
            const somaHoras = cronogramaData.disciplinas.reduce((sum, d) => sum + d.horasSugeridas, 0);
            if (somaHoras !== horasSemanais) {
                const diferenca = horasSemanais - somaHoras;
                cronogramaData.disciplinas[0].horasSugeridas += diferenca;
                cronogramaData.disciplinas[0].horasSugeridas = Math.round(cronogramaData.disciplinas[0].horasSugeridas * 10) / 10;
            }
        }

        // Exibe o Raio-X do edital
        function exibirRaioX() {
            const container = document.getElementById('cronoRaioX');

            // Calcular dias restantes
            const dataProva = new Date(cronogramaData.dataProva);
            const hoje = new Date();
            const diasRestantes = Math.ceil((dataProva - hoje) / (1000 * 60 * 60 * 24));
            const dataProvaFormatada = dataProva.toLocaleDateString('pt-BR');

            let html = `
                <div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 25px; border-radius: 12px; color: white; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 24px;">üî¨ Raio-X Completo do Edital</h3>
                    <p style="margin: 0; opacity: 0.95; font-size: 18px;"><strong>${cronogramaData.cargo}</strong></p>
                    <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                        üìÖ Data da Prova: <strong>${dataProvaFormatada}</strong> ¬∑
                        ‚è∞ Faltam <strong>${diasRestantes} dias</strong> ¬∑
                        üìö ${cronogramaData.disciplinas.length} disciplinas analisadas
                    </p>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--accent-primary); color: white;">
                                <th style="padding: 12px; text-align: left;">Disciplina</th>
                                <th style="padding: 12px; text-align: center;">Volume</th>
                                <th style="padding: 12px; text-align: center;">Incid√™ncia</th>
                                <th style="padding: 12px; text-align: center;">Complexidade</th>
                                <th style="padding: 12px; text-align: center;">Seu Dom√≠nio</th>
                                <th style="padding: 12px; text-align: center;">Horas/Semana</th>
                                <th style="padding: 12px; text-align: center;">T√≥picos</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            cronogramaData.disciplinas.forEach((disc, idx) => {
                const bgColor = idx % 2 === 0 ? 'var(--bg-secondary)' : 'var(--bg-tertiary)';
                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px;">
                            <strong style="color: var(--text-primary);">${disc.nome}</strong>
                            ${disc.justificativa ? `<br><span style="font-size: 12px; color: var(--text-secondary);">${disc.justificativa}</span>` : ''}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: inline-block; background: var(--accent-warm); color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">
                                ${disc.volume}/10
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: inline-block; background: var(--accent-primary); color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">
                                ${disc.incidencia}/10
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: inline-block; background: var(--danger); color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">
                                ${disc.complexidade}/10
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="display: inline-block; background: var(--success); color: white; padding: 4px 10px; border-radius: 4px; font-weight: 600;">
                                ${disc.dominioAluno}/10
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 700; color: var(--accent-primary);">
                                ${disc.horasSugeridas}h
                            </div>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="exibirTopicosDisciplina(${idx})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">
                                Ver ${disc.topicos.length} t√≥picos
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--accent-primary);">
                    <h4 style="margin: 0 0 10px 0; color: var(--accent-primary);">üìä Legenda dos Fatores</h4>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                        <li><strong>Volume:</strong> Quantidade de conte√∫do da disciplina (1=pouco, 10=muito)</li>
                        <li><strong>Incid√™ncia:</strong> Frequ√™ncia que a mat√©ria cai em provas para o cargo <em>${cronogramaData.cargo}</em> (baseado em pesquisa web)</li>
                        <li><strong>Complexidade:</strong> Dificuldade da mat√©ria (1=f√°cil, 10=dif√≠cil)</li>
                        <li><strong>Seu Dom√≠nio:</strong> N√≠vel atual de conhecimento (1=iniciante, 10=expert)</li>
                        <li><strong>Horas/Semana:</strong> Distribui√ß√£o autom√°tica considerando os 4 fatores acima</li>
                    </ul>
                </div>
            `;

            container.innerHTML = html;
            container.style.display = 'block';
        }

        // Exibe t√≥picos de uma disciplina em modal
        function exibirTopicosDisciplina(idx) {
            const disc = cronogramaData.disciplinas[idx];

            let html = `
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    Total de <strong>${disc.topicos.length} t√≥picos</strong> identificados:
                </p>
                <ul style="column-count: 2; column-gap: 20px; line-height: 1.8; color: var(--text-primary);">
            `;

            disc.topicos.forEach(topico => {
                html += `<li>${topico}</li>`;
            });

            html += `</ul>`;

            showCustomDialog(`üìö ${disc.nome}`, html);
        }

        // ETAPA 2: Gerar Ciclos Semanais
        function gerarCiclosSemanais() {
            // Mostrar se√ß√£o de ciclos
            document.getElementById('cronogramaEtapa2').style.display = 'block';

            // Calcular quantas semanas at√© a prova
            const dataProva = new Date(cronogramaData.dataProva);
            const hoje = new Date();
            const diasRestantes = Math.ceil((dataProva - hoje) / (1000 * 60 * 60 * 24));
            const semanasDisponiveis = Math.floor(diasRestantes / 7);

            // Criar ciclos semanais
            const container = document.getElementById('cronoCiclosSemanais');

            let html = `
                <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 10px 0;">üìÖ Distribui√ß√£o Semanal</h4>
                    <p style="margin: 0; color: var(--text-secondary);">
                        <strong>${semanasDisponiveis} semanas</strong> at√© a prova ¬∑
                        <strong>${cronogramaData.horasDia}h/dia</strong> ¬∑
                        <strong>${cronogramaData.horasDia * 6}h/semana</strong> (6 dias + 1 revis√£o)
                    </p>
                </div>

                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: var(--accent-primary); color: white;">
                                <th style="padding: 12px; text-align: left;">Disciplina</th>
                                <th style="padding: 12px; text-align: center;">Horas/Semana</th>
                                <th style="padding: 12px; text-align: center;">Distribui√ß√£o</th>
                                <th style="padding: 12px; text-align: center;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            cronogramaData.disciplinas.forEach((disc, idx) => {
                const bgColor = idx % 2 === 0 ? 'var(--bg-secondary)' : 'var(--bg-tertiary)';

                // Calcular quantos dias por semana
                const diasPorSemana = Math.round((disc.horasSugeridas / cronogramaData.horasDia) * 10) / 10;

                html += `
                    <tr style="background: ${bgColor}; border-bottom: 1px solid var(--border);">
                        <td style="padding: 12px;">
                            <strong style="color: var(--text-primary);">${disc.nome}</strong>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <input
                                type="number"
                                value="${disc.horasSugeridas}"
                                min="0.5"
                                step="0.5"
                                style="width: 70px; padding: 6px; text-align: center; border: 2px solid var(--border); border-radius: 4px; background: var(--bg-primary); color: var(--text-primary);"
                                onchange="atualizarHorasDisciplina(${idx}, this.value)"
                            >
                        </td>
                        <td style="padding: 12px; text-align: center; font-size: 13px; color: var(--text-secondary);">
                            ‚âà ${diasPorSemana} dias/semana
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="editarDisciplinaCrono(${idx})" class="btn btn-secondary" style="padding: 6px 12px; font-size: 13px;">
                                ‚úèÔ∏è Editar
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, var(--success), var(--accent-warm)); color: white; border-radius: 8px;">
                    <h4 style="margin: 0 0 10px 0;">‚úÖ Sistema Totalmente Edit√°vel</h4>
                    <p style="margin: 0; line-height: 1.6;">
                        Ajuste as horas de cada disciplina conforme sua necessidade. O sistema redistribui automaticamente para manter o total de horas/semana.
                    </p>
                </div>
            `;

            container.innerHTML = html;
        }

        // Atualiza horas de uma disciplina
        function atualizarHorasDisciplina(idx, novoValor) {
            const novasHoras = parseFloat(novoValor);
            if (isNaN(novasHoras) || novasHoras < 0) return;

            cronogramaData.disciplinas[idx].horasSugeridas = novasHoras;

            // Atualizar display
            gerarCiclosSemanais();

            showNotification(`‚úÖ Horas de ${cronogramaData.disciplinas[idx].nome} atualizadas para ${novasHoras}h/semana`);
        }

        // Editar disciplina (modal)
        function editarDisciplinaCrono(idx) {
            const disc = cronogramaData.disciplinas[idx];

            let html = `
                <div class="input-group">
                    <label>Volume (1-10)</label>
                    <input type="number" id="editVolume" value="${disc.volume}" min="1" max="10">
                </div>
                <div class="input-group">
                    <label>Incid√™ncia (1-10)</label>
                    <input type="number" id="editIncidencia" value="${disc.incidencia}" min="1" max="10">
                </div>
                <div class="input-group">
                    <label>Complexidade (1-10)</label>
                    <input type="number" id="editComplexidade" value="${disc.complexidade}" min="1" max="10">
                </div>
                <div class="input-group">
                    <label>Seu Dom√≠nio (1-10)</label>
                    <input type="number" id="editDominio" value="${disc.dominioAluno}" min="1" max="10">
                </div>
                <button class="btn" onclick="salvarEdicaoDisciplina(${idx})" style="width: 100%; margin-top: 10px;">
                    üíæ Salvar e Recalcular
                </button>
            `;

            showCustomDialog(`‚úèÔ∏è Editar ${disc.nome}`, html);
        }

        // Salva edi√ß√£o e recalcula distribui√ß√£o
        function salvarEdicaoDisciplina(idx) {
            const disc = cronogramaData.disciplinas[idx];

            disc.volume = parseInt(document.getElementById('editVolume').value) || 5;
            disc.incidencia = parseInt(document.getElementById('editIncidencia').value) || 5;
            disc.complexidade = parseInt(document.getElementById('editComplexidade').value) || 5;
            disc.dominioAluno = parseInt(document.getElementById('editDominio').value) || 5;

            // Recalcular distribui√ß√£o
            calcularDistribuicaoHoras();

            // Atualizar displays
            exibirRaioX();
            gerarCiclosSemanais();

            // Fechar modal
            document.querySelector('.custom-dialog-overlay')?.remove();

            showNotification(`‚úÖ ${disc.nome} atualizada! Distribui√ß√£o recalculada.`);
        }

        // ETAPA 3: Gerar Calend√°rio Mensal
        function gerarCalendarioMensal() {
            document.getElementById('cronogramaEtapa3').style.display = 'block';
            const container = document.getElementById('cronoCalendarioMensal');

            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìÜ</div>
                    <h3 style="color: var(--text-primary); margin-bottom: 10px;">Calend√°rio Visual em Desenvolvimento</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        Esta funcionalidade incluir√°:<br>
                        ‚Ä¢ Visualiza√ß√£o mensal estilo calend√°rio<br>
                        ‚Ä¢ Distribui√ß√£o das disciplinas por dia<br>
                        ‚Ä¢ Links do YouTube para cada t√≥pico<br>
                        ‚Ä¢ Rastreamento de horas planejadas vs. realizadas<br>
                        ‚Ä¢ Domingos dedicados a simulados
                    </p>
                    <p style="color: var(--accent-primary); font-weight: 600;">
                        üöÄ Implementa√ß√£o prevista na pr√≥xima atualiza√ß√£o!
                    </p>
                </div>
            `;

            // Scroll suave at√© a se√ß√£o
            document.getElementById('cronogramaEtapa3').scrollIntoView({ behavior: 'smooth' });
        }

        // Fun√ß√£o legada (manter para compatibilidade, mas n√£o usar)
        async function generateCronograma() {
            showNotification('‚ö†Ô∏è Use o novo sistema de cronograma inteligente na aba Cronograma!');
        }

        function generateCronogramaOffline(concurso, dataProva, horasDia, materias, nivel, diasRestantes) {
            const materiasArray = materias.split('\n').filter(m => m.trim());
            const numMaterias = materiasArray.length;

            // IMPORTANTE: Terminar 1 semana ANTES da prova (√∫ltima semana = s√≥ revis√£o)
            const diasParaEstudar = Math.max(7, diasRestantes - 7);
            const ultimaSemanaRevisao = diasRestantes > 7;

            let html = `<h3>üìÖ Cronograma Personalizado - ${concurso}</h3>`;

            // Summary
            html += `<div style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); padding: 20px; border-radius: 8px; margin: 20px 0; color: white;">`;
            html += `<h4 style="margin-bottom: 10px;">üìä Resumo do Plano</h4>`;
            html += `<p><strong>üéØ Concurso:</strong> ${concurso}</p>`;
            html += `<p><strong>üìÖ Data da Prova:</strong> ${new Date(dataProva).toLocaleDateString('pt-BR')}</p>`;
            html += `<p><strong>‚è∞ Dias restantes:</strong> ${diasRestantes} dias</p>`;
            html += `<p><strong>üìö Dias de estudo:</strong> ${diasParaEstudar} dias (√∫ltima semana = revis√£o intensiva)</p>`;
            html += `<p><strong>‚è±Ô∏è Horas por dia:</strong> ${horasDia}h</p>`;
            html += `<p><strong>üìö Total de mat√©rias:</strong> ${numMaterias}</p>`;
            html += `<p><strong>üí™ N√≠vel:</strong> ${nivel.charAt(0).toUpperCase() + nivel.slice(1)}</p>`;
            html += `</div>`;

            // Calculate distribution (usando diasParaEstudar, N√ÉO diasRestantes)
            const totalHoras = diasParaEstudar * horasDia;
            const semanas = Math.floor(diasParaEstudar / 7);

            html += `<h4>üéØ Estrat√©gia de Estudo</h4>`;
            html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;

            if (diasRestantes < 30) {
                html += `<p><strong>‚ö° MODO INTENSIVO:</strong> Menos de 30 dias para a prova!</p>`;
                html += `<ul>`;
                html += `<li>Foque nas mat√©rias de maior peso</li>`;
                html += `<li>Fa√ßa no m√≠nimo 1 simulado por semana</li>`;
                html += `<li>Revise diariamente o que estudou</li>`;
                html += `<li>√öltimos 7 dias: apenas revis√£o e simulados</li>`;
                html += `</ul>`;
            } else if (diasRestantes < 90) {
                html += `<p><strong>üéØ MODO FOCADO:</strong> Tempo moderado para prepara√ß√£o</p>`;
                html += `<ul>`;
                html += `<li>Ciclo completo de todas as mat√©rias</li>`;
                html += `<li>1 simulado a cada 2 semanas</li>`;
                html += `<li>√öltimos 30 dias: foco em revis√£o</li>`;
                html += `<li>Use flashcards para memoriza√ß√£o</li>`;
                html += `</ul>`;
            } else {
                html += `<p><strong>üìö MODO COMPLETO:</strong> Tempo ideal para prepara√ß√£o profunda</p>`;
                html += `<ul>`;
                html += `<li>Estudo aprofundado de teoria</li>`;
                html += `<li>M√∫ltiplos ciclos de revis√£o</li>`;
                html += `<li>Simulados mensais</li>`;
                html += `<li>Tempo para corre√ß√£o de defici√™ncias</li>`;
                html += `</ul>`;
            }
            html += `</div>`;

            // Weekly distribution WITH TOPICS
            html += `<h4>üìÜ Distribui√ß√£o Semanal com Assuntos Espec√≠ficos (${semanas} semanas)</h4>`;
            html += `<p style="color: var(--text-secondary); margin-bottom: 15px;">Cada dia com t√≥picos espec√≠ficos do edital para garantir cobertura completa</p>`;

            const diasSemana = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];

            // Extract topics for each subject - USE GLOBAL EXTRACTED TOPICS FROM EDITAL!
            const materiasComTopicos = [];
            materiasArray.forEach(materiaLine => {
                // Try to separate subject name from topics
                // Format can be: "Portugu√™s: topic1, topic2" or just "Portugu√™s"
                const parts = materiaLine.split(':');
                const nomeMateria = parts[0].trim();
                const topicosManual = parts[1] ? parts[1].split(',').map(t => t.trim()).filter(t => t) : [];

                // PRIORITY: Use global extracted topics from edital analysis if available
                let topicosParaUsar = topicosManual;

                if (topicosManual.length === 0 && extractedEditalTopics[nomeMateria] && extractedEditalTopics[nomeMateria].length > 0) {
                    topicosParaUsar = extractedEditalTopics[nomeMateria];
                    console.log(`‚úÖ Usando ${topicosParaUsar.length} t√≥picos extra√≠dos do edital para: ${nomeMateria}`);
                } else if (topicosManual.length === 0) {
                    // Try fuzzy match (case insensitive, partial match)
                    const matchKey = Object.keys(extractedEditalTopics).find(key =>
                        key.toLowerCase().includes(nomeMateria.toLowerCase()) ||
                        nomeMateria.toLowerCase().includes(key.toLowerCase())
                    );
                    if (matchKey && extractedEditalTopics[matchKey].length > 0) {
                        topicosParaUsar = extractedEditalTopics[matchKey];
                        console.log(`‚úÖ Match fuzzy! Usando ${topicosParaUsar.length} t√≥picos de "${matchKey}" para: ${nomeMateria}`);
                    } else {
                        topicosParaUsar = ['Consulte o conte√∫do program√°tico no edital'];
                        console.log(`‚ö†Ô∏è Nenhum t√≥pico encontrado para: ${nomeMateria}`);
                    }
                }

                materiasComTopicos.push({
                    nome: nomeMateria,
                    topicos: topicosParaUsar
                });
            });

            html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">`;

            const topicosPorSemana = Math.ceil(materiasComTopicos.reduce((sum, m) => sum + m.topicos.length, 0) / semanas);

            for (let sem = 1; sem <= Math.min(4, semanas); sem++) {
                html += `<h5>üìå Semana ${sem}</h5>`;
                html += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">`;
                html += `<thead><tr style="background: var(--bg-elevated);">`;
                html += `<th style="padding: 10px; text-align: left;">Dia</th>`;
                html += `<th style="padding: 10px; text-align: left;">Disciplinas e Assuntos</th>`;
                html += `<th style="padding: 10px; text-align: center;">Horas</th>`;
                html += `</tr></thead><tbody>`;

                // Track what was studied this week for Sunday revision
                const topicosEstudadosNaSemana = [];

                diasSemana.forEach((dia, idx) => {
                    html += `<tr style="border-bottom: 1px solid var(--border); vertical-align: top;">`;
                    html += `<td style="padding: 10px;"><strong>${dia}</strong></td>`;

                    if (idx === 6) { // Domingo - REVIS√ÉO APENAS DO QUE FOI ESTUDADO NA SEMANA
                        html += `<td style="padding: 10px;"><strong style="color: var(--accent-warm);">üìä REVIS√ÉO DA SEMANA + SIMULADO</strong><br>`;
                        html += `<p style="font-size: 13px; color: var(--text-secondary); margin: 5px 0;">Revise apenas o que voc√™ estudou esta semana:</p>`;
                        html += `<ul style="margin: 5px 0 0 20px; font-size: 14px; color: var(--text-secondary);">`;

                        // Show only what was studied this week
                        topicosEstudadosNaSemana.forEach(item => {
                            html += `<li><strong>${item.materia}:</strong> ${item.topicos.join(', ')}</li>`;
                        });

                        html += `</ul>`;
                        html += `<p style="font-size: 13px; color: var(--accent-warm); margin-top: 10px;"><strong>üíØ Simulado:</strong> Fa√ßa quest√µes APENAS dos t√≥picos acima para testar sua compreens√£o da semana!</p>`;
                        html += `</td>`;
                        html += `<td style="padding: 10px; text-align: center;">${horasDia}h</td>`;
                    } else {
                        // Distribute subjects across the week
                        const numMateriasHoje = (idx === 5) ? 2 : 2; // 2 subjects per day
                        const startIdx = (idx + (sem - 1) * 6) % materiasComTopicos.length;

                        html += `<td style="padding: 10px;">`;
                        html += `<ul style="margin: 0; padding: 0; list-style: none; line-height: 2;">`;

                        for (let i = 0; i < numMateriasHoje; i++) {
                            const materiaIdx = (startIdx + i) % materiasComTopicos.length;
                            const materia = materiasComTopicos[materiaIdx];

                            // Calculate which topics to show this week for this subject
                            const topicosParaHoje = [];
                            const topicosPerCycle = Math.max(1, Math.floor(materia.topicos.length / Math.min(4, semanas)));
                            const startTopicIdx = ((sem - 1) * topicosPerCycle) % materia.topicos.length;

                            for (let t = 0; t < Math.min(3, topicosPerCycle); t++) {
                                const topicIdx = (startTopicIdx + t) % materia.topicos.length;
                                if (materia.topicos[topicIdx]) {
                                    topicosParaHoje.push(materia.topicos[topicIdx]);
                                }
                            }

                            // TRACK TOPICS FOR SUNDAY REVISION
                            if (topicosParaHoje.length > 0) {
                                const existing = topicosEstudadosNaSemana.find(item => item.materia === materia.nome);
                                if (existing) {
                                    existing.topicos.push(...topicosParaHoje);
                                } else {
                                    topicosEstudadosNaSemana.push({
                                        materia: materia.nome,
                                        topicos: [...topicosParaHoje]
                                    });
                                }
                            }

                            html += `<li style="margin-bottom: 12px;">`;
                            html += `<strong style="color: var(--accent-primary);">${materia.nome}:</strong>`;
                            if (topicosParaHoje.length > 0) {
                                html += `<ul style="margin: 3px 0 0 20px; font-size: 14px; color: var(--text-secondary);">`;
                                topicosParaHoje.forEach(topico => {
                                    html += `<li>${topico}</li>`;
                                });
                                html += `</ul>`;
                            }
                            html += `</li>`;
                        }

                        html += `</ul></td>`;
                        html += `<td style="padding: 10px; text-align: center;">${horasDia}h</td>`;
                    }

                    html += `</tr>`;
                });

                html += `</tbody></table>`;
            }

            html += `<div style="background: var(--bg-elevated); padding: 15px; border-radius: 8px; margin-top: 15px;">`;
            html += `<p style="margin: 0;"><strong>üí° Dica:</strong> Este cronograma distribui os assuntos do edital ao longo das semanas. `;
            html += `Repita os ciclos at√© a prova, ajustando conforme sua evolu√ß√£o. Use a aba <strong>Estat√≠sticas</strong> para acompanhar seu progresso!</p>`;
            html += `</div>`;

            html += `</div>`;

            // √öLTIMA SEMANA - REVIS√ÉO INTENSIVA
            if (ultimaSemanaRevisao) {
                html += `<h4 style="color: var(--accent-warm); margin-top: 30px;">üî• √öLTIMA SEMANA - REVIS√ÉO INTENSIVA (7 dias antes da prova)</h4>`;
                html += `<div style="background: linear-gradient(135deg, var(--accent-warm), #e74c3c); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">`;
                html += `<p style="margin-bottom: 15px;"><strong>‚ö†Ô∏è ATEN√á√ÉO: √öltima semana √© SOMENTE revis√£o + simulados!</strong></p>`;
                html += `<table style="width: 100%; border-collapse: collapse; color: white;">`;
                html += `<thead><tr style="border-bottom: 2px solid rgba(255,255,255,0.3);">`;
                html += `<th style="padding: 10px; text-align: left;">Dia</th>`;
                html += `<th style="padding: 10px; text-align: left;">Atividade</th>`;
                html += `</tr></thead><tbody>`;

                const ultimaSemana = [
                    { dia: 'Segunda', ativ: 'üìö Revis√£o geral de todas as mat√©rias + Resolu√ß√£o de quest√µes' },
                    { dia: 'Ter√ßa', ativ: 'üìù SIMULADO COMPLETO (tempo real de prova)' },
                    { dia: 'Quarta', ativ: 'üîç Corre√ß√£o do simulado + Revisar erros + Estudar pontos fracos' },
                    { dia: 'Quinta', ativ: 'üìñ Revis√£o das mat√©rias de maior peso + Flashcards' },
                    { dia: 'Sexta', ativ: 'üéØ Revis√£o leve + Conferir documentos e local de prova' },
                    { dia: 'S√°bado', ativ: 'üòå DESCANSO! N√£o estude. Relaxe, durma cedo' },
                    { dia: 'Domingo', ativ: 'üéØ DIA DA PROVA! Caf√© da manh√£, chegue cedo, confie em si!' }
                ];

                ultimaSemana.forEach(item => {
                    html += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">`;
                    html += `<td style="padding: 10px;"><strong>${item.dia}</strong></td>`;
                    html += `<td style="padding: 10px;">${item.ativ}</td>`;
                    html += `</tr>`;
                });

                html += `</tbody></table>`;
                html += `<p style="margin-top: 15px; font-size: 14px;">üí° <strong>Importante:</strong> Na √∫ltima semana, N√ÉO estude conte√∫do novo! Apenas revise e descanse.</p>`;
                html += `</div>`;
            }

            // Tips by level
            html += `<h4>üí° Dicas Espec√≠ficas para N√≠vel ${nivel.charAt(0).toUpperCase() + nivel.slice(1)}</h4>`;
            html += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px;">`;
            html += `<ul>`;

            if (nivel === 'iniciante') {
                html += `<li>üìñ Comece pela teoria antes de fazer quest√µes</li>`;
                html += `<li>üéß Use o Leitor de Texto para refor√ßar conceitos</li>`;
                html += `<li>üé¥ Crie flashcards dos conceitos b√°sicos</li>`;
                html += `<li>‚è∞ Use Pomodoro de 25min para manter o foco</li>`;
            } else if (nivel === 'intermediario') {
                html += `<li>üìù Equilibre 50% teoria e 50% quest√µes</li>`;
                html += `<li>üìä Fa√ßa simulados semanalmente</li>`;
                html += `<li>üîç Identifique suas mat√©rias fracas e reforce</li>`;
                html += `<li>‚ö° Aumente gradualmente para Pomodoro de 50min</li>`;
            } else {
                html += `<li>üéØ Foco em quest√µes e simulados (70%)</li>`;
                html += `<li>üìà An√°lise estat√≠stica dos seus erros</li>`;
                html += `<li>üîÑ Revis√£o de jurisprud√™ncia recente</li>`;
                html += `<li>‚è±Ô∏è Treino de tempo: responda quest√µes cronometrando</li>`;
            }

            html += `</ul>`;
            html += `</div>`;

            // Final tips
            html += `<div style="margin-top: 20px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px; border-left: 4px solid var(--success);">`;
            html += `<h4 style="color: var(--success);">‚úÖ Lembre-se:</h4>`;
            html += `<ul>`;
            html += `<li>üîÑ <strong>Consist√™ncia > Intensidade:</strong> Melhor estudar ${horasDia}h todo dia do que 20h em um √∫nico dia</li>`;
            html += `<li>üí§ <strong>Descanso √© essencial:</strong> Durma bem para consolidar o aprendizado</li>`;
            html += `<li>üéØ <strong>Qualidade > Quantidade:</strong> Estudo focado vale mais que horas distra√≠das</li>`;
            html += `<li>üìä <strong>Acompanhe seu progresso:</strong> Use a aba Estat√≠sticas para monitorar sua evolu√ß√£o</li>`;
            html += `</ul>`;
            html += `</div>`;

            return html;
        }

        function renderSavedEditais() {
            const listEl = document.getElementById('savedEditalList');

            if (savedEditais.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>Nenhuma an√°lise salva ainda</p></div>';
                return;
            }

            listEl.innerHTML = savedEditais.slice().reverse().map((item, idx) => `
                <div class="saved-item">
                    <div class="saved-item-header">
                        <div>
                            <div class="saved-item-title">An√°lise #${savedEditais.length - idx}</div>
                            <div class="saved-item-date">${item.date}</div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteEdital(${savedEditais.length - 1 - idx})">üóëÔ∏è</button>
                    </div>
                    <div class="saved-item-content">
                        <strong>Consulta:</strong> ${item.input}<br><br>
                        <div class="ai-response">${item.response}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderSavedCronogramas() {
            const savedCronogramas = Storage.get('savedCronogramas', []);
            const listEl = document.getElementById('savedCronogramaList');

            if (savedCronogramas.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>Nenhum cronograma salvo ainda</p></div>';
                return;
            }

            listEl.innerHTML = savedCronogramas.slice().reverse().map((item, idx) => `
                <div class="saved-item">
                    <div class="saved-item-header">
                        <div>
                            <div class="saved-item-title">${item.concurso}</div>
                            <div class="saved-item-date">${item.date}</div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteCronograma(${savedCronogramas.length - 1 - idx})">üóëÔ∏è</button>
                    </div>
                    <div class="saved-item-content">
                        <div class="ai-response">${item.response}</div>
                    </div>
                </div>
            `).join('');
        }

        function deleteEdital(index) {
            showConfirmDialog('Tem certeza que deseja excluir esta an√°lise?', () => {
                savedEditais.splice(index, 1);
                Storage.set('savedEditais', savedEditais);
                renderSavedEditais();
                showNotification('üóëÔ∏è An√°lise exclu√≠da');
            });
        }

        function deleteCronograma(index) {
            showConfirmDialog('Tem certeza que deseja excluir este cronograma?', () => {
                const savedCronogramas = Storage.get('savedCronogramas', []);
                savedCronogramas.splice(index, 1);
                Storage.set('savedCronogramas', savedCronogramas);
                renderSavedCronogramas();
                showNotification('üóëÔ∏è Cronograma exclu√≠do');
            });
        }

        // PROCESSAR CONTE√öDO PROGRAM√ÅTICO (colado pelo usu√°rio)
        document.getElementById('processarConteudo').addEventListener('click', () => {
            const conteudoText = document.getElementById('conteudoProgramatico').value.trim();

            if (!conteudoText) {
                showNotification('‚ö†Ô∏è Cole o conte√∫do program√°tico primeiro!');
                return;
            }

            // RESET GLOBAL
            extractedEditalTopics = {};

            // STEP 1: Join continuation lines (ONLY lines with SUBJECT NAME: are new subjects)
            const rawLines = conteudoText.split('\n');
            const consolidatedLines = [];
            let currentLine = '';

            rawLines.forEach(line => {
                line = line.trim();
                if (!line) return;

                // Detect new subject:
                // 1. ALL CAPS without number: "L√çNGUA PORTUGUESA:"
                // 2. Number + ALL CAPS: "1. GERENCIAMENTO:" (but NOT "1. Compreens√£o de textos")
                const allCapsWithColon = /^[A-Z√Ä-√ö][A-Z√Ä-√ö\s]{2,}:/.test(line);
                const numberedAllCapsWithColon = /^\d+\.\s+[A-Z√Ä-√ö][A-Z√Ä-√ö\s]{2,}:/.test(line);
                const looksLikeSubject = allCapsWithColon || numberedAllCapsWithColon;

                if (looksLikeSubject && currentLine) {
                    // Save previous subject and start new one
                    consolidatedLines.push(currentLine);
                    currentLine = line;
                } else if (looksLikeSubject) {
                    // First subject
                    currentLine = line;
                } else {
                    // Continuation line (even if starts with numbers!) - append to current
                    if (currentLine) {
                        currentLine += ' ' + line;
                    } else {
                        // If no current line yet, this is the first line but doesn't look like subject
                        currentLine = line;
                    }
                }
            });

            // Don't forget the last one
            if (currentLine) {
                consolidatedLines.push(currentLine);
            }

            console.log(`üìù ${rawLines.length} linhas originais ‚Üí ${consolidatedLines.length} mat√©rias consolidadas`);
            console.log('Linhas consolidadas:', consolidatedLines);

            // STEP 2: Parse consolidated lines - SEPARAR POR N√öMERO!
            let processedCount = 0;

            consolidatedLines.forEach((line, idx) => {
                console.log(`\nüîç Processando linha ${idx + 1}:`, line.substring(0, 100) + '...');
                line = line.trim();
                if (!line) return;

                // Split by colon to separate materia from topics
                let materia, topicosStr;

                if (line.includes(':')) {
                    const parts = line.split(':');
                    materia = parts[0].trim();
                    topicosStr = parts.slice(1).join(':').trim();
                } else {
                    // No delimiter - whole line is the subject
                    materia = line;
                    topicosStr = '';
                }

                if (materia) {
                    // Clean subject name (remove leading numbers like "1. ")
                    materia = materia.replace(/^\d+\.\s*/, '');

                    // Parse topics - SEPARAR POR N√öMERO (1, 2, 3, 4.1, etc.)
                    let topicos = [];
                    if (topicosStr) {
                        // REGEX ATUALIZADO: Aceita "1 texto", "1. texto" ou "1.1 texto"
                        // Captura: 1, 2, 3, 4.1, 5.2, etc. (com ou sem ponto ap√≥s o n√∫mero)
                        const regex = /(\d+(?:\.\d+)?)[.\s]+([^0-9]+?)(?=\s+\d+(?:\.\d+)?[.\s]|$)/g;
                        let match;

                        while ((match = regex.exec(topicosStr)) !== null) {
                            const numero = match[1];
                            let texto = match[2].trim();

                            // Limpar pontua√ß√£o final se houver (mas manter pontos no meio do texto)
                            texto = texto.replace(/[.,;:]+$/, '').trim();

                            if (texto && texto.length > 2) {
                                // Incluir o n√∫mero no texto do t√≥pico
                                topicos.push(`${numero}. ${texto}`);
                            }
                        }

                        // Se n√£o achou t√≥picos numerados, tenta por v√≠rgula/ponto-e-v√≠rgula
                        if (topicos.length === 0) {
                            topicos = topicosStr.split(/[,;]/).map(t => t.trim()).filter(t => t && t.length > 2);
                        }
                    }

                    if (topicos.length > 0) {
                        extractedEditalTopics[materia] = topicos;
                        processedCount++;
                        console.log(`‚úÖ ${materia}: ${topicos.length} t√≥picos`);
                        console.log('T√≥picos:', topicos);
                    }
                }
            });

            if (processedCount > 0) {
                showNotification(`‚úÖ ${processedCount} mat√©rias processadas! Conte√∫do pronto para usar no cronograma, quest√µes e flashcards.`);

                // Show preview
                let preview = '<div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-top: 20px;">';
                preview += '<h3 style="color: var(--accent-primary); margin-bottom: 15px;">üìã Conte√∫do Program√°tico Processado</h3>';

                Object.keys(extractedEditalTopics).forEach((materia, idx) => {
                    const topicos = extractedEditalTopics[materia];
                    preview += `<div style="background: var(--bg-tertiary); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--accent-primary);">`;

                    if (topicos.length > 0) {
                        preview += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${materia}:</strong> `;
                        preview += topicos.join(', ');
                        preview += '.</p>';
                    } else {
                        preview += `<p style="line-height: 1.8; margin: 0;"><strong style="color: var(--accent-primary); font-size: 16px;">${idx + 1}. ${materia}</strong> `;
                        preview += '<span style="color: var(--text-secondary); font-style: italic;">(sem t√≥picos especificados)</span></p>';
                    }

                    preview += '</div>';
                });

                preview += '<div style="margin-top: 20px; padding: 15px; background: var(--bg-elevated); border-radius: 8px;">';
                preview += '<p style="margin: 0;"><strong>‚úÖ Pronto!</strong> Este conte√∫do ser√° usado automaticamente em:</p>';
                preview += '<ul style="margin: 10px 0 0 20px; line-height: 1.8;">';
                preview += '<li>üìÖ Cronograma C√≠clico (com t√≥picos espec√≠ficos por dia)</li>';
                preview += '<li>üìù Caderno de Quest√µes</li>';
                preview += '<li>üéØ Simulados</li>';
                preview += '<li>üÉè Flashcards</li>';
                preview += '</ul></div>';
                preview += '</div>';

                document.getElementById('editalOutput').innerHTML = preview;

                // Save to storage
                Storage.set('conteudoProgramatico', extractedEditalTopics);

                // Update Dashboard
                updateDashboard();
            } else {
                showNotification('‚ö†Ô∏è Nenhuma mat√©ria foi encontrada. Verifique o formato!');
            }
        });

        document.getElementById('analyzeEdital').addEventListener('click', analyzeEdital);
        document.getElementById('btnAnalisarEdital').addEventListener('click', analisarEditalInteligente);
        document.getElementById('btnGerarCalendario').addEventListener('click', gerarCalendarioMensal);

        // ==================== DRAG & DROP E UPLOAD DE PDF ====================

        const dropZone = document.getElementById('cronoPdfDropZone');
        const fileInput = document.getElementById('cronoPdfFileInput');
        const textArea = document.getElementById('cronoEditalBruto');

        // Prevenir comportamento padr√£o do navegador
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Efeito visual no drag
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--accent-primary)';
                dropZone.style.backgroundColor = 'var(--bg-elevated)';
                dropZone.style.transform = 'scale(1.02)';
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.style.borderColor = 'var(--border)';
                dropZone.style.backgroundColor = 'var(--bg-secondary)';
                dropZone.style.transform = 'scale(1)';
            });
        });

        // Drop do arquivo
        dropZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processarPDF(files[0]);
            }
        });

        // Sele√ß√£o via input
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                processarPDF(files[0]);
            }
        });

        // Processar PDF e extrair texto
        async function processarPDF(file) {
            if (!file.type.includes('pdf')) {
                showNotification('‚ö†Ô∏è Por favor, envie um arquivo PDF');
                return;
            }

            // Mostrar loading na drop zone
            dropZone.innerHTML = `
                <div class="loading-spinner"></div>
                <div style="margin-top: 15px; font-size: 14px; color: var(--text-secondary);">
                    Extraindo texto do PDF...<br>
                    <span style="font-size: 12px;">${file.name}</span>
                </div>
            `;

            try {
                // Ler arquivo como ArrayBuffer
                const arrayBuffer = await file.arrayBuffer();

                // Carregar PDF com PDF.js
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let textoCompleto = '';

                // Extrair texto de todas as p√°ginas
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();

                    // Melhor formata√ß√£o: considerar posi√ß√£o Y para quebras de linha
                    let lastY = null;
                    let pageText = '';

                    textContent.items.forEach(item => {
                        const currentY = item.transform[5];

                        // Se mudou de linha (Y diferente), adicionar quebra
                        if (lastY !== null && Math.abs(currentY - lastY) > 5) {
                            pageText += '\n';
                        }

                        pageText += item.str + ' ';
                        lastY = currentY;
                    });

                    textoCompleto += pageText + '\n\n';
                }

                // Limpar e normalizar o texto extra√≠do
                textoCompleto = limparTextoExtraido(textoCompleto);

                // Preencher textarea com o texto extra√≠do
                textArea.value = textoCompleto;

                // Restaurar dropzone
                restaurarDropZone();

                // Notificar sucesso
                showNotification(`‚úÖ PDF processado! ${pdf.numPages} p√°ginas extra√≠das.`);

                // Scroll suave at√© o textarea
                textArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

            } catch (err) {
                console.error('Erro ao processar PDF:', err);
                showNotification('‚ùå Erro ao processar PDF. Tente outro arquivo ou cole o texto manualmente.');
                restaurarDropZone();
            }
        }

        // Restaurar estado original da drop zone
        function restaurarDropZone() {
            dropZone.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
                <div style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Arraste o PDF do edital aqui
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">
                    ou clique para selecionar o arquivo
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                    Formatos aceitos: PDF
                </div>
            `;
        }

        // Limpar texto extra√≠do de PDF
        function limparTextoExtraido(texto) {
            // 1. Remover espa√ßos m√∫ltiplos (mais de 2 espa√ßos seguidos)
            texto = texto.replace(/ {3,}/g, ' ');

            // 2. Remover espa√ßos antes de pontua√ß√£o
            texto = texto.replace(/ ([,;:.!?)])/g, '$1');

            // 3. Normalizar quebras de linha m√∫ltiplas (m√°ximo 2)
            texto = texto.replace(/\n{3,}/g, '\n\n');

            // 4. Remover espa√ßos no in√≠cio/fim de linhas
            texto = texto.split('\n').map(linha => linha.trim()).join('\n');

            // 5. Remover linhas muito curtas (provavelmente lixo)
            texto = texto.split('\n').filter(linha => linha.length > 2 || linha === '').join('\n');

            return texto.trim();
        }

        // ==================== DASHBOARD ====================

        // Fun√ß√µes para Informa√ß√µes do Edital
        function toggleEditarInfoEdital() {
            const displayMode = document.getElementById('editalInfoDisplay');
            const editMode = document.getElementById('editalInfoEdit');
            const btnText = document.getElementById('editEditalInfo');

            if (editMode.style.display === 'none') {
                // Carregar valores atuais nos inputs
                const info = Storage.get('editalInfo', {});
                document.getElementById('inputCargo').value = info.cargo || '';
                document.getElementById('inputDataProva').value = info.dataProva || '';
                document.getElementById('inputVagas').value = info.vagas || '';
                document.getElementById('inputSalario').value = info.salario || '';
                document.getElementById('inputOrgao').value = info.orgao || '';
                document.getElementById('inputEscolaridade').value = info.escolaridade || '';

                displayMode.style.display = 'none';
                editMode.style.display = 'block';
                btnText.innerHTML = '‚ùå Cancelar';
            } else {
                displayMode.style.display = 'grid';
                editMode.style.display = 'none';
                btnText.innerHTML = '‚úèÔ∏è Editar';
            }
        }

        function salvarInfoEdital() {
            const info = {
                cargo: document.getElementById('inputCargo').value,
                dataProva: document.getElementById('inputDataProva').value,
                vagas: document.getElementById('inputVagas').value,
                salario: document.getElementById('inputSalario').value,
                orgao: document.getElementById('inputOrgao').value,
                escolaridade: document.getElementById('inputEscolaridade').value
            };

            Storage.set('editalInfo', info);
            loadEditalInfo();
            toggleEditarInfoEdital();
            updateDashboard(); // Atualizar countdown com nova data
            showNotification('‚úÖ Informa√ß√µes salvas com sucesso!');
        }

        function loadEditalInfo() {
            const info = Storage.get('editalInfo', {});

            document.getElementById('displayCargo').textContent = info.cargo || 'N√£o informado';
            document.getElementById('displayVagas').textContent = info.vagas || 'N√£o informado';
            document.getElementById('displaySalario').textContent = info.salario || 'N√£o informado';
            document.getElementById('displayOrgao').textContent = info.orgao || 'N√£o informado';
            document.getElementById('displayEscolaridade').textContent = info.escolaridade || 'N√£o informado';

            if (info.dataProva) {
                const [year, month, day] = info.dataProva.split('-');
                document.getElementById('displayDataProva').textContent = `${day}/${month}/${year}`;
            } else {
                document.getElementById('displayDataProva').textContent = 'N√£o informado';
            }
        }

        function updateDashboard() {
            // Get passadas from localStorage (novo sistema)
            const passadas = Storage.get('topicPassadas', {});

            // Calculate stats
            let totalMaterias = Object.keys(extractedEditalTopics).length;
            let totalTopicos = 0;
            let topicosComPassada = 0; // T√≥picos com pelo menos 1 passada = progresso real

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia];
                totalTopicos += topicos.length;

                // Count studied topics for this materia (pelo menos 1 passada)
                if (passadas[materia]) {
                    topicos.forEach(topico => {
                        const numPassadas = passadas[materia][topico] || 0;
                        if (numPassadas > 0) {
                            topicosComPassada++;
                        }
                    });
                }
            });

            // PROGRESSO = % de t√≥picos com pelo menos 1 passada
            const percentual = totalTopicos > 0 ? Math.round((topicosComPassada / totalTopicos) * 100) : 0;

            // Update stats cards
            document.getElementById('totalMaterias').textContent = totalMaterias;
            document.getElementById('totalTopicos').textContent = totalTopicos;
            document.getElementById('topicosEstudados').textContent = topicosComPassada;
            document.getElementById('percentualProgresso').textContent = percentual + '%';

            // Update trof√©u geral
            // Atualizar card de medalhas (somat√≥rio total e trof√©u geral)
            const medalhasAtuais = Storage.get('medalhasConquistadas', {});
            let totalOuro = 0, totalPrata = 0, totalBronze = 0, totalEstrela = 0;

            Object.values(medalhasAtuais).forEach(materiaMedalhas => {
                materiaMedalhas.forEach(m => {
                    if (m.nivel === 'ouro') totalOuro++;
                    if (m.nivel === 'prata') totalPrata++;
                    if (m.nivel === 'bronze') totalBronze++;
                    if (m.nivel === 'estrela') totalEstrela++;
                });
            });

            const trofeuCard = document.getElementById('trofeuGeral');
            const totalMedalhas = totalOuro + totalPrata + totalBronze + totalEstrela;

            if (totalMedalhas > 0) {
                // Determinar trof√©u geral baseado na predomin√¢ncia
                let trofeuGeral = 'üèÜ';
                let nivelTrofeu = 'Bronze';

                if (totalOuro >= totalPrata && totalOuro >= totalBronze && totalOuro >= totalEstrela && totalOuro > 0) {
                    trofeuGeral = 'üèÜ';
                    nivelTrofeu = 'Ouro';
                } else if (totalPrata >= totalBronze && totalPrata >= totalEstrela && totalPrata > 0) {
                    trofeuGeral = 'ü•à';
                    nivelTrofeu = 'Prata';
                } else if (totalBronze >= totalEstrela && totalBronze > 0) {
                    trofeuGeral = 'ü•â';
                    nivelTrofeu = 'Bronze';
                } else if (totalEstrela > 0) {
                    trofeuGeral = '‚≠ê';
                    nivelTrofeu = 'Estrela';
                }

                let medalhasHtml = `<div style="font-size: 48px; margin-bottom: 5px;">${trofeuGeral}</div>`;
                medalhasHtml += '<div style="display: flex; gap: 8px; justify-content: center; align-items: center; flex-wrap: wrap;">';
                if (totalOuro > 0) medalhasHtml += `<div style="font-size: 24px;">ü•á<span style="font-size: 14px; font-weight: 700; color: white; margin-left: 4px;">√ó${totalOuro}</span></div>`;
                if (totalPrata > 0) medalhasHtml += `<div style="font-size: 24px;">ü•à<span style="font-size: 14px; font-weight: 700; color: white; margin-left: 4px;">√ó${totalPrata}</span></div>`;
                if (totalBronze > 0) medalhasHtml += `<div style="font-size: 24px;">ü•â<span style="font-size: 14px; font-weight: 700; color: white; margin-left: 4px;">√ó${totalBronze}</span></div>`;
                if (totalEstrela > 0) medalhasHtml += `<div style="font-size: 24px;">‚≠ê<span style="font-size: 14px; font-weight: 700; color: white; margin-left: 4px;">√ó${totalEstrela}</span></div>`;
                medalhasHtml += '</div>';

                document.getElementById('trofeuGeralEmoji').innerHTML = medalhasHtml;
                document.getElementById('trofeuGeralNome').textContent = `Trof√©u ${nivelTrofeu}`;
                trofeuCard.style.display = 'block';
                trofeuCard.style.cursor = 'pointer';
                trofeuCard.onclick = () => mostrarHistoricoConquistas();
            } else {
                trofeuCard.style.display = 'none';
            }

            // Update countdown
            updateExamCountdown();

            // Update progress bars per materia
            renderMateriasProgress(passadas);

            // Update gr√°ficos visuais
            atualizarGraficoPizza();
            atualizarGraficoLinha();
        }

        function updateExamCountdown() {
            // PRIORIDADE 1: Data manual (definida pelo usu√°rio)
            const editalInfo = Storage.get('editalInfo', {});
            let examDate = null;

            if (editalInfo.dataProva) {
                const [year, month, day] = editalInfo.dataProva.split('-');
                examDate = new Date(year, month - 1, day);
            } else {
                // PRIORIDADE 2: Data extra√≠da da an√°lise do edital
                const savedEditais = Storage.get('savedEditais', []);
                savedEditais.forEach(edital => {
                    if (edital.response && edital.response.includes('Data da Prova:')) {
                        // Try to extract date from analysis
                        const match = edital.response.match(/Data da Prova:?\s*(\d{1,2}\/\d{1,2}\/\d{4})/);
                        if (match) {
                            const [day, month, year] = match[1].split('/');
                            const date = new Date(year, month - 1, day);
                            if (!examDate || date < examDate) {
                                examDate = date;
                            }
                        }
                    }
                });
            }

            if (examDate) {
                const today = new Date();
                const diffTime = examDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                document.getElementById('diasRestantes').textContent = diffDays + ' dias';

                // Calculate required pace
                const totalTopicos = document.getElementById('totalTopicos').textContent;
                const topicosEstudados = document.getElementById('topicosEstudados').textContent;
                const topicosRestantes = parseInt(totalTopicos) - parseInt(topicosEstudados);

                if (diffDays > 0 && topicosRestantes > 0) {
                    const topicosPorDia = Math.ceil(topicosRestantes / diffDays);
                    document.getElementById('ritmoEstudo').textContent =
                        `Voc√™ precisa estudar ${topicosPorDia} t√≥picos por dia para terminar a tempo!`;
                } else if (topicosRestantes === 0) {
                    document.getElementById('ritmoEstudo').textContent = 'üéâ Parab√©ns! Voc√™ j√° estudou todo o conte√∫do!';
                } else {
                    document.getElementById('ritmoEstudo').textContent = '‚ö†Ô∏è Data da prova j√° passou!';
                }
            } else {
                document.getElementById('diasRestantes').textContent = '--';
                document.getElementById('ritmoEstudo').textContent = 'Defina a data da prova em "An√°lise de Edital"';
            }
        }

        // Vari√°vel global para guardar quais mat√©rias est√£o expandidas
        let expandedMaterias = new Set();

        // Vari√°veis globais para os gr√°ficos
        let chartPizzaInstance = null;
        let chartLinhaInstance = null;

        // Fun√ß√£o para atualizar gr√°fico de pizza (distribui√ß√£o por disciplina)
        function atualizarGraficoPizza() {
            const passadas = Storage.get('topicPassadas', {});
            const materias = Object.keys(extractedEditalTopics);

            if (materias.length === 0) {
                // Se n√£o h√° mat√©rias, destruir gr√°fico se existir
                if (chartPizzaInstance) {
                    chartPizzaInstance.destroy();
                    chartPizzaInstance = null;
                }
                return;
            }

            // Calcular dados para cada mat√©ria
            const labels = [];
            const data = [];
            const backgroundColor = [
                '#FF6B6B', // Vermelho vibrante
                '#4ECDC4', // Turquesa
                '#FFD93D', // Amarelo brilhante
                '#95E1D3', // Verde √°gua
                '#FF6F91', // Rosa choque
                '#6BCF7F', // Verde lim√£o
                '#A8E6CF', // Verde menta
                '#FF8C42', // Laranja forte
                '#8E44AD', // Roxo vibrante
                '#3498DB', // Azul el√©trico
                '#E74C3C', // Vermelho coral
                '#F39C12', // Laranja dourado
                '#1ABC9C', // Verde turquesa
                '#9B59B6', // Roxo m√©dio
                '#E67E22'  // Laranja queimado
            ];

            materias.forEach(materia => {
                const topicos = extractedEditalTopics[materia] || [];
                labels.push(materia);
                data.push(topicos.length);
            });

            const ctx = document.getElementById('chartPizza');
            if (!ctx) return;

            // Destruir gr√°fico anterior se existir
            if (chartPizzaInstance) {
                chartPizzaInstance.destroy();
            }

            // Pegar cor do texto do tema atual
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
            const bgColor = getComputedStyle(document.body).getPropertyValue('--bg-primary').trim();

            // Criar novo gr√°fico
            chartPizzaInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: bgColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            align: 'start',
                            labels: {
                                color: textColor,
                                padding: 8,
                                boxWidth: 12,
                                font: {
                                    size: 10
                                },
                                textAlign: 'left',
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const textColor = getComputedStyle(document.body).getPropertyValue('--text-primary').trim();
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            return {
                                                text: `${label}: ${value} t√≥picos`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                fontColor: textColor,
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            },
                            maxWidth: 550,
                            maxHeight: 120
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label}: ${value} t√≥picos (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fun√ß√£o para atualizar gr√°fico de linha (evolu√ß√£o do progresso)
        function atualizarGraficoLinha() {
            // Primeiro, garantir que hoje est√° registrado
            registrarProgressoHoje();

            const historicoProgresso = Storage.get('historicoProgresso', []);

            // Preparar dados
            const labels = [];
            const data = [];

            if (historicoProgresso.length === 0) {
                // Se ainda n√£o h√° hist√≥rico, mostrar gr√°fico vazio
                const ctx = document.getElementById('chartLinha');
                if (chartLinhaInstance) {
                    chartLinhaInstance.destroy();
                }
                return;
            }

            // Ordenar por data
            historicoProgresso.sort((a, b) => new Date(a.data) - new Date(b.data));

            // Pegar √∫ltimos 30 dias
            const ultimos30 = historicoProgresso.slice(-30);

            ultimos30.forEach(registro => {
                const data_obj = new Date(registro.data);
                const dia = data_obj.getDate().toString().padStart(2, '0');
                const mes = (data_obj.getMonth() + 1).toString().padStart(2, '0');
                labels.push(`${dia}/${mes}`);
                data.push(registro.percentual);
            });

            const ctx = document.getElementById('chartLinha');
            if (!ctx) return;

            // Destruir gr√°fico anterior se existir
            if (chartLinhaInstance) {
                chartLinhaInstance.destroy();
            }

            // Pegar cores do tema atual
            const accentColor = getComputedStyle(document.body).getPropertyValue('--accent-primary').trim();
            const textSecondary = getComputedStyle(document.body).getPropertyValue('--text-secondary').trim();
            const borderColor = getComputedStyle(document.body).getPropertyValue('--border').trim();

            // Criar novo gr√°fico
            chartLinhaInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Progresso (%)',
                        data: data,
                        borderColor: accentColor,
                        backgroundColor: accentColor + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: accentColor,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: textSecondary,
                                callback: function(value) {
                                    return value + '%';
                                }
                            },
                            grid: {
                                color: borderColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textSecondary,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: borderColor
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Progresso: ${context.parsed.y}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Fun√ß√£o para registrar progresso do dia (chamada ao atualizar dashboard)
        function registrarProgressoHoje() {
            // S√≥ registra se houver conte√∫do program√°tico
            if (Object.keys(extractedEditalTopics).length === 0) {
                return;
            }

            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0); // Zerar horas para comparar apenas a data

            const historicoProgresso = Storage.get('historicoProgresso', []);

            // Calcular progresso atual
            const passadas = Storage.get('topicPassadas', {});
            let totalTopicos = 0;
            let topicosComPassada = 0;

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia] || [];
                totalTopicos += topicos.length;

                topicos.forEach(topico => {
                    const numPassadas = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                    if (numPassadas >= 1) {
                        topicosComPassada++;
                    }
                });
            });

            const percentual = totalTopicos > 0 ? Math.round((topicosComPassada / totalTopicos) * 100) : 0;

            // Verificar se j√° tem registro de hoje
            const indexHoje = historicoProgresso.findIndex(registro => {
                const dataRegistro = new Date(registro.data);
                dataRegistro.setHours(0, 0, 0, 0);
                return dataRegistro.getTime() === hoje.getTime();
            });

            if (indexHoje >= 0) {
                // Atualizar registro de hoje se o percentual mudou
                if (historicoProgresso[indexHoje].percentual !== percentual) {
                    historicoProgresso[indexHoje].percentual = percentual;
                    Storage.set('historicoProgresso', historicoProgresso);
                }
            } else {
                // Adicionar novo registro
                historicoProgresso.push({
                    data: hoje.toISOString(),
                    percentual: percentual
                });

                Storage.set('historicoProgresso', historicoProgresso);
            }
        }

        // Sistema de trof√©us/medalhas - MEDALHA POR PASSADA INDEPENDENTE
        // REGRA CORRETA: Cada passada (1¬™, 2¬™, 3¬™) ganha sua pr√≥pria medalha baseada no progresso:
        // - 0-19%: Sem medalha
        // - 20-29%: ‚≠ê Estrela
        // - 30-49%: ü•â Bronze
        // - 50-99%: ü•à Prata
        // - 100%: ü•á Ouro
        function getMedalhas(materia, passadas) {
            const topicos = extractedEditalTopics[materia] || [];
            const totalTopicos = topicos.length;

            if (totalTopicos === 0) return [];

            let medalhas = [];
            let passada1Count = 0, passada2Count = 0, passada3Count = 0;

            // Contar quantos t√≥picos t√™m cada passada
            topicos.forEach(topico => {
                const numPassadas = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                if (numPassadas >= 1) passada1Count++;
                if (numPassadas >= 2) passada2Count++;
                if (numPassadas >= 3) passada3Count++;
            });

            // Calcular percentuais
            const perc1 = (passada1Count / totalTopicos) * 100;
            const perc2 = (passada2Count / totalTopicos) * 100;
            const perc3 = (passada3Count / totalTopicos) * 100;

            // MEDALHA DA 1¬™ PASSADA
            if (perc1 === 100) {
                medalhas.push({ emoji: 'ü•á', nome: 'Ouro - 1¬™ Passada', tipo: '1¬™', nivel: 'ouro', progresso: 100 });
            } else if (perc1 >= 50) {
                medalhas.push({ emoji: 'ü•à', nome: 'Prata - 1¬™ Passada', tipo: '1¬™', nivel: 'prata', progresso: Math.round(perc1) });
            } else if (perc1 >= 30) {
                medalhas.push({ emoji: 'ü•â', nome: 'Bronze - 1¬™ Passada', tipo: '1¬™', nivel: 'bronze', progresso: Math.round(perc1) });
            } else if (perc1 >= 20) {
                medalhas.push({ emoji: '‚≠ê', nome: 'Estrela - 1¬™ Passada', tipo: '1¬™', nivel: 'estrela', progresso: Math.round(perc1) });
            }

            // MEDALHA DA 2¬™ PASSADA
            if (perc2 === 100) {
                medalhas.push({ emoji: 'ü•á', nome: 'Ouro - 2¬™ Passada', tipo: '2¬™', nivel: 'ouro', progresso: 100 });
            } else if (perc2 >= 50) {
                medalhas.push({ emoji: 'ü•à', nome: 'Prata - 2¬™ Passada', tipo: '2¬™', nivel: 'prata', progresso: Math.round(perc2) });
            } else if (perc2 >= 30) {
                medalhas.push({ emoji: 'ü•â', nome: 'Bronze - 2¬™ Passada', tipo: '2¬™', nivel: 'bronze', progresso: Math.round(perc2) });
            } else if (perc2 >= 20) {
                medalhas.push({ emoji: '‚≠ê', nome: 'Estrela - 2¬™ Passada', tipo: '2¬™', nivel: 'estrela', progresso: Math.round(perc2) });
            }

            // MEDALHA DA 3¬™ PASSADA
            if (perc3 === 100) {
                medalhas.push({ emoji: 'ü•á', nome: 'Ouro - 3¬™ Passada', tipo: '3¬™', nivel: 'ouro', progresso: 100 });
            } else if (perc3 >= 50) {
                medalhas.push({ emoji: 'ü•à', nome: 'Prata - 3¬™ Passada', tipo: '3¬™', nivel: 'prata', progresso: Math.round(perc3) });
            } else if (perc3 >= 30) {
                medalhas.push({ emoji: 'ü•â', nome: 'Bronze - 3¬™ Passada', tipo: '3¬™', nivel: 'bronze', progresso: Math.round(perc3) });
            } else if (perc3 >= 20) {
                medalhas.push({ emoji: '‚≠ê', nome: 'Estrela - 3¬™ Passada', tipo: '3¬™', nivel: 'estrela', progresso: Math.round(perc3) });
            }

            return medalhas;
        }

        // Verificar se ganhou nova medalha ou evoluiu (para mostrar popup)
        function verificarNovasMedalhas(materia) {
            const medalhasAtuais = Storage.get('medalhasConquistadas', {});
            const passadas = Storage.get('topicPassadas', {});

            if (!medalhasAtuais[materia]) {
                medalhasAtuais[materia] = [];
            }

            const medalhasNovas = getMedalhas(materia, passadas);
            const medalhasAntigas = medalhasAtuais[materia];

            // Verificar cada passada se h√° evolu√ß√£o
            medalhasNovas.forEach(nova => {
                const antigaDaMesmaPassada = medalhasAntigas.find(antiga => antiga.tipo === nova.tipo);

                if (!antigaDaMesmaPassada) {
                    // NOVA MEDALHA! (primeira vez nessa passada)
                    mostrarPopupConquista(materia, nova);
                    medalhasAntigas.push(nova);
                } else if (antigaDaMesmaPassada.emoji !== nova.emoji) {
                    // EVOLU√á√ÉO! Bronze‚ÜíPrata ou Prata‚ÜíOuro
                    mostrarPopupConquista(materia, nova);
                    // Atualizar a medalha existente
                    const index = medalhasAntigas.findIndex(m => m.tipo === nova.tipo);
                    medalhasAntigas[index] = nova;
                }
            });

            medalhasAtuais[materia] = medalhasAntigas;
            Storage.set('medalhasConquistadas', medalhasAtuais);

            // Verificar se ganhou CERTIFICADO DE BRAVURA (100% do programa completo)
            verificarCertificadoBravura();
        }

        // Verificar se ganhou o Certificado de Bravura e Conclus√£o
        // Ganha quando completar 100% do conte√∫do do edital (em qualquer passada)
        function verificarCertificadoBravura() {
            const passadas = Storage.get('topicPassadas', {});
            const certificados = Storage.get('certificadosConquistados', []);

            // Verificar se j√° tem o certificado
            if (certificados.includes('bravura')) {
                return; // J√° ganhou
            }

            // Verificar se completou 100% do programa
            let totalTopicos = 0;
            let topicosComPassada = 0;

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia] || [];
                totalTopicos += topicos.length;

                topicos.forEach(topico => {
                    const numPassadas = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                    if (numPassadas >= 1) {
                        topicosComPassada++;
                    }
                });
            });

            // Se completou 100% = CERTIFICADO!
            if (totalTopicos > 0 && topicosComPassada === totalTopicos) {
                certificados.push('bravura');
                Storage.set('certificadosConquistados', certificados);
                mostrarCertificadoBravura();
            }
        }

        // Mostrar certificado animado de bravura e conclus√£o
        function mostrarCertificadoBravura() {
            const certificado = document.createElement('div');
            certificado.id = 'certificadoBravura';
            certificado.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 100001;
                animation: fadeIn 0.5s;
            `;

            certificado.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
                    padding: 50px;
                    border-radius: 30px;
                    max-width: 600px;
                    width: 90%;
                    text-align: center;
                    box-shadow: 0 30px 80px rgba(255, 215, 0, 0.5);
                    border: 8px solid #B8860B;
                    position: relative;
                    animation: certificadoEntrada 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
                ">
                    <div style="position: absolute; top: -40px; left: 50%; transform: translateX(-50%); font-size: 100px; animation: trofeuRotate 3s ease-in-out infinite;">
                        üèÜ
                    </div>

                    <div style="margin-top: 80px;">
                        <h1 style="color: #8B4513; margin: 0 0 20px 0; font-size: 36px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); font-family: Georgia, serif;">
                            üéñÔ∏è CERTIFICADO DE BRAVURA üéñÔ∏è
                        </h1>
                        <div style="background: white; padding: 30px; border-radius: 15px; margin: 20px 0; box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);">
                            <p style="color: #333; font-size: 18px; line-height: 1.8; margin: 0; font-family: Georgia, serif;">
                                <strong>Parab√©ns!</strong><br>
                                Voc√™ completou <strong>100% do conte√∫do program√°tico</strong> do edital!<br><br>
                                Sua dedica√ß√£o e comprometimento com os estudos demonstram<br>
                                a bravura de um verdadeiro concurseiro! üí™
                            </p>
                        </div>
                        <div style="font-size: 60px; margin: 20px 0; animation: estrelas 2s ease-in-out infinite;">
                            ‚≠ê ‚≠ê ‚≠ê
                        </div>
                        <button onclick="document.getElementById('certificadoBravura').remove()" style="
                            padding: 15px 40px;
                            background: #8B4513;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            font-size: 18px;
                            font-weight: 700;
                            cursor: pointer;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                            transition: transform 0.2s;
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            üéâ CONTINUAR ESTUDANDO
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(certificado);

            // Adicionar anima√ß√µes CSS se n√£o existirem
            if (!document.getElementById('certificadoStyles')) {
                const style = document.createElement('style');
                style.id = 'certificadoStyles';
                style.textContent = `
                    @keyframes certificadoEntrada {
                        from { transform: scale(0) rotate(-180deg); opacity: 0; }
                        to { transform: scale(1) rotate(0deg); opacity: 1; }
                    }
                    @keyframes trofeuRotate {
                        0%, 100% { transform: translateX(-50%) rotate(-10deg) scale(1); }
                        50% { transform: translateX(-50%) rotate(10deg) scale(1.2); }
                    }
                    @keyframes estrelas {
                        0%, 100% { opacity: 1; transform: scale(1); }
                        50% { opacity: 0.5; transform: scale(1.1); }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // Popup animado estilo Candy Crush
        function mostrarPopupConquista(materia, medalha) {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) scale(0);
                background: linear-gradient(135deg, #FFD700, #FFA500);
                padding: 40px 60px;
                border-radius: 20px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.4);
                z-index: 100000;
                text-align: center;
                animation: popupBounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            `;

            popup.innerHTML = `
                <div style="font-size: 80px; margin-bottom: 15px; animation: medalhaRotate 1s ease-in-out infinite alternate;">${medalha.emoji}</div>
                <h2 style="color: white; margin: 0 0 10px 0; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">üéâ PARAB√âNS! üéâ</h2>
                <p style="color: white; margin: 0; font-size: 18px; font-weight: 600;">${medalha.nome}</p>
                <p style="color: rgba(255,255,255,0.9); margin: 10px 0 0 0; font-size: 14px;">${materia}</p>
            `;

            document.body.appendChild(popup);

            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                popup.style.animation = 'popupFadeOut 0.3s forwards';
                setTimeout(() => popup.remove(), 300);
            }, 3000);
        }

        function mostrarHistoricoConquistas() {
            const medalhasAtuais = Storage.get('medalhasConquistadas', {});

            let historicoHtml = '<div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">';

            if (Object.keys(medalhasAtuais).length === 0) {
                historicoHtml += '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">Nenhuma conquista ainda. Continue estudando! üí™</p>';
            } else {
                Object.keys(medalhasAtuais).sort().forEach(materia => {
                    const medalhas = medalhasAtuais[materia];
                    if (medalhas.length > 0) {
                        historicoHtml += `
                            <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--accent-primary);">
                                <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 10px; font-size: 16px;">${materia}</div>
                                <div style="display: flex; flex-wrap: wrap; gap: 12px;">
                        `;
                        medalhas.forEach(m => {
                            historicoHtml += `
                                <div style="display: flex; align-items: center; gap: 10px; background: var(--bg-secondary); padding: 10px 14px; border-radius: 8px; border: 2px solid var(--border);">
                                    <span style="font-size: 28px;">${m.emoji}</span>
                                    <div>
                                        <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">${m.nome}</div>
                                        ${m.progresso ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${m.progresso}% completo</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        historicoHtml += '</div></div>';
                    }
                });
            }

            historicoHtml += '</div>';

            showCustomDialog('üèÜ Hist√≥rico de Conquistas', historicoHtml);
        }

        function mostrarDetalhesMateria() {
            const materias = Object.keys(extractedEditalTopics);
            const passadas = Storage.get('topicPassadas', {});

            let html = '<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">';
            html += `<p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Total de ${materias.length} mat√©ria${materias.length !== 1 ? 's' : ''} no edital</p>`;

            if (materias.length === 0) {
                html += '<p style="text-align: center; padding: 40px; color: var(--text-secondary);">Nenhuma mat√©ria cadastrada ainda.</p>';
            } else {
                materias.sort().forEach(materia => {
                    const topicos = extractedEditalTopics[materia] || [];
                    const medalhas = getMedalhas(materia, passadas);

                    html += `
                        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid #FFE66D;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                <div style="font-weight: 700; color: var(--text-primary); font-size: 16px;">${materia}</div>
                                ${medalhas.length > 0 ? `<div style="display: flex; gap: 4px;">${medalhas.map(m => `<span style="font-size: 24px;">${m.emoji}</span>`).join('')}</div>` : ''}
                            </div>
                            <div style="color: var(--text-secondary); font-size: 14px;">${topicos.length} t√≥pico${topicos.length !== 1 ? 's' : ''}</div>
                        </div>
                    `;
                });
            }

            html += '</div>';
            showCustomDialog('üìö Detalhes das Mat√©rias', html);
        }

        function mostrarDetalhesTopicos() {
            const passadas = Storage.get('topicPassadas', {});
            let totalTopicos = 0;
            let topicosPorMateria = {};

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia] || [];
                totalTopicos += topicos.length;
                topicosPorMateria[materia] = topicos.length;
            });

            let html = '<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">';
            html += `<p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Total de ${totalTopicos} t√≥pico${totalTopicos !== 1 ? 's' : ''} no edital</p>`;

            // Gr√°fico de barras simples
            const materias = Object.keys(topicosPorMateria).sort((a, b) => topicosPorMateria[b] - topicosPorMateria[a]);
            const maxTopicos = Math.max(...Object.values(topicosPorMateria), 1);

            materias.forEach(materia => {
                const count = topicosPorMateria[materia];
                const percentage = (count / maxTopicos) * 100;

                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 13px; color: var(--text-primary); font-weight: 600;">${materia}</span>
                            <span style="font-size: 13px; color: var(--text-secondary); font-weight: 700;">${count}</span>
                        </div>
                        <div style="background: var(--bg-tertiary); height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #A8E6CF, #8FD9B6); height: 100%; width: ${percentage}%; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            showCustomDialog('üìã Distribui√ß√£o de T√≥picos', html);
        }

        function mostrarDetalhesEstudados() {
            const passadas = Storage.get('topicPassadas', {});
            let estudadosPorMateria = {};
            let totalEstudados = 0;

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia] || [];
                let estudados = 0;

                topicos.forEach(topico => {
                    const numPassadas = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                    if (numPassadas >= 1) {
                        estudados++;
                        totalEstudados++;
                    }
                });

                estudadosPorMateria[materia] = { estudados, total: topicos.length };
            });

            let html = '<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">';
            html += `<p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Total de ${totalEstudados} t√≥pico${totalEstudados !== 1 ? 's' : ''} estudado${totalEstudados !== 1 ? 's' : ''}</p>`;

            // Gr√°fico de barras por mat√©ria
            const materias = Object.keys(estudadosPorMateria).sort((a, b) => {
                const percA = (estudadosPorMateria[a].estudados / estudadosPorMateria[a].total) * 100;
                const percB = (estudadosPorMateria[b].estudados / estudadosPorMateria[b].total) * 100;
                return percB - percA;
            });

            materias.forEach(materia => {
                const { estudados, total } = estudadosPorMateria[materia];
                const percentage = total > 0 ? (estudados / total) * 100 : 0;

                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 13px; color: var(--text-primary); font-weight: 600;">${materia}</span>
                            <span style="font-size: 13px; color: var(--text-secondary); font-weight: 700;">${estudados}/${total} (${Math.round(percentage)}%)</span>
                        </div>
                        <div style="background: var(--bg-tertiary); height: 24px; border-radius: 12px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, #FFB6D9, #FF9DC6); height: 100%; width: ${percentage}%; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; transition: width 0.3s;"></div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            showCustomDialog('‚úÖ T√≥picos Estudados por Mat√©ria', html);
        }

        function mostrarDetalhesProgresso() {
            const passadas = Storage.get('topicPassadas', {});
            let progressoPorMateria = {};

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia] || [];
                let passada1 = 0, passada2 = 0, passada3 = 0;

                topicos.forEach(topico => {
                    const numPassadas = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                    if (numPassadas >= 1) passada1++;
                    if (numPassadas >= 2) passada2++;
                    if (numPassadas >= 3) passada3++;
                });

                progressoPorMateria[materia] = { passada1, passada2, passada3, total: topicos.length };
            });

            let html = '<div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">';
            html += `<p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Progresso detalhado por passada</p>`;

            const materias = Object.keys(progressoPorMateria).sort();

            materias.forEach(materia => {
                const { passada1, passada2, passada3, total } = progressoPorMateria[materia];
                const perc1 = total > 0 ? (passada1 / total) * 100 : 0;
                const perc2 = total > 0 ? (passada2 / total) * 100 : 0;
                const perc3 = total > 0 ? (passada3 / total) * 100 : 0;

                html += `
                    <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 10px; font-size: 15px;">${materia}</div>

                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">üìñ 1¬™ Passada</span>
                                <span style="font-size: 12px; color: var(--text-secondary); font-weight: 700;">${passada1}/${total} (${Math.round(perc1)}%)</span>
                            </div>
                            <div style="background: rgba(102, 126, 234, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #667eea; height: 100%; width: ${perc1}%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">üîÑ 2¬™ Passada</span>
                                <span style="font-size: 12px; color: var(--text-secondary); font-weight: 700;">${passada2}/${total} (${Math.round(perc2)}%)</span>
                            </div>
                            <div style="background: rgba(255, 165, 0, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #FFA500; height: 100%; width: ${perc2}%; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span style="font-size: 12px; color: var(--text-secondary);">‚úÖ 3¬™ Passada</span>
                                <span style="font-size: 12px; color: var(--text-secondary); font-weight: 700;">${passada3}/${total} (${Math.round(perc3)}%)</span>
                            </div>
                            <div style="background: rgba(76, 175, 80, 0.2); height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #4CAF50; height: 100%; width: ${perc3}%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            showCustomDialog('üéØ An√°lise de Progresso Detalhado', html);
        }

        function renderMateriasProgress(passadas) {
            const container = document.getElementById('materiasProgressList');

            if (Object.keys(extractedEditalTopics).length === 0) {
                container.innerHTML = `
                    <p style="color: var(--text-secondary); text-align: center; padding: 40px;">
                        Nenhum conte√∫do program√°tico processado ainda.<br>
                        <a href="#" onclick="switchTab('edital'); return false;" style="color: var(--accent-primary); text-decoration: underline;">V√° para "An√°lise de Edital"</a> e processe o conte√∫do program√°tico.
                    </p>
                `;
                return;
            }

            let html = '';

            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia];
                const totalTopicos = topicos.length;
                const materiaId = materia.replace(/\s/g, '_');

                // Calcular progresso baseado nas passadas
                let pontuacaoMaxima = totalTopicos * 3; // 3 passadas por t√≥pico
                let pontuacaoAtual = 0;
                let topicosComPassada = 0;
                let passada1 = 0, passada2 = 0, passada3 = 0;

                if (passadas[materia]) {
                    topicos.forEach(topico => {
                        const numPassadas = passadas[materia][topico] || 0;
                        pontuacaoAtual += numPassadas;
                        if (numPassadas > 0) topicosComPassada++;
                        if (numPassadas >= 1) passada1++;
                        if (numPassadas >= 2) passada2++;
                        if (numPassadas >= 3) passada3++;
                    });
                }

                // L√ìGICA CORRETA: Progresso = % de t√≥picos com PELO MENOS 1 passada
                // Se estudou 100% do conte√∫do em 1 passada = 100% do edital coberto!
                // 2¬™ e 3¬™ passadas s√£o REVIS√ïES, n√£o afetam o progresso principal
                const percentual = totalTopicos > 0 ? Math.round((topicosComPassada / totalTopicos) * 100) : 0;

                // Sistema de medalhas - M√öLTIPLAS MEDALHAS
                const medalhas = getMedalhas(materia, passadas);

                // Verificar se esta mat√©ria est√° expandida
                const isExpanded = expandedMaterias.has(materiaId);
                const displayStyle = isExpanded ? 'block' : 'none';
                const arrowRotation = isExpanded ? 'rotate(90deg)' : 'rotate(0deg)';

                html += `
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--accent-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px; flex: 1; cursor: pointer;" onclick="toggleMateriaTopics('${materiaId}')">
                                <span id="arrow_${materiaId}" style="display: inline-block; transition: transform 0.3s; transform: ${arrowRotation};">‚ñ∂</span>
                                <h4 style="margin: 0; color: var(--text-primary); font-size: 18px;">${materia}</h4>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                ${medalhas.length > 0 ? `<div style="display: flex; gap: 4px;">${medalhas.map(m => `<span style="font-size: 32px;" title="${m.nome}">${m.emoji}</span>`).join('')}</div>` : ''}
                                <span style="font-size: 16px; font-weight: 700; color: var(--accent-primary);">${percentual}%</span>
                                <button onclick="deleteMateria('${materia}')"
                                        title="Excluir esta mat√©ria"
                                        style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>

                        <div style="background: var(--bg-secondary); height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 10px;">
                            <div style="background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary)); height: 100%; width: ${percentual}%; transition: width 0.5s ease;"></div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                            <span>üìã ${totalTopicos} t√≥picos</span>
                            <span>‚úÖ ${topicosComPassada} iniciados</span>
                            <span style="color: #ffc107;">üìñ ${passada1} (1¬™)</span>
                            <span style="color: #2196F3;">üîÑ ${passada2} (2¬™)</span>
                            <span style="color: #4CAF50;">‚úì ${passada3} (3¬™)</span>
                            <span>‚è≥ ${totalTopicos - topicosComPassada} n√£o iniciados</span>
                        </div>

                        <!-- Lista de T√≥picos (Expand√≠vel) -->
                        <div id="topics_${materiaId}" style="display: ${displayStyle}; margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--border);">
                `;

                // Renderizar t√≥picos inline
                topicos.forEach((topico, idx) => {
                    const currentPassada = passadas[materia] ? (passadas[materia][topico] || 0) : 0;
                    const p1Checked = currentPassada >= 1;
                    const p2Checked = currentPassada >= 2;
                    const p3Checked = currentPassada >= 3;

                    html += `
                        <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border);">
                            <span style="flex: 1; color: var(--text-primary); font-size: 14px; line-height: 1.5;">
                                ${topico}
                            </span>
                            <div style="display: flex; gap: 15px; align-items: center; flex-shrink: 0;">
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" ${p1Checked ? 'checked' : ''}
                                           onchange="togglePassadaInline('${materia}', '${topico.replace(/'/g, "\\'")}', 1, this.checked)"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #ffc107;">
                                    <span style="color: #ffc107; font-weight: 600; font-size: 13px;">1¬™</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" ${p2Checked ? 'checked' : ''}
                                           onchange="togglePassadaInline('${materia}', '${topico.replace(/'/g, "\\'")}', 2, this.checked)"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #2196F3;">
                                    <span style="color: #2196F3; font-weight: 600; font-size: 13px;">2¬™</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                    <input type="checkbox" ${p3Checked ? 'checked' : ''}
                                           onchange="togglePassadaInline('${materia}', '${topico.replace(/'/g, "\\'")}', 3, this.checked)"
                                           style="width: 18px; height: 18px; cursor: pointer; accent-color: #4CAF50;">
                                    <span style="color: #4CAF50; font-weight: 600; font-size: 13px;">3¬™</span>
                                </label>
                                <button onclick="deleteTopico('${materia}', '${topico.replace(/'/g, "\\'")}')"
                                        title="Excluir este t√≥pico"
                                        style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 8px;">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleMateriaTopics(materiaId) {
            // Adicionar ou remover do Set de mat√©rias expandidas
            if (expandedMaterias.has(materiaId)) {
                expandedMaterias.delete(materiaId);
            } else {
                expandedMaterias.add(materiaId);
            }

            // Atualizar visualmente sem reconstruir tudo
            const topicsDiv = document.getElementById(`topics_${materiaId}`);
            const arrow = document.getElementById(`arrow_${materiaId}`);

            if (expandedMaterias.has(materiaId)) {
                topicsDiv.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                topicsDiv.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        function togglePassadaInline(materia, topico, passada, isChecked) {
            const passadas = Storage.get('topicPassadas', {});

            if (!passadas[materia]) {
                passadas[materia] = {};
            }

            if (isChecked) {
                // Marcar esta passada
                passadas[materia][topico] = passada;
                const emoji = passada === 1 ? 'üìñ' : passada === 2 ? 'üîÑ' : '‚úÖ';
                showNotification(`${emoji} ${passada}¬™ passada marcada!`);
            } else {
                // Desmarcar esta passada
                if (passada === 1) {
                    delete passadas[materia][topico];
                } else {
                    passadas[materia][topico] = passada - 1;
                }
                showNotification(`‚Ü©Ô∏è ${passada}¬™ passada desmarcada!`);
            }

            Storage.set('topicPassadas', passadas);
            verificarNovasMedalhas(materia); // Verifica se ganhou nova medalha
            updateDashboard();
        }

        function deleteTopico(materia, topico) {
            showConfirmDialog(`Tem certeza que deseja excluir o t√≥pico:<br><br>"<strong>${topico}</strong>"<br><br>da mat√©ria "${materia}"?`, () => {
                // Remover t√≥pico do array
                if (extractedEditalTopics[materia]) {
                    extractedEditalTopics[materia] = extractedEditalTopics[materia].filter(t => t !== topico);

                    // Se a mat√©ria ficou sem t√≥picos, remove ela tamb√©m
                    if (extractedEditalTopics[materia].length === 0) {
                        delete extractedEditalTopics[materia];
                        const materiaId = materia.replace(/\s/g, '_');
                        expandedMaterias.delete(materiaId);
                        showNotification(`üóëÔ∏è T√≥pico exclu√≠do! A mat√©ria "${materia}" foi removida pois ficou sem t√≥picos.`);
                    } else {
                        showNotification(`üóëÔ∏è T√≥pico exclu√≠do com sucesso!`);
                    }

                    Storage.set('conteudoProgramatico', extractedEditalTopics);
                }

                // Remover progresso de passadas deste t√≥pico
                const passadas = Storage.get('topicPassadas', {});
                if (passadas[materia]) {
                    delete passadas[materia][topico];
                    Storage.set('topicPassadas', passadas);
                }

                updateDashboard();
            });
        }

        function deleteMateria(materia) {
            showConfirmDialog(`Tem certeza que deseja excluir a mat√©ria "${materia}"?<br><br>‚ö†Ô∏è Isso tamb√©m excluir√° todo o progresso de passadas desta mat√©ria.`, () => {
                // Remover do conte√∫do program√°tico
                delete extractedEditalTopics[materia];
                Storage.set('conteudoProgramatico', extractedEditalTopics);

                // Remover progresso de passadas
                const passadas = Storage.get('topicPassadas', {});
                delete passadas[materia];
                Storage.set('topicPassadas', passadas);

                // Remover do set de mat√©rias expandidas
                const materiaId = materia.replace(/\s/g, '_');
                expandedMaterias.delete(materiaId);

                showNotification(`üóëÔ∏è Mat√©ria "${materia}" exclu√≠da com sucesso!`);
                updateDashboard();
            });
        }

        function carregarConteudoParaEdicao() {
            if (Object.keys(extractedEditalTopics).length === 0) {
                showNotification('‚ö†Ô∏è N√£o h√° conte√∫do salvo para editar!');
                return;
            }

            // Converter o objeto de volta para o formato de texto
            let conteudoTexto = '';
            Object.keys(extractedEditalTopics).forEach(materia => {
                const topicos = extractedEditalTopics[materia];
                conteudoTexto += `${materia}: ${topicos.join(', ')}\n`;
            });

            // Colocar no textarea
            document.getElementById('conteudoProgramatico').value = conteudoTexto.trim();

            showNotification('‚úèÔ∏è Conte√∫do carregado! Edite e clique em "Processar" novamente.');

            // Scroll para o textarea
            document.getElementById('conteudoProgramatico').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function limparConteudoProgramatico() {
            showConfirmDialog('‚ö†Ô∏è <strong>ATEN√á√ÉO!</strong><br><br>Isso ir√° excluir TODAS as mat√©rias e TODO o progresso de passadas.<br><br>Tem certeza que deseja continuar?', () => {
                // Limpar tudo
                extractedEditalTopics = {};
                Storage.set('conteudoProgramatico', {});
                Storage.set('topicPassadas', {});
                expandedMaterias.clear();

                // Limpar textarea
                document.getElementById('conteudoProgramatico').value = '';
                document.getElementById('editalOutput').innerHTML = '';

                showNotification('üóëÔ∏è Todo o conte√∫do program√°tico foi exclu√≠do!');
                updateDashboard();
            });
        }

        function switchTab(tabName) {
            // Remove active from all tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active to selected tab
            const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }

            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Se mudou para aba de estat√≠sticas, atualizar hist√≥rico de medalhas
            if (tabName === 'estatisticas') {
                atualizarHistoricoMedalhasEstatisticas();
            }

            // Se mudou para aba de configura√ß√µes, atualizar status do Gemini
            if (tabName === 'config') {
                atualizarStatusGemini();
            }
        }

        function atualizarHistoricoMedalhasEstatisticas() {
            const medalhasAtuais = Storage.get('medalhasConquistadas', {});
            const section = document.getElementById('medalhasHistoricoSection');
            const content = document.getElementById('medalhasHistoricoContent');

            if (Object.keys(medalhasAtuais).length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            let html = '';
            Object.keys(medalhasAtuais).sort().forEach(materia => {
                const medalhas = medalhasAtuais[materia];
                if (medalhas.length > 0) {
                    html += `
                        <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--accent-primary);">
                            <div style="font-weight: 700; color: var(--text-primary); margin-bottom: 15px; font-size: 18px;">${materia}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    `;
                    medalhas.forEach(m => {
                        html += `
                            <div style="display: flex; align-items: center; gap: 10px; background: var(--bg-secondary); padding: 12px 16px; border-radius: 10px; border: 2px solid var(--border);">
                                <span style="font-size: 32px;">${m.emoji}</span>
                                <div>
                                    <div style="font-size: 13px; color: var(--text-primary); font-weight: 600;">${m.nome}</div>
                                    ${m.progresso ? `<div style="font-size: 11px; color: var(--text-secondary); margin-top: 2px;">${m.progresso}% completo</div>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div></div>';
                }
            });

            content.innerHTML = html;
        }

        // ==================== END DASHBOARD ====================

        // Load saved conteudo programatico on page load
        const savedConteudo = Storage.get('conteudoProgramatico', null);
        if (savedConteudo) {
            extractedEditalTopics = savedConteudo;
            console.log('‚úÖ Conte√∫do program√°tico carregado:', Object.keys(extractedEditalTopics).length, 'mat√©rias');
        }

        // ==================== INICIALIZA√á√ÉO DA APLICA√á√ÉO ====================
        function inicializarApp() {
            // 1. Carregar dados persistidos
            const dadosCarregados = AppData.carregar();

            if (dadosCarregados) {
                console.log('‚úÖ Dados carregados do localStorage');

                // Se tem edital analisado, restaurar na interface
                if (AppData.edital.disciplinas && AppData.edital.disciplinas.length > 0) {
                    console.log(`üìö Edital restaurado: ${AppData.edital.disciplinas.length} disciplinas`);
                    // Atualizar extractedEditalTopics para compatibilidade
                    extractedEditalTopics = {};
                    AppData.edital.disciplinas.forEach(disc => {
                        extractedEditalTopics[disc.nome] = disc.topicos || [];
                    });
                }
            }

            // 2. Renderizar listas salvas
            renderSavedEditais();
            renderSavedCronogramas();

            // 3. Carregar informa√ß√µes do edital
            loadEditalInfo();

            // 4. Atualizar dashboard
            updateDashboard();

            console.log('üöÄ App inicializado');
        }

        // Executar ao carregar p√°gina
        inicializarApp();

        // PWA - Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('‚ùå Falha ao registrar Service Worker:', error);
                    });
            });
        }

        // PWA - Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Mostrar notifica√ß√£o para instalar
            setTimeout(() => {
                const installMsg = document.createElement('div');
                installMsg.className = 'result-message result-info';
                installMsg.innerHTML = `
                    üì≤ Instale o VINE CONCURSOS IA na tela inicial do seu celular!
                    <button class="btn" onclick="installApp()" style="margin-top: 10px;">Instalar Agora</button>
                `;
                installMsg.style.position = 'fixed';
                installMsg.style.bottom = '20px';
                installMsg.style.left = '20px';
                installMsg.style.right = '20px';
                installMsg.style.zIndex = '2000';
                installMsg.id = 'installPrompt';
                document.body.appendChild(installMsg);
            }, 3000);
        });

        window.installApp = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;

                const prompt = document.getElementById('installPrompt');
                if (prompt) prompt.remove();
            }
        };

        // Detectar se est√° rodando como PWA instalado
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('üöÄ App rodando como PWA instalado!');
        }

        // Update system status indicators
        function updateSystemStatus() {
            // PWA Status
            const pwaInstalled = window.matchMedia('(display-mode: standalone)').matches;
            document.getElementById('pwaStatus').textContent = pwaInstalled ? '‚úÖ Instalado' : '‚ö†Ô∏è Web';

            // Storage Status
            document.getElementById('storageStatus').textContent = useLocalStorage ? '‚úÖ Ativo' : '‚ö†Ô∏è Mem√≥ria';

            // Service Worker Status
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then(registration => {
                    document.getElementById('swStatus').textContent = registration ? '‚úÖ Ativo' : '‚ö†Ô∏è Inativo';
                });
            } else {
                document.getElementById('swStatus').textContent = '‚ùå N√£o suportado';
            }

            // Poe API Status
            document.getElementById('poeStatus').textContent = window.Poe ? '‚úÖ Dispon√≠vel' : '‚ö†Ô∏è Indispon√≠vel';
        }

        // Update status when tab changes
        document.querySelectorAll('.tab-btn').forEach(btn => {
            const originalClick = btn.onclick;
            btn.addEventListener('click', () => {
                if (btn.dataset.tab === 'ajuda') {
                    setTimeout(updateSystemStatus, 100);
                }
            });
        });

        // Initial status update
        updateSystemStatus();
    </script>
</body>
</html>